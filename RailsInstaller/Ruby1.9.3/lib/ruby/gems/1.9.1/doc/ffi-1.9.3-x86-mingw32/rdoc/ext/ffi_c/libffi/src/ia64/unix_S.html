<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>unix.S - ffi-1.9.3-x86-mingw32 Documentation</title>

<link href="../../../../../fonts.css" rel="stylesheet">
<link href="../../../../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../../../";
</script>

<script src="../../../../../js/jquery.js"></script>
<script src="../../../../../js/navigation.js"></script>
<script src="../../../../../js/search_index.js"></script>
<script src="../../../../../js/search.js"></script>
<script src="../../../../../js/searcher.js"></script>
<script src="../../../../../js/darkfish.js"></script>


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog.html">ChangeLog</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog_libffi.html">ChangeLog.libffi</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog_libgcj.html">ChangeLog.libgcj</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog_v1.html">ChangeLog.v1</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_vc.html">Makefile.vc</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_vc64.html">Makefile.vc64</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/README.html">README</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/acinclude_m4.html">acinclude.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/build-ios_sh.html">build-ios.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/compile.html">compile</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/config_guess.html">config.guess</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/config_sub.html">config.sub</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/configure.html">configure</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/configure_ac.html">configure.ac</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/configure_host.html">configure.host</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/depcomp.html">depcomp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/doc/libffi_info.html">libffi.info</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/doc/stamp-vti.html">stamp-vti</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/doc/version_texi.html">version.texi</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/fficonfig_h_in.html">fficonfig.h.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/include/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/include/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/install-sh.html">install-sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/libffi_pc_in.html">libffi.pc.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/libtool-version.html">libtool-version</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ltmain_sh.html">ltmain.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_cc_maxopt_m4.html">ax_cc_maxopt.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_cflags_warn_all_m4.html">ax_cflags_warn_all.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_check_compiler_flags_m4.html">ax_check_compiler_flags.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_compiler_vendor_m4.html">ax_compiler_vendor.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_configure_args_m4.html">ax_configure_args.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_enable_builddir_m4.html">ax_enable_builddir.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_gcc_archflag_m4.html">ax_gcc_archflag.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_gcc_x86_cpuid_m4.html">ax_gcc_x86_cpuid.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/ffi_3.html">ffi.3</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/ffi_call_3.html">ffi_call.3</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/ffi_prep_cif_3.html">ffi_prep_cif.3</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/mdate-sh.html">mdate-sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/missing.html">missing</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/msvcc_sh.html">msvcc.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/alpha/osf_S.html">osf.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/arm/gentramp_sh.html">gentramp.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/arm/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/arm/trampoline_S.html">trampoline.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/avr32/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/cris/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/frv/eabi_S.html">eabi.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/ia64/unix_S.html">unix.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/m32r/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/m68k/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/mips/n32_S.html">n32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/mips/o32_S.html">o32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/moxie/eabi_S.html">eabi.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/pa/hpux32_S.html">hpux32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/pa/linux_S.html">linux.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/aix_S.html">aix.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/aix_closure_S.html">aix_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/darwin_S.html">darwin.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/darwin_closure_S.html">darwin_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/linux64_S.html">linux64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/linux64_closure_S.html">linux64_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/ppc_closure_S.html">ppc_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/s390/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sh/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sh64/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sparc/v8_S.html">v8.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sparc/v9_S.html">v9.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/darwin_S.html">darwin.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/darwin64_S.html">darwin64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/freebsd_S.html">freebsd.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/unix64_S.html">unix64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/win32_S.html">win32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/win64_S.html">win64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/config/default_exp.html">default.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/libffi-dg_exp.html">libffi-dg.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/libffi_exp.html">libffi.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/target-libpath_exp.html">target-libpath.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/wrapper_exp.html">wrapper.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/libffi_call/call_exp.html">call.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/libffi_special/special_exp.html">special.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/texinfo_tex.html">texinfo.tex</a>
  
    <li><a href="../../../../../lib/ffi/platform/arm-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-cygwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-freebsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-gnu/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-netbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-openbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-windows/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/ia64-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/mips-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/mipsel-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/powerpc-aix/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/powerpc-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/powerpc-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/s390-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/s390x-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/sparc-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/sparc-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/sparcv9-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-cygwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-freebsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-netbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-openbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-windows/types_conf.html">types.conf</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page ext/ffi_c/libffi/src/ia64/unix.S">

<pre>-----------------------------------------------------------------------
unix.S - Copyright (c) 1998, 2008 Red Hat, Inc.
         Copyright (c) 2000 Hewlett Packard Company

IA64/unix Foreign Function Interface 

Primary author: Hans Boehm, HP Labs

Loosely modeled on Cygnus code for other platforms.

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
``Software''), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED ``AS IS'', WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT.  IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
DEALINGS IN THE SOFTWARE.
-----------------------------------------------------------------------</pre>

<p>define LIBFFI_ASM</p>

<p>include &lt;fficonfig.h&gt; include &lt;ffi.h&gt; include “ia64_flags.h”</p>

<pre>.pred.safe_across_calls p1-p5,p16-p63</pre>

<p>.text</p>

<pre> int ffi_call_unix (struct ia64_args *stack, PTR64 rvalue,
                    void (*fn)(void), int flags);
/

      .align 16
      .global ffi_call_unix
      .proc   ffi_call_unix</pre>

<p>ffi_call_unix:</p>

<pre>.prologue
/* Bit o trickiness.  We actually share a stack frame with ffi_call.
   Rely on the fact that ffi_call uses a vframe and don't bother
   tracking one here at all.    
.fframe 0
.save   ar.pfs, r36 // loc0
alloc   loc0 = ar.pfs, 4, 3, 8, 0
.save   rp, loc1
mov     loc1 = b0
.body
add     r16 = 16, in0
mov     loc2 = gp
mov     r8 = in1
;;

/* Load up all of the argument registers.  */
ldf.fill f8 = [in0], 32
ldf.fill f9 = [r16], 32
;;
ldf.fill f10 = [in0], 32
ldf.fill f11 = [r16], 32
;;
ldf.fill f12 = [in0], 32
ldf.fill f13 = [r16], 32
;;
ldf.fill f14 = [in0], 32
ldf.fill f15 = [r16], 24
;;
ld8     out0 = [in0], 16
ld8     out1 = [r16], 16
;;
ld8     out2 = [in0], 16
ld8     out3 = [r16], 16
;;
ld8     out4 = [in0], 16
ld8     out5 = [r16], 16
;;
ld8     out6 = [in0]
ld8     out7 = [r16]
;;

/* Deallocate the register save area from the stack frame.  */
mov     sp = in0

/* Call the target function.  */
ld8     r16 = [in2], 8
;;
ld8     gp = [in2]
mov     b6 = r16
br.call.sptk.many b0 = b6
;;

/* Dispatch to handle return value.  */
mov     gp = loc2
zxt1    r16 = in3
;;
mov     ar.pfs = loc0
addl    r18 = @ltoffx(.Lst_table), gp
;;
ld8.mov r18 = [r18], .Lst_table
mov     b0 = loc1
;;
shladd  r18 = r16, 3, r18
;;
ld8     r17 = [r18]
shr     in3 = in3, 8
;;
add     r17 = r17, r18
;;
mov     b6 = r17
br      b6
;;</pre>

<p>.Lst_void:</p>

<pre>br.ret.sptk.many b0
;;</pre>

<p>.Lst_uint8:</p>

<pre>zxt1    r8 = r8
;;
st8     [in1] = r8
br.ret.sptk.many b0
;;</pre>

<p>.Lst_sint8:</p>

<pre>sxt1    r8 = r8
;;
st8     [in1] = r8
br.ret.sptk.many b0
;;</pre>

<p>.Lst_uint16:</p>

<pre>zxt2    r8 = r8
;;
st8     [in1] = r8
br.ret.sptk.many b0
;;</pre>

<p>.Lst_sint16:</p>

<pre>sxt2    r8 = r8
;;
st8     [in1] = r8
br.ret.sptk.many b0
;;</pre>

<p>.Lst_uint32:</p>

<pre>zxt4    r8 = r8
;;
st8     [in1] = r8
br.ret.sptk.many b0
;;</pre>

<p>.Lst_sint32:</p>

<pre>sxt4    r8 = r8
;;
st8     [in1] = r8
br.ret.sptk.many b0
;;</pre>

<p>.Lst_int64:</p>

<pre>st8     [in1] = r8
br.ret.sptk.many b0
;;</pre>

<p>.Lst_float:</p>

<pre>stfs    [in1] = f8
br.ret.sptk.many b0
;;</pre>

<p>.Lst_double:</p>

<pre>stfd    [in1] = f8
br.ret.sptk.many b0
;;</pre>

<p>.Lst_ldouble:</p>

<pre>stfe    [in1] = f8
br.ret.sptk.many b0
;;</pre>

<p>.Lst_small_struct:</p>

<pre>add     sp = -16, sp
cmp.lt  p6, p0 = 8, in3
cmp.lt  p7, p0 = 16, in3
cmp.lt  p8, p0 = 24, in3
;;
add     r16 = 8, sp
add     r17 = 16, sp
add     r18 = 24, sp
;;
st8     [sp] = r8</pre>

<p>(p6)    st8     [r16] = r9</p>

<pre>mov     out0 = in1</pre>

<p>(p7)    st8     [r17] = r10 (p8)    st8     [r18] = r11</p>

<pre>mov     out1 = sp
mov     out2 = in3
br.call.sptk.many b0 = memcpy#
;;
mov     ar.pfs = loc0
mov     b0 = loc1
mov     gp = loc2
br.ret.sptk.many b0</pre>

<p>.Lst_hfa_float:</p>

<pre>add     r16 = 4, in1
cmp.lt  p6, p0 = 4, in3
;;
stfs    [in1] = f8, 8</pre>

<p>(p6)    stfs    [r16] = f9, 8</p>

<pre>cmp.lt  p7, p0 = 8, in3
cmp.lt  p8, p0 = 12, in3
;;</pre>

<p>(p7)    stfs    [in1] = f10, 8 (p8)    stfs    [r16] = f11, 8</p>

<pre>cmp.lt  p9, p0 = 16, in3
cmp.lt  p10, p0 = 20, in3
;;</pre>

<p>(p9)    stfs    [in1] = f12, 8 (p10)   stfs    [r16] = f13, 8</p>

<pre>cmp.lt  p6, p0 = 24, in3
cmp.lt  p7, p0 = 28, in3
;;</pre>

<p>(p6)    stfs    [in1] = f14 (p7)    stfs    [r16] = f15</p>

<pre>br.ret.sptk.many b0
;;</pre>

<p>.Lst_hfa_double:</p>

<pre>add     r16 = 8, in1
cmp.lt  p6, p0 = 8, in3
;;
stfd    [in1] = f8, 16</pre>

<p>(p6)    stfd    [r16] = f9, 16</p>

<pre>cmp.lt  p7, p0 = 16, in3
cmp.lt  p8, p0 = 24, in3
;;</pre>

<p>(p7)    stfd    [in1] = f10, 16 (p8)    stfd    [r16] = f11, 16</p>

<pre>cmp.lt  p9, p0 = 32, in3
cmp.lt  p10, p0 = 40, in3
;;</pre>

<p>(p9)    stfd    [in1] = f12, 16 (p10)   stfd    [r16] = f13, 16</p>

<pre>cmp.lt  p6, p0 = 48, in3
cmp.lt  p7, p0 = 56, in3
;;</pre>

<p>(p6)    stfd    [in1] = f14 (p7)    stfd    [r16] = f15</p>

<pre>br.ret.sptk.many b0
;;</pre>

<p>.Lst_hfa_ldouble:</p>

<pre>add     r16 = 16, in1
cmp.lt  p6, p0 = 16, in3
;;
stfe    [in1] = f8, 32</pre>

<p>(p6)    stfe    [r16] = f9, 32</p>

<pre>cmp.lt  p7, p0 = 32, in3
cmp.lt  p8, p0 = 48, in3
;;</pre>

<p>(p7)    stfe    [in1] = f10, 32 (p8)    stfe    [r16] = f11, 32</p>

<pre>cmp.lt  p9, p0 = 64, in3
cmp.lt  p10, p0 = 80, in3
;;</pre>

<p>(p9)    stfe    [in1] = f12, 32 (p10)   stfe    [r16] = f13, 32</p>

<pre>cmp.lt  p6, p0 = 96, in3
cmp.lt  p7, p0 = 112, in3
;;</pre>

<p>(p6)    stfe    [in1] = f14 (p7)    stfe    [r16] = f15</p>

<pre>br.ret.sptk.many b0
;;

.endp ffi_call_unix

.align 16
.global ffi_closure_unix
.proc ffi_closure_unix</pre>

<p>define FRAME_SIZE      (8*16 + 8*8 + 8*16)</p>

<p>ffi_closure_unix:</p>

<pre>.prologue
.save   ar.pfs, r40 // loc0
alloc   loc0 = ar.pfs, 8, 4, 4, 0
.fframe FRAME_SIZE
add     r12 = -FRAME_SIZE, r12
.save   rp, loc1
mov     loc1 = b0
.save   ar.unat, loc2
mov     loc2 = ar.unat
.body

/* Retrieve closure pointer and real gp.  */</pre>

<p>ifdef _ILP32</p>

<pre>addp4   out0 = 0, gp
addp4   gp = 16, gp</pre>

<p>else</p>

<pre>mov     out0 = gp
add     gp = 16, gp</pre>

<p>endif</p>

<pre>;;
ld8     gp = [gp]

/* Spill all of the possible argument registers.  */
add     r16 = 16 + 8*16, sp
add     r17 = 16 + 8*16 + 16, sp
;;
stf.spill [r16] = f8, 32
stf.spill [r17] = f9, 32
mov     loc3 = gp
;;
stf.spill [r16] = f10, 32
stf.spill [r17] = f11, 32
;;
stf.spill [r16] = f12, 32
stf.spill [r17] = f13, 32
;;
stf.spill [r16] = f14, 32
stf.spill [r17] = f15, 24
;;
.mem.offset 0, 0
st8.spill [r16] = in0, 16
.mem.offset 8, 0
st8.spill [r17] = in1, 16
add     out1 = 16 + 8*16, sp
;;
.mem.offset 0, 0
st8.spill [r16] = in2, 16
.mem.offset 8, 0
st8.spill [r17] = in3, 16
add     out2 = 16, sp
;;
.mem.offset 0, 0
st8.spill [r16] = in4, 16
.mem.offset 8, 0
st8.spill [r17] = in5, 16
mov     out3 = r8
;;
.mem.offset 0, 0
st8.spill [r16] = in6
.mem.offset 8, 0
st8.spill [r17] = in7

/* Invoke ffi_closure_unix_inner for the hard work.  */
br.call.sptk.many b0 = ffi_closure_unix_inner
;;

/* Dispatch to handle return value.  */
mov     gp = loc3
zxt1    r16 = r8
;;
addl    r18 = @ltoffx(.Lld_table), gp
mov     ar.pfs = loc0
;;
ld8.mov r18 = [r18], .Lld_table
mov     b0 = loc1
;;
shladd  r18 = r16, 3, r18
mov     ar.unat = loc2
;;
ld8     r17 = [r18]
shr     r8 = r8, 8
;;
add     r17 = r17, r18
add     r16 = 16, sp
;;
mov     b6 = r17
br      b6
;;
.label_state 1</pre>

<p>.Lld_void:</p>

<pre>.restore sp
add     sp = FRAME_SIZE, sp
br.ret.sptk.many b0
;;</pre>

<p>.Lld_int:</p>

<pre>.body
.copy_state 1
ld8     r8 = [r16]
.restore sp
add     sp = FRAME_SIZE, sp
br.ret.sptk.many b0
;;</pre>

<p>.Lld_float:</p>

<pre>.body
.copy_state 1
ldfs    f8 = [r16]
.restore sp
add     sp = FRAME_SIZE, sp
br.ret.sptk.many b0
;;</pre>

<p>.Lld_double:</p>

<pre>.body
.copy_state 1
ldfd    f8 = [r16]
.restore sp
add     sp = FRAME_SIZE, sp
br.ret.sptk.many b0
;;</pre>

<p>.Lld_ldouble:</p>

<pre>.body
.copy_state 1
ldfe    f8 = [r16]
.restore sp
add     sp = FRAME_SIZE, sp
br.ret.sptk.many b0
;;</pre>

<p>.Lld_small_struct:</p>

<pre>.body
.copy_state 1
add     r17 = 8, r16
cmp.lt  p6, p0 = 8, r8
cmp.lt  p7, p0 = 16, r8
cmp.lt  p8, p0 = 24, r8
;;
ld8     r8 = [r16], 16</pre>

<p>(p6)    ld8     r9 = [r17], 16</p>

<pre>;;</pre>

<p>(p7)    ld8     r10 = [r16] (p8)    ld8     r11 = [r17]</p>

<pre>.restore sp
add     sp = FRAME_SIZE, sp
br.ret.sptk.many b0
;;</pre>

<p>.Lld_hfa_float:</p>

<pre>.body
.copy_state 1
add     r17 = 4, r16
cmp.lt  p6, p0 = 4, r8
;;
ldfs    f8 = [r16], 8</pre>

<p>(p6)    ldfs    f9 = [r17], 8</p>

<pre>cmp.lt  p7, p0 = 8, r8
cmp.lt  p8, p0 = 12, r8
;;</pre>

<p>(p7)    ldfs    f10 = [r16], 8 (p8)    ldfs    f11 = [r17], 8</p>

<pre>cmp.lt  p9, p0 = 16, r8
cmp.lt  p10, p0 = 20, r8
;;</pre>

<p>(p9)    ldfs    f12 = [r16], 8 (p10)   ldfs    f13 = [r17], 8</p>

<pre>cmp.lt  p6, p0 = 24, r8
cmp.lt  p7, p0 = 28, r8
;;</pre>

<p>(p6)    ldfs    f14 = [r16] (p7)    ldfs    f15 = [r17]</p>

<pre>.restore sp
add     sp = FRAME_SIZE, sp
br.ret.sptk.many b0
;;</pre>

<p>.Lld_hfa_double:</p>

<pre>.body
.copy_state 1
add     r17 = 8, r16
cmp.lt  p6, p0 = 8, r8
;;
ldfd    f8 = [r16], 16</pre>

<p>(p6)    ldfd    f9 = [r17], 16</p>

<pre>cmp.lt  p7, p0 = 16, r8
cmp.lt  p8, p0 = 24, r8
;;</pre>

<p>(p7)    ldfd    f10 = [r16], 16 (p8)    ldfd    f11 = [r17], 16</p>

<pre>cmp.lt  p9, p0 = 32, r8
cmp.lt  p10, p0 = 40, r8
;;</pre>

<p>(p9)    ldfd    f12 = [r16], 16 (p10)   ldfd    f13 = [r17], 16</p>

<pre>cmp.lt  p6, p0 = 48, r8
cmp.lt  p7, p0 = 56, r8
;;</pre>

<p>(p6)    ldfd    f14 = [r16] (p7)    ldfd    f15 = [r17]</p>

<pre>.restore sp
add     sp = FRAME_SIZE, sp
br.ret.sptk.many b0
;;</pre>

<p>.Lld_hfa_ldouble:</p>

<pre>.body
.copy_state 1
add     r17 = 16, r16
cmp.lt  p6, p0 = 16, r8
;;
ldfe    f8 = [r16], 32</pre>

<p>(p6)    ldfe    f9 = [r17], 32</p>

<pre>cmp.lt  p7, p0 = 32, r8
cmp.lt  p8, p0 = 48, r8
;;</pre>

<p>(p7)    ldfe    f10 = [r16], 32 (p8)    ldfe    f11 = [r17], 32</p>

<pre>cmp.lt  p9, p0 = 64, r8
cmp.lt  p10, p0 = 80, r8
;;</pre>

<p>(p9)    ldfe    f12 = [r16], 32 (p10)   ldfe    f13 = [r17], 32</p>

<pre>cmp.lt  p6, p0 = 96, r8
cmp.lt  p7, p0 = 112, r8
;;</pre>

<p>(p6)    ldfe    f14 = [r16] (p7)    ldfe    f15 = [r17]</p>

<pre>.restore sp
add     sp = FRAME_SIZE, sp
br.ret.sptk.many b0
;;

.endp   ffi_closure_unix

.section .rodata
.align  8</pre>

<p>.Lst_table:</p>

<pre>data8   @pcrel(.Lst_void)               // FFI_TYPE_VOID
data8   @pcrel(.Lst_sint32)             // FFI_TYPE_INT
data8   @pcrel(.Lst_float)              // FFI_TYPE_FLOAT
data8   @pcrel(.Lst_double)             // FFI_TYPE_DOUBLE
data8   @pcrel(.Lst_ldouble)            // FFI_TYPE_LONGDOUBLE
data8   @pcrel(.Lst_uint8)              // FFI_TYPE_UINT8
data8   @pcrel(.Lst_sint8)              // FFI_TYPE_SINT8
data8   @pcrel(.Lst_uint16)             // FFI_TYPE_UINT16
data8   @pcrel(.Lst_sint16)             // FFI_TYPE_SINT16
data8   @pcrel(.Lst_uint32)             // FFI_TYPE_UINT32
data8   @pcrel(.Lst_sint32)             // FFI_TYPE_SINT32
data8   @pcrel(.Lst_int64)              // FFI_TYPE_UINT64
data8   @pcrel(.Lst_int64)              // FFI_TYPE_SINT64
data8   @pcrel(.Lst_void)               // FFI_TYPE_STRUCT
data8   @pcrel(.Lst_int64)              // FFI_TYPE_POINTER
data8   @pcrel(.Lst_small_struct)       // FFI_IA64_TYPE_SMALL_STRUCT
data8   @pcrel(.Lst_hfa_float)          // FFI_IA64_TYPE_HFA_FLOAT
data8   @pcrel(.Lst_hfa_double)         // FFI_IA64_TYPE_HFA_DOUBLE
data8   @pcrel(.Lst_hfa_ldouble)        // FFI_IA64_TYPE_HFA_LDOUBLE</pre>

<p>.Lld_table:</p>

<pre>data8   @pcrel(.Lld_void)               // FFI_TYPE_VOID
data8   @pcrel(.Lld_int)                // FFI_TYPE_INT
data8   @pcrel(.Lld_float)              // FFI_TYPE_FLOAT
data8   @pcrel(.Lld_double)             // FFI_TYPE_DOUBLE
data8   @pcrel(.Lld_ldouble)            // FFI_TYPE_LONGDOUBLE
data8   @pcrel(.Lld_int)                // FFI_TYPE_UINT8
data8   @pcrel(.Lld_int)                // FFI_TYPE_SINT8
data8   @pcrel(.Lld_int)                // FFI_TYPE_UINT16
data8   @pcrel(.Lld_int)                // FFI_TYPE_SINT16
data8   @pcrel(.Lld_int)                // FFI_TYPE_UINT32
data8   @pcrel(.Lld_int)                // FFI_TYPE_SINT32
data8   @pcrel(.Lld_int)                // FFI_TYPE_UINT64
data8   @pcrel(.Lld_int)                // FFI_TYPE_SINT64
data8   @pcrel(.Lld_void)               // FFI_TYPE_STRUCT
data8   @pcrel(.Lld_int)                // FFI_TYPE_POINTER
data8   @pcrel(.Lld_small_struct)       // FFI_IA64_TYPE_SMALL_STRUCT
data8   @pcrel(.Lld_hfa_float)          // FFI_IA64_TYPE_HFA_FLOAT
data8   @pcrel(.Lld_hfa_double)         // FFI_IA64_TYPE_HFA_DOUBLE
data8   @pcrel(.Lld_hfa_ldouble)        // FFI_IA64_TYPE_HFA_LDOUBLE</pre>

<p>if defined __ELF__ &amp;&amp; defined __linux__</p>

<pre>.section        .note.GNU-stack,&quot;&quot;,@progbits</pre>

<p>endif</p>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

