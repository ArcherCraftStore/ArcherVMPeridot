<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>texinfo.tex - ffi-1.9.3-x86-mingw32 Documentation</title>

<link href="../../../fonts.css" rel="stylesheet">
<link href="../../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../";
</script>

<script src="../../../js/jquery.js"></script>
<script src="../../../js/navigation.js"></script>
<script src="../../../js/search_index.js"></script>
<script src="../../../js/search.js"></script>
<script src="../../../js/searcher.js"></script>
<script src="../../../js/darkfish.js"></script>


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../../ext/ffi_c/libffi/ChangeLog.html">ChangeLog</a>
  
    <li><a href="../../../ext/ffi_c/libffi/ChangeLog_libffi.html">ChangeLog.libffi</a>
  
    <li><a href="../../../ext/ffi_c/libffi/ChangeLog_libgcj.html">ChangeLog.libgcj</a>
  
    <li><a href="../../../ext/ffi_c/libffi/ChangeLog_v1.html">ChangeLog.v1</a>
  
    <li><a href="../../../ext/ffi_c/libffi/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../ext/ffi_c/libffi/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../ext/ffi_c/libffi/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../ext/ffi_c/libffi/Makefile_vc.html">Makefile.vc</a>
  
    <li><a href="../../../ext/ffi_c/libffi/Makefile_vc64.html">Makefile.vc64</a>
  
    <li><a href="../../../ext/ffi_c/libffi/README.html">README</a>
  
    <li><a href="../../../ext/ffi_c/libffi/acinclude_m4.html">acinclude.m4</a>
  
    <li><a href="../../../ext/ffi_c/libffi/build-ios_sh.html">build-ios.sh</a>
  
    <li><a href="../../../ext/ffi_c/libffi/compile.html">compile</a>
  
    <li><a href="../../../ext/ffi_c/libffi/config_guess.html">config.guess</a>
  
    <li><a href="../../../ext/ffi_c/libffi/config_sub.html">config.sub</a>
  
    <li><a href="../../../ext/ffi_c/libffi/configure.html">configure</a>
  
    <li><a href="../../../ext/ffi_c/libffi/configure_ac.html">configure.ac</a>
  
    <li><a href="../../../ext/ffi_c/libffi/configure_host.html">configure.host</a>
  
    <li><a href="../../../ext/ffi_c/libffi/depcomp.html">depcomp</a>
  
    <li><a href="../../../ext/ffi_c/libffi/doc/libffi_info.html">libffi.info</a>
  
    <li><a href="../../../ext/ffi_c/libffi/doc/stamp-vti.html">stamp-vti</a>
  
    <li><a href="../../../ext/ffi_c/libffi/doc/version_texi.html">version.texi</a>
  
    <li><a href="../../../ext/ffi_c/libffi/fficonfig_h_in.html">fficonfig.h.in</a>
  
    <li><a href="../../../ext/ffi_c/libffi/include/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../ext/ffi_c/libffi/include/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../ext/ffi_c/libffi/install-sh.html">install-sh</a>
  
    <li><a href="../../../ext/ffi_c/libffi/libffi_pc_in.html">libffi.pc.in</a>
  
    <li><a href="../../../ext/ffi_c/libffi/libtool-version.html">libtool-version</a>
  
    <li><a href="../../../ext/ffi_c/libffi/ltmain_sh.html">ltmain.sh</a>
  
    <li><a href="../../../ext/ffi_c/libffi/m4/ax_cc_maxopt_m4.html">ax_cc_maxopt.m4</a>
  
    <li><a href="../../../ext/ffi_c/libffi/m4/ax_cflags_warn_all_m4.html">ax_cflags_warn_all.m4</a>
  
    <li><a href="../../../ext/ffi_c/libffi/m4/ax_check_compiler_flags_m4.html">ax_check_compiler_flags.m4</a>
  
    <li><a href="../../../ext/ffi_c/libffi/m4/ax_compiler_vendor_m4.html">ax_compiler_vendor.m4</a>
  
    <li><a href="../../../ext/ffi_c/libffi/m4/ax_configure_args_m4.html">ax_configure_args.m4</a>
  
    <li><a href="../../../ext/ffi_c/libffi/m4/ax_enable_builddir_m4.html">ax_enable_builddir.m4</a>
  
    <li><a href="../../../ext/ffi_c/libffi/m4/ax_gcc_archflag_m4.html">ax_gcc_archflag.m4</a>
  
    <li><a href="../../../ext/ffi_c/libffi/m4/ax_gcc_x86_cpuid_m4.html">ax_gcc_x86_cpuid.m4</a>
  
    <li><a href="../../../ext/ffi_c/libffi/man/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../ext/ffi_c/libffi/man/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../ext/ffi_c/libffi/man/ffi_3.html">ffi.3</a>
  
    <li><a href="../../../ext/ffi_c/libffi/man/ffi_call_3.html">ffi_call.3</a>
  
    <li><a href="../../../ext/ffi_c/libffi/man/ffi_prep_cif_3.html">ffi_prep_cif.3</a>
  
    <li><a href="../../../ext/ffi_c/libffi/mdate-sh.html">mdate-sh</a>
  
    <li><a href="../../../ext/ffi_c/libffi/missing.html">missing</a>
  
    <li><a href="../../../ext/ffi_c/libffi/msvcc_sh.html">msvcc.sh</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/alpha/osf_S.html">osf.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/arm/gentramp_sh.html">gentramp.sh</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/arm/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/arm/trampoline_S.html">trampoline.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/avr32/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/cris/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/frv/eabi_S.html">eabi.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/ia64/unix_S.html">unix.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/m32r/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/m68k/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/mips/n32_S.html">n32.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/mips/o32_S.html">o32.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/moxie/eabi_S.html">eabi.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/pa/hpux32_S.html">hpux32.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/pa/linux_S.html">linux.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/powerpc/aix_S.html">aix.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/powerpc/aix_closure_S.html">aix_closure.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/powerpc/darwin_S.html">darwin.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/powerpc/darwin_closure_S.html">darwin_closure.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/powerpc/linux64_S.html">linux64.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/powerpc/linux64_closure_S.html">linux64_closure.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/powerpc/ppc_closure_S.html">ppc_closure.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/powerpc/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/s390/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/sh/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/sh64/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/sparc/v8_S.html">v8.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/sparc/v9_S.html">v9.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/x86/darwin_S.html">darwin.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/x86/darwin64_S.html">darwin64.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/x86/freebsd_S.html">freebsd.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/x86/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/x86/unix64_S.html">unix64.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/x86/win32_S.html">win32.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/src/x86/win64_S.html">win64.S</a>
  
    <li><a href="../../../ext/ffi_c/libffi/testsuite/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../ext/ffi_c/libffi/testsuite/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../ext/ffi_c/libffi/testsuite/config/default_exp.html">default.exp</a>
  
    <li><a href="../../../ext/ffi_c/libffi/testsuite/lib/libffi-dg_exp.html">libffi-dg.exp</a>
  
    <li><a href="../../../ext/ffi_c/libffi/testsuite/lib/libffi_exp.html">libffi.exp</a>
  
    <li><a href="../../../ext/ffi_c/libffi/testsuite/lib/target-libpath_exp.html">target-libpath.exp</a>
  
    <li><a href="../../../ext/ffi_c/libffi/testsuite/lib/wrapper_exp.html">wrapper.exp</a>
  
    <li><a href="../../../ext/ffi_c/libffi/testsuite/libffi_call/call_exp.html">call.exp</a>
  
    <li><a href="../../../ext/ffi_c/libffi/testsuite/libffi_special/special_exp.html">special.exp</a>
  
    <li><a href="../../../ext/ffi_c/libffi/texinfo_tex.html">texinfo.tex</a>
  
    <li><a href="../../../lib/ffi/platform/arm-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/i386-cygwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/i386-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/i386-freebsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/i386-gnu/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/i386-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/i386-netbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/i386-openbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/i386-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/i386-windows/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/ia64-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/mips-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/mipsel-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/powerpc-aix/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/powerpc-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/powerpc-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/s390-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/s390x-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/sparc-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/sparc-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/sparcv9-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/x86_64-cygwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/x86_64-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/x86_64-freebsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/x86_64-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/x86_64-netbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/x86_64-openbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/x86_64-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../lib/ffi/platform/x86_64-windows/types_conf.html">types.conf</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page ext/ffi_c/libffi/texinfo.tex">

<p>% texinfo.tex – TeX macros to handle Texinfo files. % % Load plain if
necessary, i.e., if running under initex. expandafterifxcsname
fmtnameendcsnamerelaxinput plainfi % deftexinfoversion{2005-07-05.19} % %
Copyright (C) 1985, 1986, 1988, 1990, 1991, 1992, 1993, 1994, 1995, % 1996,
1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005 Free Software %
Foundation, Inc. % % This texinfo.tex file is free software; you can
redistribute it and/or % modify it under the terms of the GNU General
Public License as % published by the Free Software Foundation; either
version 2, or (at % your option) any later version. % % This texinfo.tex
file is distributed in the hope that it will be % useful, but WITHOUT ANY
WARRANTY; without even the implied warranty % of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU % General Public License for more
details. % % You should have received a copy of the GNU General Public
License % along with this texinfo.tex file; see the file COPYING.  If not,
write % to the Free Software Foundation, Inc., 51 Franklin Street, Fifth
Floor, % Boston, MA 02110-1301, USA. % % As a special exception, when this
file is read by TeX when processing % a Texinfo source document, you may
use the result without % restriction.  (This has been our intent since
Texinfo was invented.) % % Please try the latest version of texinfo.tex
before submitting bug % reports; you can get the latest version from: %  
<a
href="http://www.gnu.org/software/texinfo">www.gnu.org/software/texinfo</a>/
(the Texinfo home page), or %   <a
href="ftp://tug.org/tex/texinfo.tex">tug.org/tex/texinfo.tex</a> %     (and
all CTAN mirrors, see <a href="http://www.ctan.org">www.ctan.org</a>). %
The texinfo.tex in any given distribution could well be out % of date, so
if that’s what you’re using, please check. % % Send bug reports to
bug-texinfo@gnu.org.  Please include including a % complete document in
each bug report with which we can reproduce the % problem.  Patches are, of
course, greatly appreciated. % % To process a Texinfo manual with TeX, it’s
most reliable to use the % texi2dvi shell script that comes with the
distribution.  For a simple % manual foo.texi, however, you can get away
with this: %   tex foo.texi %   texindex foo.?? %   tex foo.texi %   tex
foo.texi %   dvips foo.dvi -o  # or whatever; this makes foo.ps. % The
extra TeX runs get the cross-reference information correct. % Sometimes one
run after texindex suffices, and sometimes you need more % than two;
texi2dvi does it as many times as necessary. % % It is possible to adapt
texinfo.tex for other languages, to some % extent.  You can get the
existing language-specific files from the % full Texinfo distribution. % %
The GNU Texinfo home page is <a
href="http://www.gnu.org/software/texinfo">www.gnu.org/software/texinfo</a>.</p>

<p>message{Loading texinfo [version texinfoversion]:}</p>

<p>% If in a .fmt file, print the version number % and turn on active
characters that we couldn’t do earlier because % they might have appeared
in the input file name. everyjob{message{[Texinfo version texinfoversion]}%</p>

<pre>\catcode`+=\active \catcode`\_=\active}</pre>

<p>message{Basics,} chardefother=12</p>

<p>% We never want plain’s outer definition of + in Texinfo. % For @tex, we
can use tabalign. let+ = relax</p>

<p>% Save some plain tex macros whose names we will redefine. letptexb=b
letptexbullet=bullet letptexc=c letptexcomma=, letptexdot=.
letptexdots=dots letptexend=end letptexequiv=equiv letptexexclam=!
letptexfootnote=footnote letptexgtr=&gt; letptexhat=^ letptexi=i
letptexindent=indent letptexinsert=insert letptexlbrace={ letptexless=&lt;
letptexnewwritenewwrite letptexnoindent=noindent letptexplus=+
letptexrbrace=} letptexslash=/ letptexstar=* letptext=t</p>

<p>% If this character appears in an error message or help string, it % starts
a new line in the output. newlinechar = `^^J</p>

<p>% Use TeX 3.0’s inputlineno to get the line number, for better error %
messages, but if we’re using an old version of TeX, don’t do anything. %
ifxinputlinenothisisundefined</p>

<pre>\let\linenumber = \empty % Pre-3.0.</pre>

<p>else</p>

<pre>\def\linenumber{l.\the\inputlineno:\space}</pre>

<p>fi</p>

<p>% Set up fixed words for English if not already set.
ifxputwordAppendixundefined  gdefputwordAppendix{Appendix}fi
ifxputwordChapterundefined   gdefputwordChapter{Chapter}fi
ifxputwordfileundefined      gdefputwordfile{file}fi ifxputwordinundefined 
gdefputwordin{in}fi ifxputwordIndexIsEmptyundefined    
gdefputwordIndexIsEmpty{(Index is empty)}fi
ifxputwordIndexNonexistentundefined gdefputwordIndexNonexistent{(Index is
nonexistent)}fi ifxputwordInfoundefined      gdefputwordInfo{Info}fi
ifxputwordInstanceVariableofundefined
gdefputwordInstanceVariableof{Instance Variable of}fi
ifxputwordMethodonundefined  gdefputwordMethodon{Method on}fi
ifxputwordNoTitleundefined   gdefputwordNoTitle{No Title}fi
ifxputwordofundefined        gdefputwordof{of}fi ifxputwordonundefined     
gdefputwordon{on}fi ifxputwordpageundefined      gdefputwordpage{page}fi
ifxputwordsectionundefined   gdefputwordsection{section}fi
ifxputwordSectionundefined   gdefputwordSection{Section}fi
ifxputwordseeundefined       gdefputwordsee{see}fi ifxputwordSeeundefined  
gdefputwordSee{See}fi ifxputwordShortTOCundefined 
gdefputwordShortTOC{Short Contents}fi ifxputwordTOCundefined      
gdefputwordTOC{Table of Contents}fi % ifxputwordMJanundefined
gdefputwordMJan{January}fi ifxputwordMFebundefined
gdefputwordMFeb{February}fi ifxputwordMMarundefined
gdefputwordMMar{March}fi ifxputwordMAprundefined gdefputwordMApr{April}fi
ifxputwordMMayundefined gdefputwordMMay{May}fi ifxputwordMJunundefined
gdefputwordMJun{June}fi ifxputwordMJulundefined gdefputwordMJul{July}fi
ifxputwordMAugundefined gdefputwordMAug{August}fi ifxputwordMSepundefined
gdefputwordMSep{September}fi ifxputwordMOctundefined
gdefputwordMOct{October}fi ifxputwordMNovundefined
gdefputwordMNov{November}fi ifxputwordMDecundefined
gdefputwordMDec{December}fi % ifxputwordDefmacundefined   
gdefputwordDefmac{Macro}fi ifxputwordDefspecundefined  
gdefputwordDefspec{Special Form}fi ifxputwordDefvarundefined   
gdefputwordDefvar{Variable}fi ifxputwordDefoptundefined   
gdefputwordDefopt{User Option}fi ifxputwordDeffuncundefined  
gdefputwordDeffunc{Function}fi</p>

<p>% In some macros, we cannot use the `? notation—the left quote is % in some
cases the escape char. chardefbackChar  = `\ chardefcolonChar = `:
chardefcommaChar = `, chardefdotChar   = `. chardefexclamChar= `!
chardefplusChar  = `+ chardefquestChar = `? chardefsemiChar  = `;
chardefunderChar = `_</p>

<p>chardefspaceChar = `\ % chardefspacecat = 10
defspaceisspace{catcodespaceChar=spacecat}</p>

<p>{% for help with debugging.</p>

<pre>% example usage: \expandafter\show\activebackslash
\catcode`\! = 0 \catcode`\\ = \active
!global!def!activebackslash{\}</pre>

<p>}</p>

<p>% Ignore a token. % defgobble#1{}</p>

<p>% The following is used inside several edef’s.
defmakecsname#1{expandafternoexpandcsname#1endcsname}</p>

<p>% Hyphenation fixes. hyphenation{</p>

<pre>Flor-i-da Ghost-script Ghost-view Mac-OS Post-Script
ap-pen-dix bit-map bit-maps
data-base data-bases eshell fall-ing half-way long-est man-u-script
man-u-scripts mini-buf-fer mini-buf-fers over-view par-a-digm
par-a-digms rath-er rec-tan-gu-lar ro-bot-ics se-vere-ly set-up spa-ces
spell-ing spell-ings
stand-alone strong-est time-stamp time-stamps which-ever white-space
wide-spread wrap-around</pre>

<p>}</p>

<p>% Margin to add to right of even pages, to left of odd pages.
newdimenbindingoffset newdimennormaloffset newdimenpagewidth
newdimenpageheight</p>

<p>% For a final copy, take out the rectangles % that mark overfull boxes (in
case you have decided % that the text looks ok even though it passes the
margin). % deffinalout{overfullrule=0pt}</p>

<p>% @| inserts a changebar to the left of the current line.  It should %
surround any changed text.  This approach does <strong>not</strong> work if
the % change spans more than two lines of output.  To handle that, we would
% have adopt a much more difficult approach (putting marks into the main %
vertical list for the beginning and end of each change). % def|{%</p>

<pre>% \vadjust can only be used in horizontal mode.
\leavevmode
%
% Append this vertical mode material after the current line in the output.
\vadjust{%
  % We want to insert a rule with the height and depth of the current
  % leading; that is exactly what \strutbox is supposed to record.
  \vskip-\baselineskip
  %
  % \vadjust-items are inserted at the left edge of the type.  So
  % the \llap here moves out into the left-hand margin.
  \llap{%
    %
    % For a thicker or thinner bar, change the `1pt'.
    \vrule height\baselineskip width1pt
    %
    % This is the space between the bar and the text.
    \hskip 12pt
  }%
}%</pre>

<p>}</p>

<p>% Sometimes it is convenient to have everything in the transcript file %
and nothing on the terminal.  We don’t just call tracingall here, % since
that produces some useless output on the terminal.  We also make % some
effort to order the tracing commands to reduce output in the log % file;
cf. trace.sty in LaTeX. % defgloggingall{begingroup globaldefs = 1
loggingall endgroup}% defloggingall{%</p>

<pre>\tracingstats2
\tracingpages1
\tracinglostchars2  % 2 gives us more in etex
\tracingparagraphs1
\tracingoutput1
\tracingmacros2
\tracingrestores1
\showboxbreadth\maxdimen \showboxdepth\maxdimen
\ifx\eTeXversion\undefined\else % etex gives us more logging
  \tracingscantokens1
  \tracingifs1
  \tracinggroups1
  \tracingnesting2
  \tracingassigns1
\fi
\tracingcommands3  % 3 gives us more in etex
\errorcontextlines16</pre>

<p>}%</p>

<p>% add check for lastpenalty to plain’s definitions.  If the last thing % we
did was a nobreak, we don’t want to insert more space. %
defsmallbreak{ifnumlastpenalty&lt;10000parifdimlastskip&lt;smallskipamount</p>

<pre>\removelastskip\penalty-50\smallskip\fi\fi}</pre>

<p>defmedbreak{ifnumlastpenalty&lt;10000parifdimlastskip&lt;medskipamount</p>

<pre>\removelastskip\penalty-100\medskip\fi\fi}</pre>

<p>defbigbreak{ifnumlastpenalty&lt;10000parifdimlastskip&lt;bigskipamount</p>

<pre>\removelastskip\penalty-200\bigskip\fi\fi}</pre>

<p>% For @cropmarks command. % Do @cropmarks to get crop marks. %
newififcropmarks letcropmarks = cropmarkstrue % % Dimensions to add
cropmarks at corners. % Added by P. A. MacKay, 12 Nov. 1986 %
newdimenouterhsize newdimenoutervsize % set by the paper size routines
newdimencornerlong  cornerlong=1pc newdimencornerthick cornerthick=.3pt
newdimentopandbottommargin topandbottommargin=.75in</p>

<p>% Main output routine. chardefPAGE = 255 output =
{onepageout{pagecontentsPAGE}}</p>

<p>newboxheadlinebox newboxfootlinebox</p>

<p>% onepageout takes a vbox as an argument.  Note that pagecontents % does
insertions, but you have to call it yourself. defonepageout#1{%</p>

<pre>\ifcropmarks \hoffset=0pt \else \hoffset=\normaloffset \fi
%
\ifodd\pageno  \advance\hoffset by \bindingoffset
\else \advance\hoffset by -\bindingoffset\fi
%
% Do this outside of the \shipout so @code etc. will be expanded in
% the headline as they should be, not taken literally (outputting ''code).
\setbox\headlinebox = \vbox{\let\hsize=\pagewidth \makeheadline}%
\setbox\footlinebox = \vbox{\let\hsize=\pagewidth \makefootline}%
%
{%
  % Have to do this stuff outside the \shipout because we want it to
  % take effect in \write's, yet the group defined by the \vbox ends
  % before the \shipout runs.
  %
  \indexdummies         % don't expand commands in the output.
  \shipout\vbox{%
    % Do this early so pdf references go to the beginning of the page.
    \ifpdfmakepagedest \pdfdest name{\the\pageno} xyz\fi
    %
    \ifcropmarks \vbox to \outervsize\bgroup
      \hsize = \outerhsize
      \vskip-\topandbottommargin
      \vtop to0pt{%
        \line{\ewtop\hfil\ewtop}%
        \nointerlineskip
        \line{%
          \vbox{\moveleft\cornerthick\nstop}%
          \hfill
          \vbox{\moveright\cornerthick\nstop}%
        }%
        \vss}%
      \vskip\topandbottommargin
      \line\bgroup
        \hfil % center the page within the outer (page) hsize.
        \ifodd\pageno\hskip\bindingoffset\fi
        \vbox\bgroup
    \fi
    %
    \unvbox\headlinebox
    \pagebody{#1}%
    \ifdim\ht\footlinebox &gt; 0pt
      % Only leave this space if the footline is nonempty.
      % (We lessened \vsize for it in \oddfootingxxx.)
      % The \baselineskip=24pt in plain's \makefootline has no effect.
      \vskip 2\baselineskip
      \unvbox\footlinebox
    \fi
    %
    \ifcropmarks
        \egroup % end of \vbox\bgroup
      \hfil\egroup % end of (centering) \line\bgroup
      \vskip\topandbottommargin plus1fill minus1fill
      \boxmaxdepth = \cornerthick
      \vbox to0pt{\vss
        \line{%
          \vbox{\moveleft\cornerthick\nsbot}%
          \hfill
          \vbox{\moveright\cornerthick\nsbot}%
        }%
        \nointerlineskip
        \line{\ewbot\hfil\ewbot}%
      }%
    \egroup % \vbox from first cropmarks clause
    \fi
  }% end of \shipout\vbox
}% end of group with \indexdummies
\advancepageno
\ifnum\outputpenalty&gt;-20000 \else\dosupereject\fi</pre>

<p>}</p>

<p>newinsertmargin dimenmargin=maxdimen</p>

<p>defpagebody#1{vbox topageheight{boxmaxdepth=maxdepth #1}} {catcode`@ =11
gdefpagecontents#1{ifvoidtopinselseunvboxtopinsfi % marginal hacks,
juha@viisa.uucp (Juha Takala) ifvoidmarginelse % marginal info is present</p>

<pre>\rlap{\kern\hsize\vbox to\z@{\kern1pt\box\margin \vss}}\fi</pre>

<p>dimen@=dp#1 unvbox#1 ifvoidfootinselsevskipskipfootinsfootnoterule
unvboxfootinsfi ifr@ggedbottom kern-dimen@ vfil fi} }</p>

<p>% Here are the rules for the cropmarks.  Note that they are % offset so
that the space between them is truly outerhsize or outervsize % (P. A.
MacKay, 12 November, 1986) % defewtop{vrule heightcornerthick depth0pt
widthcornerlong} defnstop{vbox</p>

<pre>{\hrule height\cornerthick depth\cornerlong width\cornerthick}}</pre>

<p>defewbot{vrule height0pt depthcornerthick widthcornerlong} defnsbot{vbox</p>

<pre>{\hrule height\cornerlong depth\cornerthick width\cornerthick}}</pre>

<p>% Parse an argument, then pass it to #1.  The argument is the rest of % the
input line (except we remove a trailing comment).  #1 should be a % macro
which expects an ordinary undelimited TeX argument. %
defparsearg{parseargusing{}} defparseargusing#1#2{%</p>

<pre>\def\next{#2}%
\begingroup
  \obeylines
  \spaceisspace
  #1%
  \parseargline\empty% Insert the \empty token, see \finishparsearg below.</pre>

<p>}</p>

<p>{obeylines %</p>

<pre>\gdef\parseargline#1^^M{%
  \endgroup % End of the group started in \parsearg.
  \argremovecomment #1\comment\ArgTerm%
}%</pre>

<p>}</p>

<p>% First remove any @comment, then any @c comment.
defargremovecomment#1comment#2ArgTerm{argremovec #1cArgTerm}
defargremovec#1c#2ArgTerm{argcheckspaces#1^^MArgTerm}</p>

<p>% Each occurence of `^^M’ or `&lt;space&gt;^^M’ is replaced by a single
space. % % argremovec might leave us with trailing space, e.g., %    @end
itemize  @c foo % This space token undergoes the same procedure and is
eventually removed % by finishparsearg. %
defargcheckspaces#1^^M{argcheckspacesX#1^^M ^^M} defargcheckspacesX#1
^^M{argcheckspacesY#1^^M} defargcheckspacesY#1^^M#2^^M#3ArgTerm{%</p>

<pre>\def\temp{#3}%
\ifx\temp\empty
  % We cannot use \next here, as it holds the macro to run;
  % thus we reuse \temp.
  \let\temp\finishparsearg
\else
  \let\temp\argcheckspaces
\fi
% Put the space token in:
\temp#1 #3\ArgTerm</pre>

<p>}</p>

<p>% If a <em>delimited</em> argument is enclosed in braces, they get
stripped; so % to get <em>exactly</em> the rest of the line, we had to
prevent such situation. % We prepended an empty token at the very beginning
and we expand it now, % just before passing the control to next. %
(Similarily, we have to think about #3 of argcheckspacesY above: it is %
either the null string, or it ends with ^^M—thus there is no danger % that
a pair of braces would be stripped. % % But first, we have to remove the
trailing space token. % deffinishparsearg#1
ArgTerm{expandafternextexpandafter{#1}}</p>

<p>% parseargdeffoo{…} %       is roughly equivalent to % deffoo{parseargXfoo}
% defXfoo#1{…} % % Actually, I use csnamestringfooendcsname, ie. \foo, as
it is my % favourite TeX trick.  –kasal, 16nov03</p>

<p>defparseargdef#1{%</p>

<pre>\expandafter \doparseargdef \csname\string#1\endcsname #1%</pre>

<p>} defdoparseargdef#1#2{%</p>

<pre>\def#2{\parsearg#1}%
\def#1##1%</pre>

<p>}</p>

<p>% Several utility definitions with active space: {</p>

<pre>\obeyspaces
\gdef\obeyedspace{ }

% Make each space character in the input produce a normal interword
% space in the output.  Don't allow a line break at this space, as this
% is used only in environments like @example, where each line of input
% should produce a line of output anyway.
%
\gdef\sepspaces{\obeyspaces\let =\tie}

% If an index command is used in an @example environment, any spaces
% therein should become regular spaces in the raw index file, not the
% expansion of \tie (\leavevmode \penalty \@M \ ).
\gdef\unsepspaces{\let =\space}</pre>

<p>}</p>

<p>defflushcr{ifxparlisppar defnext##1{}else letnext=relax fi next}</p>

<p>% Define the framework for environments in texinfo.tex.  It’s used like
this: % %   envdeffoo{…} %   defEfoo{…} % % It’s the responsibility of
envdef to insert begingroup before the % actual body; @end closes the group
after calling Efoo.  envdef also % defines thisenv, so the current
environment is known; @end checks % whether the environment name matches. 
The checkenv macro can also be % used to check whether the current
environment is the one expected. % % Non-false conditionals (@iftex,
@ifset) don’t fit into this, so they % are not treated as enviroments; they
don’t open a group.  (The % implementation of @end takes care not to call
endgroup in this % special case.)</p>

<p>% At runtime, environments start with this:
defstartenvironment#1{begingroupdefthisenv{#1}} % initialize
letthisenvempty</p>

<p>% … but they get defined via “envdeffoo{…}”:
longdefenvdef#1#2{def#1{startenvironment#1#2}}
defenvparseargdef#1#2{parseargdef#1{startenvironment#1#2}}</p>

<p>% Check whether we’re in the right environment: defcheckenv#1{%</p>

<pre>\def\temp{#1}%
\ifx\thisenv\temp
\else
  \badenverr
\fi</pre>

<p>}</p>

<p>% Evironment mismatch, #1 expected: defbadenverr{%</p>

<pre>\errhelp = \EMsimple
\errmessage{This command can appear only \inenvironment\temp,
  not \inenvironment\thisenv}%</pre>

<p>} definenvironment#1{%</p>

<pre>\ifx#1\empty
  out of any environment%
\else
  in environment \expandafter\string#1%
\fi</pre>

<p>}</p>

<p>% @end foo executes the definition of Efoo. % But first, it executes a
specialized version of checkenv % parseargdefend{%</p>

<pre>\if 1\csname iscond.#1\endcsname
\else
  % The general wording of \badenverr may not be ideal, but... --kasal, 06nov03
  \expandafter\checkenv\csname#1\endcsname
  \csname E#1\endcsname
  \endgroup
\fi</pre>

<p>}</p>

<p>newhelpEMsimple{Press RETURN to continue.}</p>

<p>%% Simple single-character @ commands</p>

<p>% @@ prints an @ % Kludge this until the fonts are right (grr).
def@{{ttchar64}}</p>

<p>% This is turned off because it was never documented % and you can use
@w{…} around a quote to suppress ligatures. %% Define @` and @‘ to be the
same as ` and ’ %% but suppressing ligatures. %def`{{`}} %def'{{‘}}</p>

<p>% Used to generate quoted braces. defmylbrace {{ttchar123}} defmyrbrace
{{ttchar125}} let{=mylbrace let}=myrbrace begingroup</p>

<pre>% Definitions to produce \{ and \} commands for indices,
% and @{ and @} for the aux/toc files.
\catcode`\{ = \other \catcode`\} = \other
\catcode`\[ = 1 \catcode`\] = 2
\catcode`\! = 0 \catcode`\\ = \other
!gdef!lbracecmd[\{]%
!gdef!rbracecmd[\}]%
!gdef!lbraceatcmd[@{]%
!gdef!rbraceatcmd[@}]%</pre>

<p>!endgroup</p>

<p>% @comma{} to avoid , parsing problems. letcomma = ,</p>

<p>% Accents: @, @dotaccent @ringaccent @ubaraccent @udotaccent % Others are
defined by plain TeX: @` @‘ @“ @^ @~ @= @u @v @H. let, = c letdotaccent = .
defringaccent#1{{accent23 #1}} lettieaccent = t letubaraccent = b
letudotaccent = d</p>

<p>% Other special characters: @questiondown @exclamdown @ordf @ordm % Plain
TeX defines: @AA @AE @O @OE @L (plus lowercase versions) @ss.
defquestiondown{?`} defexclamdown{!`}
defordf{leavevmoderaise1exhbox{selectfontslllsize underbar{a}}}
defordm{leavevmoderaise1exhbox{selectfontslllsize underbar{o}}}</p>

<p>% Dotless i and dotless j, used for accents. defimacro{i} defjmacro{j}
defdotless#1{%</p>

<pre>\def\temp{#1}%
\ifx\temp\imacro \ptexi
\else\ifx\temp\jmacro \j
\else \errmessage{@dotless can be used only with i or j}%
\fi\fi</pre>

<p>}</p>

<p>% The TeX{} logo, as in plain, but resetting the spacing so that a % period
following counts as ending a sentence.  (Idea found in latex.) %
edefTeX{TeX spacefactor=1000 }</p>

<p>% @LaTeX{} logo.  Not quite the same results as the definition in %
latex.ltx, since we use a different font for the raised A; it’s most %
convenient for us to use an explicitly smaller font, rather than using %
the scriptstyle font (since we don’t reset scriptstyle and %
scriptscriptstyle). % defLaTeX{%</p>

<pre>L\kern-.36em
{\setbox0=\hbox{T}%
 \vbox to \ht0{\hbox{\selectfonts\lllsize A}\vss}}%
\kern-.15em
\TeX</pre>

<p>}</p>

<p>% Be sure we’re in horizontal mode when doing a tie, since we make space %
equivalent to this in @example-like environments. Otherwise, a space % at
the beginning of a line will start with penalty – and % since penalty is
valid in vertical mode, we’d end up putting the % penalty on the vertical
list instead of in the new paragraph. {catcode`@ = 11</p>

<pre>% Avoid using \@M directly, because that causes trouble
% if the definition is written into an index file.
\global\let\tiepenalty = \@M
\gdef\tie{\leavevmode\penalty\tiepenalty\ }</pre>

<p>}</p>

<p>% @: forces normal size whitespace following. def:{spacefactor=1000 }</p>

<p>% @* forces a line break. def*{hfilbreakhbox{}ignorespaces}</p>

<p>% @/ allows a line break. let/=allowbreak</p>

<p>% @. is an end-of-sentence period.
def.{.spacefactor=endofsentencespacefactorspace}</p>

<p>% @! is an end-of-sentence bang.
def!{!spacefactor=endofsentencespacefactorspace}</p>

<p>% @? is an end-of-sentence query.
def?{?spacefactor=endofsentencespacefactorspace}</p>

<p>% @frenchspacing on|off  says whether to put extra space after punctuation.
%  defonword{on} defoffword{off} % parseargdeffrenchspacing{%</p>

<pre>\def\temp{#1}%
\ifx\temp\onword \plainfrenchspacing
\else\ifx\temp\offword \plainnonfrenchspacing
\else
  \errhelp = \EMsimple
  \errmessage{Unknown @frenchspacing option `\temp', must be on/off}%
\fi\fi</pre>

<p>}</p>

<p>% @w prevents a word break.  Without the leavevmode, @w at the % beginning
of a paragraph, when TeX is still in vertical mode, would % produce a whole
line of output instead of starting the paragraph.
defw#1{leavevmodehbox{#1}}</p>

<p>% @group … @end group forces … to be all on one page, by enclosing % it in
a TeX vbox.  We use vtop instead of vbox to construct the box % to keep its
height that of a normal line.  According to the rules for % topskip (p.114
of the TeXbook), the glue inserted is % max (topskip - ht (first item), 0).
If that height is large, % therefore, no glue is inserted, and the space
between the headline and % the text is small, which looks bad. % % Another
complication is that the group might be very large.  This can % cause the
glue on the previous page to be unduly stretched, because it % does not
have much material.  In this case, it’s better to add an % explicit vfill
so that the extra space is at the bottom.  The % threshold for doing this
is if the group is more than vfilllimit % percent of a page (vfilllimit can
be changed inside of @tex). % newboxgroupbox defvfilllimit{0.7} %
envdefgroup{%</p>

<pre>\ifnum\catcode`\^^M=\active \else
  \errhelp = \groupinvalidhelp
  \errmessage{@group invalid in context where filling is enabled}%
\fi
\startsavinginserts
%
\setbox\groupbox = \vtop\bgroup
  % Do @comment since we are called inside an environment such as
  % @example, where each end-of-line in the input causes an
  % end-of-line in the output.  We don't want the end-of-line after
  % the `@group' to put extra space in the output.  Since @group
  % should appear on a line by itself (according to the Texinfo
  % manual), we don't worry about eating any user text.
  \comment</pre>

<p>} % % The vtop produces a box with normal height and large depth; thus, TeX
puts % baselineskip glue before it, and (when the next line of text is
done) % lineskip glue after it.  Thus, space below is not quite equal to
space % above.  But it’s pretty close. defEgroup{%</p>

<pre>  % To get correct interline space between the last line of the group
  % and the first line afterwards, we have to propagate \prevdepth.
  \endgraf % Not \par, as it may have been set to \lisppar.
  \global\dimen1 = \prevdepth
\egroup           % End the \vtop.
% \dimen0 is the vertical size of the group's box.
\dimen0 = \ht\groupbox  \advance\dimen0 by \dp\groupbox
% \dimen2 is how much space is left on the page (more or less).
\dimen2 = \pageheight   \advance\dimen2 by -\pagetotal
% if the group doesn't fit on the current page, and it's a big big
% group, force a page break.
\ifdim \dimen0 &gt; \dimen2
  \ifdim \pagetotal &lt; \vfilllimit\pageheight
    \page
  \fi
\fi
\box\groupbox
\prevdepth = \dimen1
\checkinserts</pre>

<p>} % % TeX puts in an escapechar (i.e., `@‘) at the beginning of the help %
message, so this ends up printing `@group can only …’. %
newhelpgroupinvalidhelp{% group can only be used in environments such as
@example,^^J% where each line of input produces a line of output.}</p>

<p>% @need space-in-mils % forces a page break if there is not space-in-mils
remaining.</p>

<p>newdimenmil  mil=0.001in</p>

<p>% Old definition–didn’t work. %parseargdefneed{par % %% This method tries
to make TeX break the page naturally %% if the depth of the box does not
fit. %{baselineskip=0pt% %vtop to #1mil{vfil}kern -#1milnobreak
%prevdepth=-1000pt %}}</p>

<p>parseargdefneed{%</p>

<pre>% Ensure vertical mode, so we don't make a big box in the middle of a
% paragraph.
\par
%
% If the @need value is less than one line space, it's useless.
\dimen0 = #1\mil
\dimen2 = \ht\strutbox
\advance\dimen2 by \dp\strutbox
\ifdim\dimen0 &gt; \dimen2
  %
  % Do a \strut just to make the height of this box be normal, so the
  % normal leading is inserted relative to the preceding line.
  % And a page break here is fine.
  \vtop to #1\mil{\strut\vfil}%
  %
  % TeX does not even consider page breaks if a penalty added to the
  % main vertical list is 10000 or more.  But in order to see if the
  % empty box we just added fits on the page, we must make it consider
  % page breaks.  On the other hand, we don't want to actually break the
  % page after the empty box.  So we use a penalty of 9999.
  %
  % There is an extremely small chance that TeX will actually break the
  % page at this \penalty, if there are no other feasible breakpoints in
  % sight.  (If the user is using lots of big @group commands, which
  % almost-but-not-quite fill up a page, TeX will have a hard time doing
  % good page breaking, for example.)  However, I could not construct an
  % example where a page broke at this \penalty; if it happens in a real
  % document, then we can reconsider our strategy.
  \penalty9999
  %
  % Back up by the size of the box, whether we did a page break or not.
  \kern -#1\mil
  %
  % Do not allow a page break right after this kern.
  \nobreak
\fi</pre>

<p>}</p>

<p>% @br   forces paragraph break (and is undocumented).</p>

<p>letbr = par</p>

<p>% @page forces the start of a new page. % defpage{parvfillsupereject}</p>

<p>% @exdent text.… % outputs text on separate line in roman font, starting at
standard page margin</p>

<p>% This records the amount of indent in the innermost environment. % That’s
how much exdent should take out. newskipexdentamount</p>

<p>% This defn is used inside fill environments such as @defun.
parseargdefexdent{hfilbreakhbox{kern -exdentamount{rm#1}}hfilbreak}</p>

<p>% This defn is used inside nofill environments such as @example.
parseargdefnofillexdent{{advance leftskip by -exdentamount</p>

<pre>\leftline{\hskip\leftskip{\rm#1}}}}</pre>

<p>% @inmargin{WHICH}{TEXT} puts TEXT in the WHICH margin next to the current
% paragraph.  For more general purposes, use the margin insertion % class. 
WHICH is `l’ or `r’. % newskipinmarginspacing inmarginspacing=1cm
defstrutdepth{dpstrutbox} % defdoinmargin#1#2{strutvadjust{%</p>

<pre>\nobreak
\kern-\strutdepth
\vtop to \strutdepth{%
  \baselineskip=\strutdepth
  \vss
  % if you have multiple lines of stuff to put here, you'll need to
  % make the vbox yourself of the appropriate size.
  \ifx#1l%
    \llap{\ignorespaces #2\hskip\inmarginspacing}%
  \else
    \rlap{\hskip\hsize \hskip\inmarginspacing \ignorespaces #2}%
  \fi
  \null
}%</pre>

<p>}} definleftmargin{doinmargin l} definrightmargin{doinmargin r} % %
@inmargin{TEXT [, RIGHT-TEXT]} % (if RIGHT-TEXT is given, use TEXT for left
page, RIGHT-TEXT for right; % else use TEXT for both). %
definmargin#1{parseinmargin #1,,finish} defparseinmargin#1,#2,#3finish{%
not perfect, but better than nothing.</p>

<pre>\setbox0 = \hbox{\ignorespaces #2}%
\ifdim\wd0 &gt; 0pt
  \def\lefttext{#1}%  have both texts
  \def\righttext{#2}%
\else
  \def\lefttext{#1}%  have only one text
  \def\righttext{#1}%
\fi
%
\ifodd\pageno
  \def\temp{\inrightmargin\righttext}% odd page -&gt; outside is right margin
\else
  \def\temp{\inleftmargin\lefttext}%
\fi
\temp</pre>

<p>}</p>

<p>% @include file    insert text of that file as input. %
definclude{parseargusingfilenamecatcodesincludezzz} defincludezzz#1{%</p>

<pre>\pushthisfilestack
\def\thisfile{#1}%
{%
  \makevalueexpandable
  \def\temp{\input #1 }%
  \expandafter
}\temp
\popthisfilestack</pre>

<p>} deffilenamecatcodes{%</p>

<pre>\catcode`\\=\other
\catcode`~=\other
\catcode`^=\other
\catcode`_=\other
\catcode`|=\other
\catcode`&lt;=\other
\catcode`&gt;=\other
\catcode`+=\other
\catcode`-=\other</pre>

<p>}</p>

<p>defpushthisfilestack{%</p>

<pre>\expandafter\pushthisfilestackX\popthisfilestack\StackTerm</pre>

<p>} defpushthisfilestackX{%</p>

<pre>\expandafter\pushthisfilestackY\thisfile\StackTerm</pre>

<p>} defpushthisfilestackY #1StackTerm #2StackTerm {%</p>

<pre>\gdef\popthisfilestack{\gdef\thisfile{#1}\gdef\popthisfilestack{#2}}%</pre>

<p>}</p>

<p>defpopthisfilestack{errthisfilestackempty}
deferrthisfilestackempty{errmessage{Internal error:</p>

<pre>the stack of filenames is empty.}}</pre>

<p>defthisfile{}</p>

<p>% @center line % outputs that line, centered. % parseargdefcenter{%</p>

<pre>\ifhmode
  \let\next\centerH
\else
  \let\next\centerV
\fi
\next{\hfil \ignorespaces#1\unskip \hfil}%</pre>

<p>} defcenterH#1{%</p>

<pre>{%
  \hfil\break
  \advance\hsize by -\leftskip
  \advance\hsize by -\rightskip
  \line{#1}%
  \break
}%</pre>

<p>} defcenterV#1{line{kernleftskip #1kernrightskip}}</p>

<p>% @sp n   outputs n lines of vertical space</p>

<p>parseargdefsp{vskip #1baselineskip}</p>

<p>% @comment …line which is ignored… % @c is the same as @comment % @ignore …
@end ignore  is another way to write a comment</p>

<p>defcomment{begingroup catcode`^^M=other% catcode`@=other catcode`{=other
catcode`}=other% commentxxx} {catcode`^^M=other
gdefcommentxxx#1^^M{endgroup}}</p>

<p>letc=comment</p>

<p>% @paragraphindent NCHARS % We’ll use ems for NCHARS, close enough. %
NCHARS can also be the word `asis’ or `none’. % We cannot feasibly
implement @paragraphindent asis, though. % defasisword{asis} % no
translation, these are keywords defnoneword{none} %
parseargdefparagraphindent{%</p>

<pre>\def\temp{#1}%
\ifx\temp\asisword
\else
  \ifx\temp\noneword
    \defaultparindent = 0pt
  \else
    \defaultparindent = #1em
  \fi
\fi
\parindent = \defaultparindent</pre>

<p>}</p>

<p>% @exampleindent NCHARS % We’ll use ems for NCHARS like @paragraphindent. %
It seems @exampleindent asis isn’t necessary, but % I preserve it to make
it similar to @paragraphindent. parseargdefexampleindent{%</p>

<pre>\def\temp{#1}%
\ifx\temp\asisword
\else
  \ifx\temp\noneword
    \lispnarrowing = 0pt
  \else
    \lispnarrowing = #1em
  \fi
\fi</pre>

<p>}</p>

<p>% @firstparagraphindent WORD % If WORD is `none’, then suppress indentation
of the first paragraph % after a section heading.  If WORD is `insert’,
then do indent at such % paragraphs. % % The paragraph indentation is
suppressed or not by calling % suppressfirstparagraphindent, which the
sectioning commands do. % We switch the definition of this back and forth
according to WORD. % By default, we suppress indentation. %
defsuppressfirstparagraphindent{dosuppressfirstparagraphindent}
definsertword{insert} % parseargdeffirstparagraphindent{%</p>

<pre>\def\temp{#1}%
\ifx\temp\noneword
  \let\suppressfirstparagraphindent = \dosuppressfirstparagraphindent
\else\ifx\temp\insertword
  \let\suppressfirstparagraphindent = \relax
\else
  \errhelp = \EMsimple
  \errmessage{Unknown @firstparagraphindent option `\temp'}%
\fi\fi</pre>

<p>}</p>

<p>% Here is how we actually suppress indentation.  Redefine everypar to %
kern backwards by parindent, and then reset itself to empty. % % We also
make indent itself not actually do anything until the next % paragraph. %
gdefdosuppressfirstparagraphindent{%</p>

<pre>\gdef\indent{%
  \restorefirstparagraphindent
  \indent
}%
\gdef\noindent{%
  \restorefirstparagraphindent
  \noindent
}%
\global\everypar = {%
  \kern -\parindent
  \restorefirstparagraphindent
}%</pre>

<p>}</p>

<p>gdefrestorefirstparagraphindent{%</p>

<pre>\global \let \indent = \ptexindent
\global \let \noindent = \ptexnoindent
\global \everypar = {}%</pre>

<p>}</p>

<p>% @asis just yields its argument.  Used with @table, for example. %
defasis#1{#1}</p>

<p>% @math outputs its argument in math mode. % % One complication: _ usually
means subscripts, but it could also mean % an actual _ character, as in
@math{@var{some_variable} + 1}.  So make % _ active, and distinguish by
seeing if the current family is slfam, % which is what @var uses. {</p>

<pre>\catcode\underChar = \active
\gdef\mathunderscore{%
  \catcode\underChar=\active
  \def_{\ifnum\fam=\slfam \_\else\sb\fi}%
}</pre>

<p>} % Another complication: we want \ (and @) to output a \ character. % FYI,
plain.tex uses \ as a temporary control sequence (why?), but % this is not
advertised and we don’t care.  Texinfo does not % otherwise define @. % %
The mathchar is class=0=ordinary, family=7=ttfam, position=5C=.
defmathbackslash{ifnumfam=ttfam mathchar“075C elsebackslash fi} % defmath{%</p>

<pre>\tex
\mathunderscore
\let\\ = \mathbackslash
\mathactive
$\finishmath</pre>

<p>} deffinishmath#1{#1$endgroup}  % Close the group opened by tex.</p>

<p>% Some active characters (such as &lt;) are spaced differently in math. %
We have to reset their definitions in case the @math was an argument % to a
command which sets the catcodes (such as @item or @section). % {</p>

<pre>\catcode`^ = \active
\catcode`&lt; = \active
\catcode`&gt; = \active
\catcode`+ = \active
\gdef\mathactive{%
  \let^ = \ptexhat
  \let&lt; = \ptexless
  \let&gt; = \ptexgtr
  \let+ = \ptexplus
}</pre>

<p>}</p>

<p>% @bullet and @minus need the same treatment as @math, just above.
defbullet{$ptexbullet$} defminus{$-$}</p>

<p>% @dots{} outputs an ellipsis using the current font. % We do .5em per
period so that it has the same spacing in a typewriter % font as three
actual period characters. % defdots{%</p>

<pre>\leavevmode
\hbox to 1.5em{%
  \hskip 0pt plus 0.25fil
  .\hfil.\hfil.%
  \hskip 0pt plus 0.5fil
}%</pre>

<p>}</p>

<p>% @enddots{} is an end-of-sentence ellipsis. % defenddots{%</p>

<pre>\dots
\spacefactor=\endofsentencespacefactor</pre>

<p>}</p>

<p>% @comma{} is so commas can be inserted into text without messing up %
Texinfo’s parsing. % letcomma = ,</p>

<p>% @refill is a no-op. letrefill=relax</p>

<p>% If working on a large document in chapters, it is convenient to % be able
to disable indexing, cross-referencing, and contents, for test runs. % This
is done with @novalidate (before @setfilename). % newififlinks linkstrue %
by default we want the aux files. letnovalidate = linksfalse</p>

<p>% @setfilename is done at the beginning of every texinfo file. % So open
here the files we need to have open while reading the input. % This makes
it possible to make a .fmt file for texinfo. defsetfilename{%</p>

<pre>\fixbackslash  % Turn off hack to swallow `\input texinfo'.
\iflinks
  \tryauxfile
  % Open the new aux file.  TeX will close it automatically at exit.
  \immediate\openout\auxfile=\jobname.aux
\fi % \openindices needs to do some work in any case.
\openindices
\let\setfilename=\comment % Ignore extra @setfilename cmds.
%
% If texinfo.cnf is present on the system, read it.
% Useful for site-wide @afourpaper, etc.
\openin 1 texinfo.cnf
\ifeof 1 \else \input texinfo.cnf \fi
\closein 1
%
\comment % Ignore the actual filename.</pre>

<p>}</p>

<p>% Called from setfilename. % defopenindices{%</p>

<pre>\newindex{cp}%
\newcodeindex{fn}%
\newcodeindex{vr}%
\newcodeindex{tp}%
\newcodeindex{ky}%
\newcodeindex{pg}%</pre>

<p>}</p>

<p>% @bye. outerdefbye{pagealignmacrotracingstats=1ptexend}</p>

<p>message{pdf,} % adobe `portable’ document format newcounttempnum
newcountlnkcount newtoksfilename newcountfilenamelength newcountpgn
newtokstoksA newtokstoksB newtokstoksC newtokstoksD newboxboxA
newcountcountA newififpdf newififpdfmakepagedest</p>

<p>% when pdftex is run in dvi mode, pdfoutput is defined (so pdfoutput=1 %
can be set).  So we test for relax and 0 as well as undefined, % borrowed
from ifpdf.sty. ifxpdfoutputundefined else</p>

<pre>\ifx\pdfoutput\relax
\else
  \ifcase\pdfoutput
  \else
    \pdftrue
  \fi
\fi</pre>

<p>fi</p>

<p>% PDF uses PostScript string constants for the names of xref targets, to %
for display in the outlines, and in other places.  Thus, we have to %
double any backslashes.  Otherwise, a name like “node” will be %
interpreted as a newline (n), followed by o, d, e.  Not good. % <a
href="http://www.ntg.nl/pipermail/ntg-pdftex/2004-July/000654.html">www.ntg.nl/pipermail/ntg-pdftex/2004-July/000654.html</a>
% (and related messages, the final outcome is that it is up to the TeX %
user to double the backslashes and otherwise make the string valid, so %
that’s we do).</p>

<p>% double active backslashes. %  {catcode`@=0 catcode`\=active</p>

<pre>@gdef@activebackslash{@catcode`@\=@active @otherbackslash}
@gdef@activebackslashdouble{%
  @catcode@backChar=@active
  @let\=@doublebackslash}</pre>

<p>}</p>

<p>% To handle parens, we must adopt a different approach, since parens are %
not active characters.  hyperref.dtx (which has the same problem as % us)
handles it with this amazing macro to replace tokens.  I’ve % tinkered with
it a little for texinfo, but it’s definitely from there. %  % #1 is the
tokens to replace. % #2 is the replacement. % #3 is the control sequence
with the string. %  defHyPsdSubst#1#2#3{%</p>

<pre>\def\HyPsdReplace##1#1##2\END{%
  ##1%
  \ifx\\##2\\%
  \else
    #2%
    \HyReturnAfterFi{%
      \HyPsdReplace##2\END
    }%
  \fi
}%
\xdef#3{\expandafter\HyPsdReplace#3#1\END}%</pre>

<p>} longdefHyReturnAfterFi#1fi{fi#1}</p>

<p>% #1 is a control sequence in which to do the replacements.
defbackslashparens#1{%</p>

<pre>\xdef#1{#1}% redefine it as its expansion; the definition is simply
           % \lastnode when called from \setref -&gt; \pdfmkdest.
\HyPsdSubst{(}{\backslashlparen}{#1}%
\HyPsdSubst{)}{\backslashrparen}{#1}%</pre>

<p>}</p>

<p>{catcodeexclamChar = 0 catcodebackChar = other</p>

<pre>!gdef!backslashlparen{\(}%
!gdef!backslashrparen{\)}%</pre>

<p>}</p>

<p>ifpdf</p>

<pre class="ruby">\<span class="ruby-identifier">input</span> <span class="ruby-identifier">pdfcolor</span>
\<span class="ruby-identifier">pdfcatalog</span>{<span class="ruby-regexp">/PageMode /</span><span class="ruby-constant">UseOutlines</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">dopdfimage</span><span class="ruby-comment">#1#2#3{%</span>
  \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">imagewidth</span>{<span class="ruby-comment">#2}%</span>
  \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">imageheight</span>{<span class="ruby-comment">#3}%</span>
  <span class="ruby-string">%Qwithout </span>\<span class="ruby-identifier">immediate</span>, <span class="ruby-identifier">pdftex</span> <span class="ruby-identifier">seg</span> <span class="ruby-identifier">faults</span> <span class="ruby-keyword">when</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">same</span> <span class="ruby-identifier">image</span> <span class="ruby-identifier">is</span>
  <span class="ruby-string">%Qincluded </span><span class="ruby-identifier">twice</span>.  (<span class="ruby-constant">Version</span> <span class="ruby-value">3.14159</span><span class="ruby-operator">-</span><span class="ruby-identifier">pre</span><span class="ruby-operator">-</span><span class="ruby-value">1.0</span><span class="ruby-operator">-</span><span class="ruby-identifier">unofficial</span><span class="ruby-operator">-</span><span class="ruby-value">20010704</span>.)
  \<span class="ruby-identifier">ifnum</span>\<span class="ruby-identifier">pdftexversion</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">14</span>
    \<span class="ruby-identifier">immediate</span>\<span class="ruby-identifier">pdfimage</span>
  \<span class="ruby-keyword">else</span>
    \<span class="ruby-identifier">immediate</span>\<span class="ruby-identifier">pdfximage</span>
  \<span class="ruby-identifier">fi</span>
    \<span class="ruby-identifier">ifx</span>\<span class="ruby-identifier">empty</span>\<span class="ruby-identifier">imagewidth</span>\<span class="ruby-keyword">else</span> <span class="ruby-identifier">width</span> \<span class="ruby-identifier">imagewidth</span> \<span class="ruby-identifier">fi</span>
    \<span class="ruby-identifier">ifx</span>\<span class="ruby-identifier">empty</span>\<span class="ruby-identifier">imageheight</span>\<span class="ruby-keyword">else</span> <span class="ruby-identifier">height</span> \<span class="ruby-identifier">imageheight</span> \<span class="ruby-identifier">fi</span>
    \<span class="ruby-identifier">ifnum</span>\<span class="ruby-identifier">pdftexversion</span><span class="ruby-operator">&lt;</span><span class="ruby-value">13</span>
       <span class="ruby-comment">#1.pdf%</span>
     \<span class="ruby-keyword">else</span>
       {<span class="ruby-comment">#1.pdf}%</span>
     \<span class="ruby-identifier">fi</span>
  \<span class="ruby-identifier">ifnum</span>\<span class="ruby-identifier">pdftexversion</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">14</span> \<span class="ruby-keyword">else</span>
    \<span class="ruby-identifier">pdfrefximage</span> \<span class="ruby-identifier">pdflastximage</span>
  \<span class="ruby-identifier">fi</span>}
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">pdfmkdest</span><span class="ruby-comment">#1{{%</span>
  <span class="ruby-string">%QWe </span><span class="ruby-identifier">have</span> <span class="ruby-identifier">to</span> <span class="ruby-identifier">set</span> <span class="ruby-identifier">dummies</span> <span class="ruby-identifier">so</span> <span class="ruby-identifier">commands</span> <span class="ruby-identifier">such</span> <span class="ruby-identifier">as</span> <span class="ruby-ivar">@code</span>, <span class="ruby-keyword">and</span> <span class="ruby-identifier">characters</span>
  <span class="ruby-string">%Qsuch </span><span class="ruby-identifier">as</span> \, <span class="ruby-identifier">aren</span><span class="ruby-string">'t expanded when present in a section title.
  \atdummies
  \activebackslashdouble
  \def\pdfdestname{#1}%
  \backslashparens\pdfdestname
  \pdfdest name{\pdfdestname} xyz%
}}%
%
% used to mark target names; must be expandable.
\def\pdfmkpgn#1{#1}%
%
\let\linkcolor = \Blue  % was Cyan, but that seems light?
\def\endlink{\Black\pdfendlink}
% Adding outlines to PDF; macros for calculating structure of outlines
% come from Petr Olsak
\def\expnumber#1{\expandafter\ifx\csname#1\endcsname\relax 0%
  \else \csname#1\endcsname \fi}
\def\advancenumber#1{\tempnum=\expnumber{#1}\relax
  \advance\tempnum by 1
  \expandafter\xdef\csname#1\endcsname{\the\tempnum}}
%
% #1 is the section text, which is what will be displayed in the
% outline by the pdf viewer.  #2 is the pdf expression for the number
% of subentries (or empty, for subsubsections).  #3 is the node text,
% which might be empty if this toc entry had no corresponding node.
% #4 is the page number
%
\def\dopdfoutline#1#2#3#4{%
  % Generate a link to the node text if that exists; else, use the
  % page number.  We could generate a destination for the section
  % text in the case where a section has no node, but it doesn'</span><span class="ruby-identifier">t</span>
  <span class="ruby-string">%Qseem </span><span class="ruby-identifier">worth</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">trouble</span>, <span class="ruby-identifier">since</span> <span class="ruby-identifier">most</span> <span class="ruby-identifier">documents</span> <span class="ruby-identifier">are</span> <span class="ruby-identifier">normally</span> <span class="ruby-identifier">structured</span>.
  \<span class="ruby-identifier">def</span>\<span class="ruby-identifier">pdfoutlinedest</span>{<span class="ruby-comment">#3}%</span>
  \<span class="ruby-identifier">ifx</span>\<span class="ruby-identifier">pdfoutlinedest</span>\<span class="ruby-identifier">empty</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">pdfoutlinedest</span>{<span class="ruby-comment">#4}%</span>
  \<span class="ruby-keyword">else</span>
    <span class="ruby-string">%QDoubled </span><span class="ruby-identifier">backslashes</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">name</span>.
    {\<span class="ruby-identifier">activebackslashdouble</span> \<span class="ruby-identifier">xdef</span>\<span class="ruby-identifier">pdfoutlinedest</span>{<span class="ruby-comment">#3}%</span>
     \<span class="ruby-identifier">backslashparens</span>\<span class="ruby-identifier">pdfoutlinedest</span>}<span class="ruby-operator">%</span>
  \<span class="ruby-identifier">fi</span>
  <span class="ruby-string">%Q  % Also double the backslashes in the display string.
</span>  {\<span class="ruby-identifier">activebackslashdouble</span> \<span class="ruby-identifier">xdef</span>\<span class="ruby-identifier">pdfoutlinetext</span>{<span class="ruby-comment">#1}%</span>
   \<span class="ruby-identifier">backslashparens</span>\<span class="ruby-identifier">pdfoutlinetext</span>}<span class="ruby-operator">%</span>
  <span class="ruby-node">%Q  \pdfoutline goto name{\pdfmkpgn{\pdfoutlinedest}}#2{\pdfoutlinetext}%
</span>}
<span class="ruby-string">%Q\def\pdfmakeoutlines{%
</span>  \<span class="ruby-identifier">begingroup</span>
    <span class="ruby-string">%QThanh's </span><span class="ruby-identifier">hack</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">proper</span> <span class="ruby-identifier">braces</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">bookmarks</span>
    \<span class="ruby-identifier">edef</span>\<span class="ruby-identifier">mylbrace</span>{\<span class="ruby-identifier">iftrue</span> \<span class="ruby-identifier">string</span>{\<span class="ruby-keyword">else</span>}\<span class="ruby-identifier">fi</span>}\<span class="ruby-identifier">let</span>\{=\<span class="ruby-identifier">mylbrace</span>
    \<span class="ruby-identifier">edef</span>\<span class="ruby-identifier">myrbrace</span>{\<span class="ruby-identifier">iffalse</span>{\<span class="ruby-keyword">else</span>\<span class="ruby-identifier">string</span>}\<span class="ruby-identifier">fi</span>}\<span class="ruby-identifier">let</span>\}=\<span class="ruby-identifier">myrbrace</span>
    <span class="ruby-string">%Q    % Read toc silently, to get counts of subentries for \pdfoutline.
</span>    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">numchapentry</span><span class="ruby-comment">##1##2##3##4{%</span>
      \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">thischapnum</span>{<span class="ruby-comment">##2}%</span>
      \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">thissecnum</span>{<span class="ruby-value">0</span>}<span class="ruby-operator">%</span>
      \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">thissubsecnum</span>{<span class="ruby-value">0</span>}<span class="ruby-operator">%</span>
    }<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">numsecentry</span><span class="ruby-comment">##1##2##3##4{%</span>
      \<span class="ruby-identifier">advancenumber</span>{<span class="ruby-identifier">chap</span>\<span class="ruby-identifier">thischapnum</span>}<span class="ruby-operator">%</span>
      \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">thissecnum</span>{<span class="ruby-comment">##2}%</span>
      \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">thissubsecnum</span>{<span class="ruby-value">0</span>}<span class="ruby-operator">%</span>
    }<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">numsubsecentry</span><span class="ruby-comment">##1##2##3##4{%</span>
      \<span class="ruby-identifier">advancenumber</span>{<span class="ruby-identifier">sec</span>\<span class="ruby-identifier">thissecnum</span>}<span class="ruby-operator">%</span>
      \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">thissubsecnum</span>{<span class="ruby-comment">##2}%</span>
    }<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">numsubsubsecentry</span><span class="ruby-comment">##1##2##3##4{%</span>
      \<span class="ruby-identifier">advancenumber</span>{<span class="ruby-identifier">subsec</span>\<span class="ruby-identifier">thissubsecnum</span>}<span class="ruby-operator">%</span>
    }<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">thischapnum</span>{<span class="ruby-value">0</span>}<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">thissecnum</span>{<span class="ruby-value">0</span>}<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">thissubsecnum</span>{<span class="ruby-value">0</span>}<span class="ruby-operator">%</span>
    <span class="ruby-string">%Q    % use \def rather than \let here because we redefine \capentry et
</span>    <span class="ruby-operator">%</span> <span class="ruby-identifier">al</span>. <span class="ruby-identifier">a</span> <span class="ruby-identifier">second</span> <span class="ruby-identifier">time</span>, <span class="ruby-identifier">below</span>.
    \<span class="ruby-identifier">def</span>\<span class="ruby-identifier">appentry</span>{\<span class="ruby-identifier">numchapentry</span>}<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">appsecentry</span>{\<span class="ruby-identifier">numsecentry</span>}<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">appsubsecentry</span>{\<span class="ruby-identifier">numsubsecentry</span>}<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">appsubsubsecentry</span>{\<span class="ruby-identifier">numsubsubsecentry</span>}<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">unnchapentry</span>{\<span class="ruby-identifier">numchapentry</span>}<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">unnsecentry</span>{\<span class="ruby-identifier">numsecentry</span>}<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">unnsubsecentry</span>{\<span class="ruby-identifier">numsubsecentry</span>}<span class="ruby-operator">%</span>
    \<span class="ruby-keyword">def</span>\<span class="ruby-identifier">unnsubsubsecentry</span>{\<span class="ruby-identifier">numsubsubsecentry</span>}<span class="ruby-operator">%</span>
    \<span class="ruby-identifier">readdatafile</span>{<span class="ruby-identifier">toc</span>}<span class="ruby-operator">%</span>
    <span class="ruby-string">%Q    % Read toc second time, this time actually producing the outlines.
</span>    <span class="ruby-operator">%</span> <span class="ruby-constant">The</span> <span class="ruby-node">%x-' means take the \expnumber as the absolute number of
    % subentries, which we calculated on our first read of the .toc above.
    %
    % We use the node names as the destinations.
    \def\numchapentry##1##2##3##4{%
      \dopdfoutline{##1}{count-\expnumber{chap##2}}{##3}{##4}}%
    \def\numsecentry##1##2##3##4{%
      \dopdfoutline{##1}{count-\expnumber{sec##2}}{##3}{##4}}%
    \def\numsubsecentry##1##2##3##4{%
      \dopdfoutline{##1}{count-\expnumber{subsec##2}}{##3}{##4}}%
    \def\numsubsubsecentry##1##2##3##4{% count is always zero
      \dopdfoutline{##1}{}{##3}{##4}}%
    %
    % PDF outlines are displayed using system fonts, instead of
    % document fonts.  Therefore we cannot use special characters,
    % since the encoding is unknown.  For example, the eogonek from
    % Latin 2 (0xea) gets translated to a | character.  Info from
    % Staszek Wawrykiewicz, 19 Jan 2004 04:09:24 +0100.
    %
    % xx to do this right, we have to translate 8-bit characters to
    % their &quot;best&quot; equivalent, based on the @documentencoding.  Right
    % now, I guess we'll just let the pdf reader have its way.
    \indexnofonts
    \setupdatafile
    \activebackslash
    \input \jobname.toc
  \endgroup
}
%
\def\skipspaces#1{\def\PP{#1}\def\D{|}%
  \ifx\PP\D\let\nextsp\relax
  \else\let\nextsp\skipspaces
    \ifx\p\space\else\addtokens{\filename}{\PP}%
      \advance\filenamelength by 1
    \fi
  \fi
  \nextsp}
\def\getfilename#1{\filenamelength=0\expandafter\skipspaces#1|\relax}
\ifnum\pdftexversion &lt; 14
  \let \startlink \pdfannotlink
\else
  \let \startlink \pdfstartlink
\fi
\def\pdfurl#1{%
  \begingroup
    \normalturnoffactive\def\@{@}%
    \makevalueexpandable
    \leavevmode\Red
    \startlink attr{/Border [0 0 0]}%
      user{/Subtype /Link /A &lt;&lt; /S /URI /URI (#1) &gt;&gt;}%
  \endgroup}
\def\pdfgettoks#1.{\setbox\boxA=\hbox{\toksA={#1.}\toksB={}\maketoks}}
\def\addtokens#1#2{\edef\addtoks{\noexpand#1={\the#1#2}}\addtoks}
\def\adn#1{\addtokens{\toksC}{#1}\global\cuntA=1\let\next=\maketoks}
\def\poptoks#1#2|ENDTOKS|{\let\first=#1\toksD={#1}\toksA={#2}}
\def\maketoks{%
  \expandafter\poptoks\the\toksA|ENDTOKS|\relax
  \ifx\first0\adn0
  \else\ifx\first1\adn1 \else\ifx\first2\adn2 \else\ifx\first3\adn3
  \else\ifx\first4\adn4 \else\ifx\first5\adn5 \else\ifx\first6\adn6
  \else\ifx\first7\adn7 \else\ifx\first8\adn8 \else\ifx\first9\adn9
  \else
    \ifnum0=\cuntA\else\makelink\fi
    \ifx\first.\let\next=\done\else
      \let\next=\maketoks
      \addtokens{\toksB}{\the\toksD}
      \ifx\first,\addtokens{\toksB}{\space}\fi
    \fi
  \fi\fi\fi\fi\fi\fi\fi\fi\fi\fi
  \next}
\def\makelink{\addtokens{\toksB}%
  {\noexpand\pdflink{\the\toksC}}\toksC={}\global\cuntA=0}
\def\pdflink#1{%
  \startlink attr{/Border [0 0 0]} goto name{\pdfmkpgn{#1}}
  \linkcolor #1\endlink}
\def\done{\edef\st{\global\noexpand\toksA={\the\toksB}}\st}
</span></pre>

<p>else</p>

<pre>\let\pdfmkdest = \gobble
\let\pdfurl = \gobble
\let\endlink = \relax
\let\linkcolor = \relax
\let\pdfmakeoutlines = \relax</pre>

<p>fi  % ifxpdfoutput</p>

<p>message{fonts,}</p>

<p>% Change the current font style to #1, remembering it in curfontstyle. %
For now, we do not accumulate font styles: @b{@i{foo}} prints foo in %
italics, not bold italics. % defsetfontstyle#1{%</p>

<pre>\def\curfontstyle{#1}% not as a control sequence, because we are \edef'd.
\csname ten#1\endcsname  % change the current font</pre>

<p>}</p>

<p>% Select #1 fonts with the current style. % defselectfonts#1{csname
#1fontsendcsname csnamecurfontstyleendcsname}</p>

<p>defrm{fam=0 setfontstyle{rm}} defit{fam=itfam setfontstyle{it}}
defsl{fam=slfam setfontstyle{sl}} defbf{fam=bffam
setfontstyle{bf}}defbfstylename{bf} deftt{fam=ttfam setfontstyle{tt}}</p>

<p>% Texinfo sort of supports the sans serif font style, which plain TeX does
not. % So we set up a sf. newfamsffam defsf{fam=sffam setfontstyle{sf}}
letli = sf % Sometimes we call it li, not sf.</p>

<p>% We don’t need math for this font style. defttsl{setfontstyle{ttsl}}</p>

<p>% Default leading. newdimentextleading  textleading = 13.2pt</p>

<p>% Set the baselineskip to #1, and the lineskip and strut size %
correspondingly.  There is no deep meaning behind these magic numbers %
used as factors; they just match (closely enough) what Knuth defined. %
deflineskipfactor{.08333} defstrutheightpercent{.70833}
defstrutdepthpercent {.29167} % defsetleading#1{%</p>

<pre>\normalbaselineskip = #1\relax
\normallineskip = \lineskipfactor\normalbaselineskip
\normalbaselines
\setbox\strutbox =\hbox{%
  \vrule width0pt height\strutheightpercent\baselineskip
                  depth \strutdepthpercent \baselineskip
}%</pre>

<p>}</p>

<p>% Set the font macro #1 to the font named #2, adding on the % specified
font prefix (normally `cm’). % #3 is the font’s design size, #4 is a scale
factor defsetfont#1#2#3#4{font#1=fontprefix#2#3 scaled #4}</p>

<p>% Use cm as the default font prefix. % To specify the font prefix, you must
define fontprefix % before you read in texinfo.tex. ifxfontprefixundefined
deffontprefix{cm} fi % Support font families that don’t use the same naming
scheme as CM. defrmshape{r} defrmbshape{bx}               %where the normal
face is bold defbfshape{b} defbxshape{bx} defttshape{tt} defttbshape{tt}
defttslshape{sltt} defitshape{ti} defitbshape{bxti} defslshape{sl}
defslbshape{bxsl} defsfshape{ss} defsfbshape{ss} defscshape{csc}
defscbshape{csc}</p>

<p>% Text fonts (11.2pt, magstep1). deftextnominalsize{11pt}
edefmainmagstep{magstephalf} setfonttextrmrmshape{10}{mainmagstep}
setfonttextttttshape{10}{mainmagstep} setfonttextbfbfshape{10}{mainmagstep}
setfonttextititshape{10}{mainmagstep} setfonttextslslshape{10}{mainmagstep}
setfonttextsfsfshape{10}{mainmagstep} setfonttextscscshape{10}{mainmagstep}
setfonttextttslttslshape{10}{mainmagstep} fonttexti=cmmi10 scaled
mainmagstep fonttextsy=cmsy10 scaled mainmagstep</p>

<p>% A few fonts for @defun names and args. setfontdefbfbfshape{10}{magstep1}
setfontdefttttshape{10}{magstep1} setfontdefttslttslshape{10}{magstep1}
defdf{lettentt=deftt lettenbf = defbf lettenttsl=defttsl bf}</p>

<p>% Fonts for indices, footnotes, small examples (9pt).
defsmallnominalsize{9pt} setfontsmallrmrmshape{9}{1000}
setfontsmallttttshape{9}{1000} setfontsmallbfbfshape{10}{900}
setfontsmallititshape{9}{1000} setfontsmallslslshape{9}{1000}
setfontsmallsfsfshape{9}{1000} setfontsmallscscshape{10}{900}
setfontsmallttslttslshape{10}{900} fontsmalli=cmmi9 fontsmallsy=cmsy9</p>

<p>% Fonts for small examples (8pt). defsmallernominalsize{8pt}
setfontsmallerrmrmshape{8}{1000} setfontsmallerttttshape{8}{1000}
setfontsmallerbfbfshape{10}{800} setfontsmallerititshape{8}{1000}
setfontsmallerslslshape{8}{1000} setfontsmallersfsfshape{8}{1000}
setfontsmallerscscshape{10}{800} setfontsmallerttslttslshape{10}{800}
fontsmalleri=cmmi8 fontsmallersy=cmsy8</p>

<p>% Fonts for title page (20.4pt): deftitlenominalsize{20pt}
setfonttitlermrmbshape{12}{magstep3} setfonttitleititbshape{10}{magstep4}
setfonttitleslslbshape{10}{magstep4} setfonttitlettttbshape{12}{magstep3}
setfonttitlettslttslshape{10}{magstep4}
setfonttitlesfsfbshape{17}{magstep1} lettitlebf=titlerm
setfonttitlescscbshape{10}{magstep4} fonttitlei=cmmi12 scaled magstep3
fonttitlesy=cmsy10 scaled magstep4 defauthorrm{secrm} defauthortt{sectt}</p>

<p>% Chapter (and unnumbered) fonts (17.28pt). defchapnominalsize{17pt}
setfontchaprmrmbshape{12}{magstep2} setfontchapititbshape{10}{magstep3}
setfontchapslslbshape{10}{magstep3} setfontchapttttbshape{12}{magstep2}
setfontchapttslttslshape{10}{magstep3} setfontchapsfsfbshape{17}{1000}
letchapbf=chaprm setfontchapscscbshape{10}{magstep3} fontchapi=cmmi12
scaled magstep2 fontchapsy=cmsy10 scaled magstep3</p>

<p>% Section fonts (14.4pt). defsecnominalsize{14pt}
setfontsecrmrmbshape{12}{magstep1} setfontsecititbshape{10}{magstep2}
setfontsecslslbshape{10}{magstep2} setfontsecttttbshape{12}{magstep1}
setfontsecttslttslshape{10}{magstep2} setfontsecsfsfbshape{12}{magstep1}
letsecbfsecrm setfontsecscscbshape{10}{magstep2} fontseci=cmmi12 scaled
magstep1 fontsecsy=cmsy10 scaled magstep2</p>

<p>% Subsection fonts (13.15pt). defssecnominalsize{13pt}
setfontssecrmrmbshape{12}{magstephalf} setfontssecititbshape{10}{1315}
setfontssecslslbshape{10}{1315} setfontssecttttbshape{12}{magstephalf}
setfontssecttslttslshape{10}{1315} setfontssecsfsfbshape{12}{magstephalf}
letssecbfssecrm setfontssecscscbshape{10}{1315} fontsseci=cmmi12 scaled
magstephalf fontssecsy=cmsy10 scaled 1315</p>

<p>% Reduced fonts for @acro in text (10pt). defreducednominalsize{10pt}
setfontreducedrmrmshape{10}{1000} setfontreducedttttshape{10}{1000}
setfontreducedbfbfshape{10}{1000} setfontreducedititshape{10}{1000}
setfontreducedslslshape{10}{1000} setfontreducedsfsfshape{10}{1000}
setfontreducedscscshape{10}{1000} setfontreducedttslttslshape{10}{1000}
fontreducedi=cmmi10 fontreducedsy=cmsy10</p>

<p>% In order for the font changes to affect most math symbols and letters, %
we have to define the textfont of the standard families.  Since % texinfo
doesn’t allow for producing subscripts and superscripts except % in the
main text, we don’t bother to reset scriptfont and % scriptscriptfont
(which would also require loading a lot more fonts). % defresetmathfonts{%</p>

<pre>\textfont0=\tenrm \textfont1=\teni \textfont2=\tensy
\textfont\itfam=\tenit \textfont\slfam=\tensl \textfont\bffam=\tenbf
\textfont\ttfam=\tentt \textfont\sffam=\tensf</pre>

<p>}</p>

<p>% The font-changing commands redefine the meanings of tenSTYLE, instead %
of just STYLE.  We do this because STYLE needs to also set the % current
fam for math mode.  Our STYLE (e.g., rm) commands hardwire % tenSTYLE to
set the current font. % % Each font-changing command also sets the names
lsize (one size lower) % and lllsize (three sizes lower).  These relative
commands are used in % the LaTeX logo and acronyms. % % This all needs
generalizing, badly. % deftextfonts{%</p>

<pre>\let\tenrm=\textrm \let\tenit=\textit \let\tensl=\textsl
\let\tenbf=\textbf \let\tentt=\texttt \let\smallcaps=\textsc
\let\tensf=\textsf \let\teni=\texti \let\tensy=\textsy
\let\tenttsl=\textttsl
\def\curfontsize{text}%
\def\lsize{reduced}\def\lllsize{smaller}%
\resetmathfonts \setleading{\textleading}}</pre>

<p>deftitlefonts{%</p>

<pre>\let\tenrm=\titlerm \let\tenit=\titleit \let\tensl=\titlesl
\let\tenbf=\titlebf \let\tentt=\titlett \let\smallcaps=\titlesc
\let\tensf=\titlesf \let\teni=\titlei \let\tensy=\titlesy
\let\tenttsl=\titlettsl
\def\curfontsize{title}%
\def\lsize{chap}\def\lllsize{subsec}%
\resetmathfonts \setleading{25pt}}</pre>

<p>deftitlefont#1{{titlefontsrm #1}} defchapfonts{%</p>

<pre>\let\tenrm=\chaprm \let\tenit=\chapit \let\tensl=\chapsl
\let\tenbf=\chapbf \let\tentt=\chaptt \let\smallcaps=\chapsc
\let\tensf=\chapsf \let\teni=\chapi \let\tensy=\chapsy
\let\tenttsl=\chapttsl
\def\curfontsize{chap}%
\def\lsize{sec}\def\lllsize{text}%
\resetmathfonts \setleading{19pt}}</pre>

<p>defsecfonts{%</p>

<pre>\let\tenrm=\secrm \let\tenit=\secit \let\tensl=\secsl
\let\tenbf=\secbf \let\tentt=\sectt \let\smallcaps=\secsc
\let\tensf=\secsf \let\teni=\seci \let\tensy=\secsy
\let\tenttsl=\secttsl
\def\curfontsize{sec}%
\def\lsize{subsec}\def\lllsize{reduced}%
\resetmathfonts \setleading{16pt}}</pre>

<p>defsubsecfonts{%</p>

<pre>\let\tenrm=\ssecrm \let\tenit=\ssecit \let\tensl=\ssecsl
\let\tenbf=\ssecbf \let\tentt=\ssectt \let\smallcaps=\ssecsc
\let\tensf=\ssecsf \let\teni=\sseci \let\tensy=\ssecsy
\let\tenttsl=\ssecttsl
\def\curfontsize{ssec}%
\def\lsize{text}\def\lllsize{small}%
\resetmathfonts \setleading{15pt}}</pre>

<p>letsubsubsecfonts = subsecfonts defreducedfonts{%</p>

<pre>\let\tenrm=\reducedrm \let\tenit=\reducedit \let\tensl=\reducedsl
\let\tenbf=\reducedbf \let\tentt=\reducedtt \let\reducedcaps=\reducedsc
\let\tensf=\reducedsf \let\teni=\reducedi \let\tensy=\reducedsy
\let\tenttsl=\reducedttsl
\def\curfontsize{reduced}%
\def\lsize{small}\def\lllsize{smaller}%
\resetmathfonts \setleading{10.5pt}}</pre>

<p>defsmallfonts{%</p>

<pre>\let\tenrm=\smallrm \let\tenit=\smallit \let\tensl=\smallsl
\let\tenbf=\smallbf \let\tentt=\smalltt \let\smallcaps=\smallsc
\let\tensf=\smallsf \let\teni=\smalli \let\tensy=\smallsy
\let\tenttsl=\smallttsl
\def\curfontsize{small}%
\def\lsize{smaller}\def\lllsize{smaller}%
\resetmathfonts \setleading{10.5pt}}</pre>

<p>defsmallerfonts{%</p>

<pre>\let\tenrm=\smallerrm \let\tenit=\smallerit \let\tensl=\smallersl
\let\tenbf=\smallerbf \let\tentt=\smallertt \let\smallcaps=\smallersc
\let\tensf=\smallersf \let\teni=\smalleri \let\tensy=\smallersy
\let\tenttsl=\smallerttsl
\def\curfontsize{smaller}%
\def\lsize{smaller}\def\lllsize{smaller}%
\resetmathfonts \setleading{9.5pt}}</pre>

<p>% Set the fonts to use with the @small… environments. letsmallexamplefonts
= smallfonts</p>

<p>% About smallexamplefonts.  If we use smallfonts (9pt), @smallexample % can
fit this many characters: %   8.5x11=86   smallbook=72  a4=90  a5=69 % If
we use scriptfonts (8pt), then we can fit this many characters: %  
8.5x11=90+  smallbook=80  a4=90+  a5=77 % For me, subjectively, the few
extra characters that fit aren’t worth % the additional smallness of 8pt. 
So I’m making the default 9pt. % % By the way, for comparison, here’s what
fits with @example (10pt): %   8.5x11=71  smallbook=60  a4=75  a5=58 % % I
wish the USA used A4 paper. % –karl, 24jan03.</p>

<p>% Set up the default fonts, so we can use them for creating boxes. %
textfonts rm</p>

<p>% Define these so they can be easily changed for other fonts.
defangleleft{$langle$} defangleright{$rangle$}</p>

<p>% Count depth in font-changes, for error checks newcountfontdepth
fontdepth=0</p>

<p>% Fonts for short table of contents. setfontshortcontrmrmshape{12}{1000}
setfontshortcontbfbfshape{10}{magstep1}  % no cmb12
setfontshortcontslslshape{12}{1000} setfontshortcontttttshape{12}{1000}</p>

<p>%% Add scribe-like font environments, plus @l for inline lisp (usually sans
%% serif) and @ii for TeX italic</p>

<p>% smartitalic{ARG} outputs arg in italics, followed by an italic correction
% unless the following character is such as not to need one.
defsmartitalicx{ifxnext,elseifxnext-elseifxnext.else</p>

<pre>\ptexslash\fi\fi\fi}</pre>

<p>defsmartslanted#1{{ifusingttttslsl #1}futureletnextsmartitalicx}
defsmartitalic#1{{ifusingttttslit #1}futureletnextsmartitalicx}</p>

<p>% like smartslanted except unconditionally uses ttsl. % @var is set to this
for defun arguments. defttslanted#1{{ttsl #1}futureletnextsmartitalicx}</p>

<p>% like smartslanted except unconditionally use sl.  We never want % ttsl
for book titles, do we? defcite#1{{sl #1}futureletnextsmartitalicx}</p>

<p>leti=smartitalic letslanted=smartslanted letvar=smartslanted
letdfn=smartslanted letemph=smartitalic</p>

<p>% @b, explicit bold. defb#1{{bf #1}} letstrong=b</p>

<p>% @sansserif, explicit sans. defsansserif#1{{sf #1}}</p>

<p>% We can’t just use exhyphenpenalty, because that only has effect at % the
end of a paragraph.  Restore normal hyphenation at the end of the % group
within which nohyphenation is presumably called. %
defnohyphenation{hyphencharfont = -1  aftergrouprestorehyphenation}
defrestorehyphenation{hyphencharfont = `- }</p>

<p>% Set sfcode to normal for the chars that usually have another value. %
Can’t use plain’s frenchspacing because it uses the `x notation, and %
sometimes x has an active definition that messes things up. % catcode`@=11</p>

<pre>\def\plainfrenchspacing{%
  \sfcode\dotChar  =\@m \sfcode\questChar=\@m \sfcode\exclamChar=\@m
  \sfcode\colonChar=\@m \sfcode\semiChar =\@m \sfcode\commaChar =\@m
  \def\endofsentencespacefactor{1000}% for @. and friends
}
\def\plainnonfrenchspacing{%
  \sfcode`\.3000\sfcode`\?3000\sfcode`\!3000
  \sfcode`\:2000\sfcode`\;1500\sfcode`\,1250
  \def\endofsentencespacefactor{3000}% for @. and friends
}</pre>

<p>catcode`@=other defendofsentencespacefactor{3000}% default</p>

<p>deft#1{%</p>

<pre>{\tt \rawbackslash \plainfrenchspacing #1}%
\null</pre>

<p>} defsamp#1{`tclose{#1}‘null} setfontkeyrmrmshape{8}{1000} fontkeysy=cmsy9
defkey#1{{keyrmtextfont2=keysy leavevmodehbox{%</p>

<pre>\raise0.4pt\hbox{\angleleft}\kern-.08em\vtop{%
  \vbox{\hrule\kern-0.4pt
   \hbox{\raise0.4pt\hbox{\vphantom{\angleleft}}#1}}%
  \kern-0.4pt\hrule}%
\kern-.06em\raise0.4pt\hbox{\angleright}}}}</pre>

<p>% The old definition, with no lozenge: %defkey #1{{ttsl nohyphenation
uppercase{#1}}null} defctrl #1{{tt rawbackslash hat}#1}</p>

<p>% @file, @option are the same as @samp. letfile=samp letoption=samp</p>

<p>% @code is a modification of @t, % which makes spaces the same size as
normal in the surrounding text. deftclose#1{%</p>

<pre>{%
  % Change normal interword space to be same as for the current font.
  \spaceskip = \fontdimen2\font
  %
  % Switch to typewriter.
  \tt
  %
  % But `\ ' produces the large typewriter interword space.
  \def\ {{\spaceskip = 0pt{} }}%
  %
  % Turn off hyphenation.
  \nohyphenation
  %
  \rawbackslash
  \plainfrenchspacing
  #1%
}%
\null</pre>

<p>}</p>

<p>% We <strong>must</strong> turn on hyphenation at `-‘ and `_’ in @code. %
Otherwise, it is too hard to avoid overfull hboxes % in the Emacs manual,
the Library manual, etc.</p>

<p>% Unfortunately, TeX uses one parameter (hyphenchar) to control % both
hyphenation at - and hyphenation within words. % We must therefore turn
them both off (tclose does that) % and arrange explicitly to hyphenate at a
dash. %  – rms. {</p>

<pre>\catcode`\-=\active
\catcode`\_=\active
%
\global\def\code{\begingroup
  \catcode`\-=\active  \catcode`\_=\active
  \ifallowcodebreaks
   \let-\codedash
   \let_\codeunder
  \else
   \let-\realdash
   \let_\realunder
  \fi
  \codex
}</pre>

<p>}</p>

<p>defrealdash{-} defcodedash{-discretionary{}{}{}} defcodeunder{%</p>

<pre class="ruby"><span class="ruby-string">%Qthis </span><span class="ruby-identifier">is</span> <span class="ruby-identifier">all</span> <span class="ruby-identifier">so</span> <span class="ruby-ivar">@math</span>{<span class="ruby-ivar">@code</span>{<span class="ruby-identifier">var_name</span>}<span class="ruby-operator">+</span><span class="ruby-value">1</span>} <span class="ruby-identifier">can</span> <span class="ruby-identifier">work</span>.  <span class="ruby-constant">In</span> <span class="ruby-identifier">math</span> <span class="ruby-identifier">mode</span>, <span class="ruby-identifier">_</span>
<span class="ruby-string">%Qis </span><span class="ruby-string">&quot;active&quot;</span> (<span class="ruby-identifier">mathcode</span><span class="ruby-string">&quot;8000) and \normalunderscore (or \car95, etc.)
% will therefore expand the active definition of _, which is us
% (inside @code that is), therefore an endless loop.
\ifusingtt{\ifmmode
             \mathchar&quot;</span><span class="ruby-value">075</span><span class="ruby-constant">F</span> <span class="ruby-operator">%</span> <span class="ruby-keyword">class</span> <span class="ruby-value">0</span>=<span class="ruby-identifier">ordinary</span>, <span class="ruby-identifier">family</span> <span class="ruby-value">7</span>=<span class="ruby-identifier">ttfam</span>, <span class="ruby-identifier">pos</span> <span class="ruby-value">0x5F</span>=<span class="ruby-identifier">_</span>.
           \<span class="ruby-identifier">else</span>\<span class="ruby-identifier">normalunderscore</span> \<span class="ruby-identifier">fi</span>
           \<span class="ruby-identifier">discretionary</span>{}{}{}}<span class="ruby-operator">%</span>
          {\<span class="ruby-identifier">_</span>}<span class="ruby-operator">%</span>
</pre>

<p>} defcodex #1{tclose{#1}endgroup}</p>

<p>% An additional complication: the above will allow breaks after, e.g., %
each of the four underscores in __typeof__.  This is undesirable in % some
manuals, especially if they don’t have long identifiers in % general. 
@allowcodebreaks provides a way to control this. %  newififallowcodebreaks 
allowcodebreakstrue</p>

<p>defkeywordtrue{true} defkeywordfalse{false}</p>

<p>parseargdefallowcodebreaks{%</p>

<pre>\def\txiarg{#1}%
\ifx\txiarg\keywordtrue
  \allowcodebreakstrue
\else\ifx\txiarg\keywordfalse
  \allowcodebreaksfalse
\else
  \errhelp = \EMsimple
  \errmessage{Unknown @allowcodebreaks option `\txiarg'}%
\fi\fi</pre>

<p>}</p>

<p>% @kbd is like @code, except that if the argument is just one @key command,
% then @kbd has no effect.</p>

<p>% @kbdinputstyle – arg is `distinct’ (@kbd uses slanted tty font always), %
`example’ (@kbd uses ttsl only inside of @example and friends), %   or
`code’ (@kbd uses normal tty font always). parseargdefkbdinputstyle{%</p>

<pre>\def\txiarg{#1}%
\ifx\txiarg\worddistinct
  \gdef\kbdexamplefont{\ttsl}\gdef\kbdfont{\ttsl}%
\else\ifx\txiarg\wordexample
  \gdef\kbdexamplefont{\ttsl}\gdef\kbdfont{\tt}%
\else\ifx\txiarg\wordcode
  \gdef\kbdexamplefont{\tt}\gdef\kbdfont{\tt}%
\else
  \errhelp = \EMsimple
  \errmessage{Unknown @kbdinputstyle option `\txiarg'}%
\fi\fi\fi</pre>

<p>} defworddistinct{distinct} defwordexample{example} defwordcode{code}</p>

<p>% Default is `distinct.‘ kbdinputstyle distinct</p>

<p>defxkey{key} defkbdfoo#1#2#3par{defone{#1}defthree{#3}defthreex{??}%
ifxonexkeyifxthreexthree key{#2}% else{tclose{kbdfontlook}}fi
else{tclose{kbdfontlook}}fi}</p>

<p>% For @indicateurl, @env, @command quotes seem unnecessary, so use code.
letindicateurl=code letenv=code letcommand=code</p>

<p>% @uref (abbreviation for `urlref’) takes an optional (comma-separated) %
second argument specifying the text to display and an optional third % arg
as text to display instead of (rather than in addition to) the url %
itself.  First (mandatory) arg is the url.  Perhaps eventually put in % a
hypertex special here. % defuref#1{douref #1,,,finish}
defdouref#1,#2,#3,#4finish{begingroup</p>

<pre>\unsepspaces
\pdfurl{#1}%
\setbox0 = \hbox{\ignorespaces #3}%
\ifdim\wd0 &gt; 0pt
  \unhbox0 % third arg given, show only that
\else
  \setbox0 = \hbox{\ignorespaces #2}%
  \ifdim\wd0 &gt; 0pt
    \ifpdf
      \unhbox0             % PDF: 2nd arg given, show only it
    \else
      \unhbox0\ (\code{#1})% DVI: 2nd arg given, show both it and url
    \fi
  \else
    \code{#1}% only url given, so show it
  \fi
\fi
\endlink</pre>

<p>endgroup}</p>

<p>% @url synonym for @uref, since that’s how everyone uses it. % leturl=uref</p>

<p>% rms does not like angle brackets –karl, 17may97. % So now @email is just
like @uref, unless we are pdf. % %defemail#1{angleleft{tt #1}angleright}
ifpdf</p>

<pre>\def\email#1{\doemail#1,,\finish}
\def\doemail#1,#2,#3\finish{\begingroup
  \unsepspaces
  \pdfurl{mailto:#1}%
  \setbox0 = \hbox{\ignorespaces #2}%
  \ifdim\wd0&gt;0pt\unhbox0\else\code{#1}\fi
  \endlink
\endgroup}</pre>

<p>else</p>

<pre>\let\email=\uref</pre>

<p>fi</p>

<p>% Check if we are currently using a typewriter font.  Since all the %
Computer Modern typewriter fonts have zero interword stretch (and %
shrink), and it is reasonable to expect all typewriter fonts to have % this
property, we can check that font parameter. %
defifmonospace{ifdimfontdimen3font=0pt }</p>

<p>% Typeset a dimension, e.g., `in’ or `pt’.  The only reason for the %
argument is to make the input look right: @dmn{pt} instead of @dmn{}pt. %
defdmn#1{thinspace #1}</p>

<p>defkbd#1{deflook{#1}expandafterkbdfoolook??par}</p>

<p>% @l was never documented to mean “switch to the Lisp font”, % and it is
not used as such in any manual I can find.  We need it for % Polish
suppressed-l.  –karl, 22sep96. %defl#1{{li #1}null}</p>

<p>% Explicit font changes: @r, @sc, undocumented @ii. defr#1{{rm #1}}        
% roman font defsc#1{{smallcaps#1}}       % smallcaps font defii#1{{it #1}}
% italic font</p>

<p>% @acronym for “FBI”, “NATO”, and the like. % We print this one point size
smaller, since it’s intended for % all-uppercase. %  defacronym#1{doacronym
#1,,finish} defdoacronym#1,#2,#3finish{%</p>

<pre>{\selectfonts\lsize #1}%
\def\temp{#2}%
\ifx\temp\empty \else
  \space ({\unsepspaces \ignorespaces \temp \unskip})%
\fi</pre>

<p>}</p>

<p>% @abbr for “Comput. J.” and the like. % No font change, but don’t do
end-of-sentence spacing. %  defabbr#1{doabbr #1,,finish}
defdoabbr#1,#2,#3finish{%</p>

<pre>{\plainfrenchspacing #1}%
\def\temp{#2}%
\ifx\temp\empty \else
  \space ({\unsepspaces \ignorespaces \temp \unskip})%
\fi</pre>

<p>}</p>

<p>% @pounds{} is a sterling sign, which Knuth put in the CM italic font. %
defpounds{{it$}}</p>

<p>% @euro{} comes from a separate font, depending on the current style. % We
use the free feym* fonts from the eurosym package by Henrik % Theiling,
which support regular, slanted, bold and bold slanted (and % “outlined”
(blackboard board, sort of) versions, which we don’t need). % It is
available from <a
href="http://www.ctan.org/tex-archive/fonts/eurosym">www.ctan.org/tex-archive/fonts/eurosym</a>.
%  % Although only regular is the truly official Euro symbol, we ignore %
that.  The Euro is designed to be slightly taller than the regular % font
height. %  % feymr - regular % feymo - slanted % feybr - bold % feybo -
bold slanted %  % There is no good (free) typewriter version, to my
knowledge. % A feymr10 euro is ~7.3pt wide, while a normal cmtt10 char is
~5.25pt wide. % Hmm. %  % Also doesn’t work in math.  Do we need to do math
with euro symbols? % Hope not. %  %  defeuro{{eurofont e}} defeurofont{%</p>

<pre>% We set the font at each command, rather than predefining it in
% \textfonts and the other font-switching commands, so that
% installations which never need the symbol don't have to have the
% font installed.
% 
% There is only one designed size (nominal 10pt), so we always scale
% that to the current nominal size.
% 
% By the way, simply using &quot;at 1em&quot; works for cmr10 and the like, but
% does not work for cmbx10 and other extended/shrunken fonts.
% 
\def\eurosize{\csname\curfontsize nominalsize\endcsname}%
%
\ifx\curfontstyle\bfstylename 
  % bold:
  \font\thiseurofont = \ifusingit{feybo10}{feybr10} at \eurosize
\else 
  % regular:
  \font\thiseurofont = \ifusingit{feymo10}{feymr10} at \eurosize
\fi
\thiseurofont</pre>

<p>}</p>

<p>% @registeredsymbol - R in a circle.  The font for the R should really % be
smaller yet, but lllsize is the best we can do for now. % Adapted from the
plain.tex definition of copyright. % defregisteredsymbol{%</p>

<pre>$^{{\ooalign{\hfil\raise.07ex\hbox{\selectfonts\lllsize R}%
             \hfil\crcr\Orb}}%
  }$%</pre>

<p>}</p>

<p>% Laurent Siebenmann reports Orb undefined with: %  Textures 1.7.7
(preloaded format=plain 93.10.14)  (68K)  16 APR 2004 02:38 % so we’ll
define it if necessary. %  ifxOrbundefined defOrb{mathhexbox20D} fi</p>

<p>message{page headings,}</p>

<p>newskiptitlepagetopglue titlepagetopglue = 1.5in newskiptitlepagebottomglue
titlepagebottomglue = 2pc</p>

<p>% First the title page.  Must do @settitle before @titlepage.
newififseenauthor newififfinishedtitlepage</p>

<p>% Do an implicit @contents or @shortcontents after @end titlepage if the %
user says @setcontentsaftertitlepage or @setshortcontentsaftertitlepage. %
newififsetcontentsaftertitlepage</p>

<pre>\let\setcontentsaftertitlepage = \setcontentsaftertitlepagetrue</pre>

<p>newififsetshortcontentsaftertitlepage</p>

<pre>\let\setshortcontentsaftertitlepage = \setshortcontentsaftertitlepagetrue</pre>

<p>parseargdefshorttitlepage{begingrouphbox{}vskip 1.5in chaprm
centerline{#1}%</p>

<pre>\endgroup\page\hbox{}\page}</pre>

<p>envdeftitlepage{%</p>

<pre>% Open one extra group, as we want to close it in the middle of \Etitlepage.
\begingroup
  \parindent=0pt \textfonts
  % Leave some space at the very top of the page.
  \vglue\titlepagetopglue
  % No rule at page bottom unless we print one at the top with @title.
  \finishedtitlepagetrue
  %
  % Most title ``pages'' are actually two pages long, with space
  % at the top of the second.  We don't want the ragged left on the second.
  \let\oldpage = \page
  \def\page{%
    \iffinishedtitlepage\else
       \finishtitlepage
    \fi
    \let\page = \oldpage
    \page
    \null
  }%</pre>

<p>}</p>

<p>defEtitlepage{%</p>

<pre>  \iffinishedtitlepage\else
      \finishtitlepage
  \fi
  % It is important to do the page break before ending the group,
  % because the headline and footline are only empty inside the group.
  % If we use the new definition of \page, we always get a blank page
  % after the title page, which we certainly don't want.
  \oldpage
\endgroup
%
% Need this before the \...aftertitlepage checks so that if they are
% in effect the toc pages will come out with page numbers.
\HEADINGSon
%
% If they want short, they certainly want long too.
\ifsetshortcontentsaftertitlepage
  \shortcontents
  \contents
  \global\let\shortcontents = \relax
  \global\let\contents = \relax
\fi
%
\ifsetcontentsaftertitlepage
  \contents
  \global\let\contents = \relax
  \global\let\shortcontents = \relax
\fi</pre>

<p>}</p>

<p>deffinishtitlepage{%</p>

<pre>\vskip4pt \hrule height 2pt width \hsize
\vskip\titlepagebottomglue
\finishedtitlepagetrue</pre>

<p>}</p>

<p>%%% Macros to be used within @titlepage:</p>

<p>letsubtitlerm=tenrm defsubtitlefont{subtitlerm normalbaselineskip = 13pt
normalbaselines}</p>

<p>defauthorfont{authorrm normalbaselineskip = 16pt normalbaselines</p>

<pre>\let\tt=\authortt}</pre>

<p>parseargdeftitle{%</p>

<pre>\checkenv\titlepage
\leftline{\titlefonts\rm #1}
% print a rule at the page bottom also.
\finishedtitlepagefalse
\vskip4pt \hrule height 4pt width \hsize \vskip4pt</pre>

<p>}</p>

<p>parseargdefsubtitle{%</p>

<pre>\checkenv\titlepage
{\subtitlefont \rightline{#1}}%</pre>

<p>}</p>

<p>% @author should come last, but may come many times. % It can also be used
inside @quotation. % parseargdefauthor{%</p>

<pre>\def\temp{\quotation}%
\ifx\thisenv\temp
  \def\quotationauthor{#1}% printed in \Equotation.
\else
  \checkenv\titlepage
  \ifseenauthor\else \vskip 0pt plus 1filll \seenauthortrue \fi
  {\authorfont \leftline{#1}}%
\fi</pre>

<p>}</p>

<p>%%% Set up page headings and footings.</p>

<p>letthispage=folio</p>

<p>newtoksevenheadline    % headline on even pages newtoksoddheadline     %
headline on odd pages newtoksevenfootline    % footline on even pages
newtoksoddfootline     % footline on odd pages</p>

<p>% Now make TeX use those variables headline={{textfontsrm ifoddpageno
theoddheadline</p>

<pre>\else \the\evenheadline \fi}}</pre>

<p>footline={{textfontsrm ifoddpageno theoddfootline</p>

<pre>\else \the\evenfootline \fi}\HEADINGShook}</pre>

<p>letHEADINGShook=relax</p>

<p>% Commands to set those variables. % For example, this is what  @headings
on  does % @evenheading @thistitle|@thispage|@thischapter % @oddheading
@thischapter|@thispage|@thistitle % @evenfooting @thisfile|| % @oddfooting
||@thisfile</p>

<p>defevenheading{parseargevenheadingxxx} defevenheadingxxx #1{evenheadingyyy
#1||||finish} defevenheadingyyy #1|#2|#3|#4finish{%
globalevenheadline={rlap{centerline{#2}}line{#1hfil#3}}}</p>

<p>defoddheading{parseargoddheadingxxx} defoddheadingxxx #1{oddheadingyyy
#1||||finish} defoddheadingyyy #1|#2|#3|#4finish{%
globaloddheadline={rlap{centerline{#2}}line{#1hfil#3}}}</p>

<p>parseargdefeveryheading{oddheadingxxx{#1}evenheadingxxx{#1}}%</p>

<p>defevenfooting{parseargevenfootingxxx} defevenfootingxxx #1{evenfootingyyy
#1||||finish} defevenfootingyyy #1|#2|#3|#4finish{%
globalevenfootline={rlap{centerline{#2}}line{#1hfil#3}}}</p>

<p>defoddfooting{parseargoddfootingxxx} defoddfootingxxx #1{oddfootingyyy
#1||||finish} defoddfootingyyy #1|#2|#3|#4finish{%</p>

<pre>\global\oddfootline = {\rlap{\centerline{#2}}\line{#1\hfil#3}}%
%
% Leave some space for the footline.  Hopefully ok to assume
% @evenfooting will not be used by itself.
\global\advance\pageheight by -\baselineskip
\global\advance\vsize by -\baselineskip</pre>

<p>}</p>

<p>parseargdefeveryfooting{oddfootingxxx{#1}evenfootingxxx{#1}}</p>

<p>% @headings double      turns headings on for double-sided printing. %
@headings single      turns headings on for single-sided printing. %
@headings off         turns them off. % @headings on          same as
@headings double, retained for compatibility. % @headings after       turns
on double-sided headings after this page. % @headings doubleafter turns on
double-sided headings after this page. % @headings singleafter turns on
single-sided headings after this page. % By default, they are off at the
start of a document, % and turned `on’ after @end titlepage.</p>

<p>defheadings #1 {csname HEADINGS#1endcsname}</p>

<p>defHEADINGSoff{% globalevenheadline={hfil} globalevenfootline={hfil}
globaloddheadline={hfil} globaloddfootline={hfil}} HEADINGSoff % When we
turn headings on, set the page number to 1. % For double-sided printing,
put current file name in lower left corner, % chapter name on inside top of
right hand pages, document % title on inside top of left hand pages, and
page numbers on outside top % edge of all pages. defHEADINGSdouble{%
globalpageno=1 globalevenfootline={hfil} globaloddfootline={hfil}
globalevenheadline={line{foliohfilthistitle}}
globaloddheadline={line{thischapterhfilfolio}} globalletcontentsalignmacro
= chapoddpage } letcontentsalignmacro = chappager</p>

<p>% For single-sided printing, chapter title goes across top left of page, %
page number on top right. defHEADINGSsingle{% globalpageno=1
globalevenfootline={hfil} globaloddfootline={hfil}
globalevenheadline={line{thischapterhfilfolio}}
globaloddheadline={line{thischapterhfilfolio}} globalletcontentsalignmacro
= chappager } defHEADINGSon{HEADINGSdouble}</p>

<p>defHEADINGSafter{letHEADINGShook=HEADINGSdoublex}
letHEADINGSdoubleafter=HEADINGSafter defHEADINGSdoublex{%
globalevenfootline={hfil} globaloddfootline={hfil}
globalevenheadline={line{foliohfilthistitle}}
globaloddheadline={line{thischapterhfilfolio}} globalletcontentsalignmacro
= chapoddpage }</p>

<p>defHEADINGSsingleafter{letHEADINGShook=HEADINGSsinglex}
defHEADINGSsinglex{% globalevenfootline={hfil} globaloddfootline={hfil}
globalevenheadline={line{thischapterhfilfolio}}
globaloddheadline={line{thischapterhfilfolio}} globalletcontentsalignmacro
= chappager }</p>

<p>% Subroutines used in generating headings % This produces Day Month Year
style of output. % Only define if not already defined, in case a txi-??.tex
file has set % up a different format (e.g., txi-cs.tex does this).
ifxtodayundefined deftoday{%</p>

<pre>\number\day\space
\ifcase\month
\or\putwordMJan\or\putwordMFeb\or\putwordMMar\or\putwordMApr
\or\putwordMMay\or\putwordMJun\or\putwordMJul\or\putwordMAug
\or\putwordMSep\or\putwordMOct\or\putwordMNov\or\putwordMDec
\fi
\space\number\year}</pre>

<p>fi</p>

<p>% @settitle line…  specifies the title of the document, for headings. % It
generates no output of its own. defthistitle{putwordNoTitle}
defsettitle{parsearg{gdefthistitle}}</p>

<p>message{tables,} % Tables – @table, @ftable, @vtable, @item(x).</p>

<p>% default indentation of table text newdimentableindent tableindent=.8in %
default indentation of @itemize and @enumerate text newdimenitemindent 
itemindent=.3in % margin between end of table item and start of table text.
newdimenitemmargin  itemmargin=.1in</p>

<p>% used internally for itemindent minus itemmargin newdimenitemmax</p>

<p>% Note @table, @ftable, and @vtable define @item, @itemx, etc., with %
these defs. % They also define itemindex % to index the item name in
whatever manner is desired (perhaps none).</p>

<p>newififitemxneedsnegativevskip</p>

<p>defitemxpar{parifitemxneedsnegativevskipnobreakvskip-parskipnobreakfi}</p>

<p>definternalBitem{smallbreak parseargitemzzz} definternalBitemx{itemxpar
parseargitemzzz}</p>

<p>defitemzzz #1{begingroup %</p>

<pre>\advance\hsize by -\rightskip
\advance\hsize by -\tableindent
\setbox0=\hbox{\itemindicate{#1}}%
\itemindex{#1}%
\nobreak % This prevents a break before @itemx.
%
% If the item text does not fit in the space we have, put it on a line
% by itself, and do not allow a page break either before or after that
% line.  We do not start a paragraph here because then if the next
% command is, e.g., @kindex, the whatsit would get put into the
% horizontal list on a line by itself, resulting in extra blank space.
\ifdim \wd0&gt;\itemmax
  %
  % Make this a paragraph so we get the \parskip glue and wrapping,
  % but leave it ragged-right.
  \begingroup
    \advance\leftskip by-\tableindent
    \advance\hsize by\tableindent
    \advance\rightskip by0pt plus1fil
    \leavevmode\unhbox0\par
  \endgroup
  %
  % We're going to be starting a paragraph, but we don't want the
  % \parskip glue -- logically it's part of the @item we just started.
  \nobreak \vskip-\parskip
  %
  % Stop a page break at the \parskip glue coming up.  However, if
  % what follows is an environment such as @example, there will be no
  % \parskip glue; then the negative vskip we just inserted would
  % cause the example and the item to crash together.  So we use this
  % bizarre value of 10001 as a signal to \aboveenvbreak to insert
  % \parskip glue after all.  Section titles are handled this way also.
  % 
  \penalty 10001
  \endgroup
  \itemxneedsnegativevskipfalse
\else
  % The item text fits into the space.  Start a paragraph, so that the
  % following text (if any) will end up on the same line.
  \noindent
  % Do this with kerns and \unhbox so that if there is a footnote in
  % the item text, it can migrate to the main vertical list and
  % eventually be printed.
  \nobreak\kern-\tableindent
  \dimen0 = \itemmax  \advance\dimen0 by \itemmargin \advance\dimen0 by -\wd0
  \unhbox0
  \nobreak\kern\dimen0
  \endgroup
  \itemxneedsnegativevskiptrue
\fi</pre>

<p>}</p>

<p>defitem{errmessage{@item while not in a list environment}}
defitemx{errmessage{@itemx while not in a list environment}}</p>

<p>% @table, @ftable, @vtable. envdeftable{%</p>

<pre>\let\itemindex\gobble
\tablecheck{table}%</pre>

<p>} envdefftable{%</p>

<pre>\def\itemindex ##1{\doind {fn}{\code{##1}}}%
\tablecheck{ftable}%</pre>

<p>} envdefvtable{%</p>

<pre>\def\itemindex ##1{\doind {vr}{\code{##1}}}%
\tablecheck{vtable}%</pre>

<p>} deftablecheck#1{%</p>

<pre>\ifnum \the\catcode`\^^M=\active
  \endgroup
  \errmessage{This command won't work in this context; perhaps the problem is
    that we are \inenvironment\thisenv}%
  \def\next{\doignore{#1}}%
\else
  \let\next\tablex
\fi
\next</pre>

<p>} deftablex#1{%</p>

<pre>\def\itemindicate{#1}%
\parsearg\tabley</pre>

<p>} deftabley#1{%</p>

<pre>{%
  \makevalueexpandable
  \edef\temp{\noexpand\tablez #1\space\space\space}%
  \expandafter
}\temp \endtablez</pre>

<p>} deftablez #1 #2 #3 #4endtablez{%</p>

<pre>\aboveenvbreak
\ifnum 0#1&gt;0 \advance \leftskip by #1\mil \fi
\ifnum 0#2&gt;0 \tableindent=#2\mil \fi
\ifnum 0#3&gt;0 \advance \rightskip by #3\mil \fi
\itemmax=\tableindent
\advance \itemmax by -\itemmargin
\advance \leftskip by \tableindent
\exdentamount=\tableindent
\parindent = 0pt
\parskip = \smallskipamount
\ifdim \parskip=0pt \parskip=2pt \fi
\let\item = \internalBitem
\let\itemx = \internalBitemx</pre>

<p>} defEtable{endgrafafterenvbreak} letEftableEtable letEvtableEtable
letEitemizeEtable letEenumerateEtable</p>

<p>% This is the counter used by @enumerate, which is really @itemize</p>

<p>newcount itemno</p>

<p>envdefitemize{parseargdoitemize}</p>

<p>defdoitemize#1{%</p>

<pre>\aboveenvbreak
\itemmax=\itemindent
\advance\itemmax by -\itemmargin
\advance\leftskip by \itemindent
\exdentamount=\itemindent
\parindent=0pt
\parskip=\smallskipamount
\ifdim\parskip=0pt \parskip=2pt \fi
\def\itemcontents{#1}%
% @itemize with no arg is equivalent to @itemize @bullet.
\ifx\itemcontents\empty\def\itemcontents{\bullet}\fi
\let\item=\itemizeitem</pre>

<p>}</p>

<p>% Definition of @item while inside @itemize and @enumerate. %
defitemizeitem{%</p>

<pre>\advance\itemno by 1  % for enumerations
{\let\par=\endgraf \smallbreak}% reasonable place to break
{%
 % If the document has an @itemize directly after a section title, a
 % \nobreak will be last on the list, and \sectionheading will have
 % done a \vskip-\parskip.  In that case, we don't want to zero
 % parskip, or the item text will crash with the heading.  On the
 % other hand, when there is normal text preceding the item (as there
 % usually is), we do want to zero parskip, or there would be too much
 % space.  In that case, we won't have a \nobreak before.  At least
 % that's the theory.
 \ifnum\lastpenalty&lt;10000 \parskip=0in \fi
 \noindent
 \hbox to 0pt{\hss \itemcontents \kern\itemmargin}%
 \vadjust{\penalty 1200}}% not good to break after first line of item.
\flushcr</pre>

<p>}</p>

<p>% splitoff TOKENSendmark defines first to be the first token in % TOKENS,
and rest to be the remainder. %
defsplitoff#1#2endmark{deffirst{#1}defrest{#2}}%</p>

<p>% Allow an optional argument of an uppercase letter, lowercase letter, % or
number, to specify the first label in the enumerated list.  No % argument
is the same as `1’. % envparseargdefenumerate{enumeratey #1  endenumeratey}
defenumeratey #1 #2endenumeratey{%</p>

<pre>% If we were given no argument, pretend we were given `1'.
\def\thearg{#1}%
\ifx\thearg\empty \def\thearg{1}\fi
%
% Detect if the argument is a single token.  If so, it might be a
% letter.  Otherwise, the only valid thing it can be is a number.
% (We will always have one token, because of the test we just made.
% This is a good thing, since \splitoff doesn't work given nothing at
% all -- the first parameter is undelimited.)
\expandafter\splitoff\thearg\endmark
\ifx\rest\empty
  % Only one token in the argument.  It could still be anything.
  % A ``lowercase letter'' is one whose \lccode is nonzero.
  % An ``uppercase letter'' is one whose \lccode is both nonzero, and
  %   not equal to itself.
  % Otherwise, we assume it's a number.
  %
  % We need the \relax at the end of the \ifnum lines to stop TeX from
  % continuing to look for a &lt;number&gt;.
  %
  \ifnum\lccode\expandafter`\thearg=0\relax
    \numericenumerate % a number (we hope)
  \else
    % It's a letter.
    \ifnum\lccode\expandafter`\thearg=\expandafter`\thearg\relax
      \lowercaseenumerate % lowercase letter
    \else
      \uppercaseenumerate % uppercase letter
    \fi
  \fi
\else
  % Multiple tokens in the argument.  We hope it's a number.
  \numericenumerate
\fi</pre>

<p>}</p>

<p>% An @enumerate whose labels are integers.  The starting integer is % given
in thearg. % defnumericenumerate{%</p>

<pre>\itemno = \thearg
\startenumeration{\the\itemno}%</pre>

<p>}</p>

<p>% The starting (lowercase) letter is in thearg. deflowercaseenumerate{%</p>

<pre>\itemno = \expandafter`\thearg
\startenumeration{%
  % Be sure we're not beyond the end of the alphabet.
  \ifnum\itemno=0
    \errmessage{No more lowercase letters in @enumerate; get a bigger
                alphabet}%
  \fi
  \char\lccode\itemno
}%</pre>

<p>}</p>

<p>% The starting (uppercase) letter is in thearg. defuppercaseenumerate{%</p>

<pre>\itemno = \expandafter`\thearg
\startenumeration{%
  % Be sure we're not beyond the end of the alphabet.
  \ifnum\itemno=0
    \errmessage{No more uppercase letters in @enumerate; get a bigger
                alphabet}
  \fi
  \char\uccode\itemno
}%</pre>

<p>}</p>

<p>% Call doitemize, adding a period to the first argument and supplying the %
common last two arguments.  Also subtract one from the initial value in %
itemno, since @item increments itemno. % defstartenumeration#1{%</p>

<pre>\advance\itemno by -1
\doitemize{#1.}\flushcr</pre>

<p>}</p>

<p>% @alphaenumerate and @capsenumerate are abbreviations for giving an arg %
to @enumerate. % defalphaenumerate{enumerate{a}}
defcapsenumerate{enumerate{A}} defEalphaenumerate{Eenumerate}
defEcapsenumerate{Eenumerate}</p>

<p>% @multitable macros % Amy Hendrickson, 8/18/94, 3/6/96 % % @multitable …
@end multitable will make as many columns as desired. % Contents of each
column will wrap at width given in preamble.  Width % can be specified
either with sample text given in a template line, % or in percent of hsize,
the current width of text on page.</p>

<p>% Table can continue over pages but will only break between lines.</p>

<p>% To make preamble: % % Either define widths of columns in terms of percent
of hsize: %   @multitable @columnfractions .25 .3 .45 %   @item … % %  
Numbers following @columnfractions are the percent of the total %   current
hsize to be used for each column. You may use as many %   columns as
desired.</p>

<p>% Or use a template: %   @multitable {Column 1 template} {Column 2
template} {Column 3 template} %   @item … %   using the widest term desired
in each column.</p>

<p>% Each new table line starts with @item, each subsequent new column %
starts with @tab. Empty columns may be produced by supplying @tab’s % with
nothing between them for as many times as empty columns are needed, % ie,
@tab@tab@tab will produce two empty columns.</p>

<p>% @item, @tab do not need to be on their own lines, but it will not hurt %
if they are.</p>

<p>% Sample multitable:</p>

<p>%   @multitable {Column 1 template} {Column 2 template} {Column 3 template}
%   @item first col stuff @tab second col stuff @tab third col %   @item % 
first col stuff %   @tab %   second col stuff %   @tab %   third col %  
@item first col stuff @tab second col stuff %   @tab Many paragraphs of
text may be used in any column. % %         They will wrap at the width
determined by the template. %   @item@tab@tab This will be in third column.
%   @end multitable</p>

<p>% Default dimensions may be reset by user. % @multitableparskip is vertical
space between paragraphs in table. % @multitableparindent is paragraph
indent in table. % @multitablecolmargin is horizontal space to be left
between columns. % @multitablelinespace is space to leave between table
items, baseline %                                                          
to baseline. %   0pt means it depends on current normal line spacing. %
newskipmultitableparskip newskipmultitableparindent
newdimenmultitablecolspace newskipmultitablelinespace multitableparskip=0pt
multitableparindent=6pt multitablecolspace=12pt multitablelinespace=0pt</p>

<p>% Macros used to set up halign preamble: % letendsetuptablerelax
defxendsetuptable{endsetuptable} letcolumnfractionsrelax
defxcolumnfractions{columnfractions} newififsetpercent</p>

<p>% #1 is the @columnfraction, usually a decimal number like .5, but might %
be just 1.  We just use it, whatever it is. % defpickupwholefraction#1 {%</p>

<pre>\global\advance\colcount by 1
\expandafter\xdef\csname col\the\colcount\endcsname{#1\hsize}%
\setuptable</pre>

<p>}</p>

<p>newcountcolcount defsetuptable#1{%</p>

<pre>\def\firstarg{#1}%
\ifx\firstarg\xendsetuptable
  \let\go = \relax
\else
  \ifx\firstarg\xcolumnfractions
    \global\setpercenttrue
  \else
    \ifsetpercent
       \let\go\pickupwholefraction
    \else
       \global\advance\colcount by 1
       \setbox0=\hbox{#1\unskip\space}% Add a normal word space as a
                 % separator; typically that is always in the input, anyway.
       \expandafter\xdef\csname col\the\colcount\endcsname{\the\wd0}%
    \fi
  \fi
  \ifx\go\pickupwholefraction
    % Put the argument back for the \pickupwholefraction call, so
    % we'll always have a period there to be parsed.
    \def\go{\pickupwholefraction#1}%
  \else
    \let\go = \setuptable
  \fi%
\fi
\go</pre>

<p>}</p>

<p>% multitable-only commands. % % @headitem starts a heading row, which we
typeset in bold. % Assignments have to be global since we are inside the
implicit group % of an alignment entry.  Note that everycr resets everytab.
defheaditem{checkenvmultitable crcr globaleverytab={bf}theeverytab}% % % A
tab used to include hskip1sp.  But then the space in a template % line is
not enough.  That is bad.  So let’s go back to just `&amp;‘ until % we
encounter the problem it was intended to solve again. %                    
–karl, nathan@acm.org, 20apr99. deftab{checkenvmultitable
&amp;theeverytab}%</p>

<p>% @multitable … @end multitable definitions: % newtokseverytab  % insert
after every tab. % envdefmultitable{%</p>

<pre class="ruby">\<span class="ruby-identifier">vskip</span>\<span class="ruby-identifier">parskip</span>
\<span class="ruby-identifier">startsavinginserts</span>
<span class="ruby-string">%Q% @item within a multitable starts a normal row.
</span><span class="ruby-operator">%</span> <span class="ruby-constant">We</span> <span class="ruby-identifier">use</span> \<span class="ruby-keyword">def</span> <span class="ruby-identifier">instead</span> <span class="ruby-identifier">of</span> \<span class="ruby-identifier">let</span> <span class="ruby-identifier">so</span> <span class="ruby-identifier">that</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">one</span> <span class="ruby-identifier">of</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">multitable</span> <span class="ruby-identifier">entries</span>
<span class="ruby-string">%Qcontains </span><span class="ruby-identifier">an</span> <span class="ruby-ivar">@itemize</span>, <span class="ruby-identifier">we</span> <span class="ruby-identifier">don</span><span class="ruby-string">'t choke on the \item (seen as \crcr aka
% \endtemplate) expanding \doitemize.
\def\item{\crcr}%
%
\tolerance=9500
\hbadness=9500
\setmultitablespacing
\parskip=\multitableparskip
\parindent=\multitableparindent
\overfullrule=0pt
\global\colcount=0
%
\everycr = {%
  \noalign{%
    \global\everytab={}%
    \global\colcount=0 % Reset the column counter.
    % Check for saved footnotes, etc.
    \checkinserts
    % Keeps underfull box messages off when table breaks over pages.
    %\filbreak
      % Maybe so, but it also creates really weird page breaks when the
      % table breaks over pages. Wouldn'</span><span class="ruby-identifier">t</span> \<span class="ruby-identifier">vfil</span> <span class="ruby-identifier">be</span> <span class="ruby-identifier">better?</span>  <span class="ruby-constant">Wait</span> <span class="ruby-keyword">until</span> <span class="ruby-identifier">the</span>
      <span class="ruby-string">%Qproblem </span><span class="ruby-identifier">manifests</span> <span class="ruby-identifier">itself</span>, <span class="ruby-identifier">so</span> <span class="ruby-identifier">it</span> <span class="ruby-identifier">can</span> <span class="ruby-identifier">be</span> <span class="ruby-identifier">fixed</span> <span class="ruby-keyword">for</span> <span class="ruby-identifier">real</span> <span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-identifier">karl</span>.
  }<span class="ruby-operator">%</span>
}<span class="ruby-operator">%</span>
<span class="ruby-string">%Q\parsearg\domultitable
</span></pre>

<p>} defdomultitable#1{%</p>

<pre>% To parse everything between @multitable and @item:
\setuptable#1 \endsetuptable
%
% This preamble sets up a generic column definition, which will
% be used as many times as user calls for columns.
% \vtop will set a single line and will also let text wrap and
% continue for many paragraphs if desired.
\halign\bgroup &amp;%
  \global\advance\colcount by 1
  \multistrut
  \vtop{%
    % Use the current \colcount to find the correct column width:
    \hsize=\expandafter\csname col\the\colcount\endcsname
    %
    % In order to keep entries from bumping into each other
    % we will add a \leftskip of \multitablecolspace to all columns after
    % the first one.
    %
    % If a template has been used, we will add \multitablecolspace
    % to the width of each template entry.
    %
    % If the user has set preamble in terms of percent of \hsize we will
    % use that dimension as the width of the column, and the \leftskip
    % will keep entries from bumping into each other.  Table will start at
    % left margin and final column will justify at right margin.
    %
    % Make sure we don't inherit \rightskip from the outer environment.
    \rightskip=0pt
    \ifnum\colcount=1
      % The first column will be indented with the surrounding text.
      \advance\hsize by\leftskip
    \else
      \ifsetpercent \else
        % If user has not set preamble in terms of percent of \hsize
        % we will advance \hsize by \multitablecolspace.
        \advance\hsize by \multitablecolspace
      \fi
     % In either case we will make \leftskip=\multitablecolspace:
    \leftskip=\multitablecolspace
    \fi
    % Ignoring space at the beginning and end avoids an occasional spurious
    % blank line, when TeX decides to break the line at the space before the
    % box from the multistrut, so the strut ends up on a line by itself.
    % For example:
    % @multitable @columnfractions .11 .89
    % @item @code{#}
    % @tab Legal holiday which is valid in major parts of the whole country.
    % Is automatically provided with highlighting sequences respectively
    % marking characters.
    \noindent\ignorespaces##\unskip\multistrut
  }\cr</pre>

<p>} defEmultitable{%</p>

<pre>\crcr
\egroup % end the \halign
\global\setpercentfalse</pre>

<p>}</p>

<p>defsetmultitablespacing{%</p>

<pre>\def\multistrut{\strut}% just use the standard line spacing
%
% Compute \multitablelinespace (if not defined by user) for use in
% \multitableparskip calculation.  We used define \multistrut based on
% this, but (ironically) that caused the spacing to be off.
% See bug-texinfo report from Werner Lemberg, 31 Oct 2004 12:52:20 +0100.</pre>

<p>ifdimmultitablelinespace=0pt
setbox0=vbox{X}globalmultitablelinespace=thebaselineskip
globaladvancemultitablelinespace by-ht0 fi %% Test to see if parskip is
larger than space between lines of %% table. If not, do nothing. %%       
If so, set to same dimension as multitablelinespace.
ifdimmultitableparskip&gt;multitablelinespace
globalmultitableparskip=multitablelinespace
globaladvancemultitableparskip-7pt %% to keep parskip somewhat smaller</p>

<pre>%% than skip between lines in the table.</pre>

<p>fi% ifdimmultitableparskip=0pt globalmultitableparskip=multitablelinespace
globaladvancemultitableparskip-7pt %% to keep parskip somewhat smaller</p>

<pre>%% than skip between lines in the table.</pre>

<p>fi}</p>

<p>message{conditionals,}</p>

<p>% @iftex, @ifnotdocbook, @ifnothtml, @ifnotinfo, @ifnotplaintext, %
@ifnotxml always succeed.  They currently do nothing; we don’t % attempt to
check whether the conditionals are properly nested.  But we % have to
remember that they are conditionals, so that @end doesn’t % attempt to
close an environment group. % defmakecond#1{%</p>

<pre>\expandafter\let\csname #1\endcsname = \relax
\expandafter\let\csname iscond.#1\endcsname = 1</pre>

<p>} makecond{iftex} makecond{ifnotdocbook} makecond{ifnothtml}
makecond{ifnotinfo} makecond{ifnotplaintext} makecond{ifnotxml}</p>

<p>% Ignore @ignore, @ifhtml, @ifinfo, and the like. %
defdirentry{doignore{direntry}}
defdocumentdescription{doignore{documentdescription}}
defdocbook{doignore{docbook}} defhtml{doignore{html}}
defifdocbook{doignore{ifdocbook}} defifhtml{doignore{ifhtml}}
defifinfo{doignore{ifinfo}} defifnottex{doignore{ifnottex}}
defifplaintext{doignore{ifplaintext}} defifxml{doignore{ifxml}}
defignore{doignore{ignore}} defmenu{doignore{menu}} defxml{doignore{xml}}</p>

<p>% Ignore text until a line `@end #1’, keeping track of nested conditionals.
% % A count to remember the depth of nesting. newcountdoignorecount</p>

<p>defdoignore#1{begingroup</p>

<pre>% Scan in ``verbatim'' mode:
\catcode`\@ = \other
\catcode`\{ = \other
\catcode`\} = \other
%
% Make sure that spaces turn into tokens that match what \doignoretext wants.
\spaceisspace
%
% Count number of #1's that we've seen.
\doignorecount = 0
%
% Swallow text until we reach the matching `@end #1'.
\dodoignore{#1}%</pre>

<p>}</p>

<p>{ catcode`_=11 % We want to use _STOP_ which cannot appear in texinfo
source.</p>

<pre>\obeylines %
%
\gdef\dodoignore#1{%
  % #1 contains the command name as a string, e.g., `ifinfo'.
  %
  % Define a command to find the next `@end #1', which must be on a line
  % by itself.
  \long\def\doignoretext##1^^M@end #1{\doignoretextyyy##1^^M@#1\_STOP_}%
  % And this command to find another #1 command, at the beginning of a
  % line.  (Otherwise, we would consider a line `@c @ifset', for
  % example, to count as an @ifset for nesting.)
  \long\def\doignoretextyyy##1^^M@#1##2\_STOP_{\doignoreyyy{##2}\_STOP_}%
  %
  % And now expand that command.
  \obeylines %
  \doignoretext ^^M%
}%</pre>

<p>}</p>

<p>defdoignoreyyy#1{%</p>

<pre>\def\temp{#1}%
\ifx\temp\empty                       % Nothing found.
  \let\next\doignoretextzzz
\else                                 % Found a nested condition, ...
  \advance\doignorecount by 1
  \let\next\doignoretextyyy           % ..., look for another.
  % If we're here, #1 ends with ^^M\ifinfo (for example).
\fi
\next #1% the token \_STOP_ is present just after this macro.</pre>

<p>}</p>

<p>% We have to swallow the remaining “_STOP_”. % defdoignoretextzzz#1{%</p>

<pre>\ifnum\doignorecount = 0      % We have just found the outermost @end.
  \let\next\enddoignore
\else                         % Still inside a nested condition.
  \advance\doignorecount by -1
  \let\next\doignoretext      % Look for the next @end.
\fi
\next</pre>

<p>}</p>

<p>% Finish off ignored text. defenddoignore{endgroupignorespaces}</p>

<p>% @set VAR sets the variable VAR to an empty value. % @set VAR REST-OF-LINE
sets VAR to the value REST-OF-LINE. % % Since we want to separate VAR from
REST-OF-LINE (which might be % empty), we can’t just use parsearg; we have
to insert a space of our % own to delimit the rest of the line, and then
take it out again if we % didn’t need it. % We rely on the fact that
parsearg sets catcode`\ =10. % parseargdefset{setyyy#1 endsetyyy}
defsetyyy#1 #2endsetyyy{%</p>

<pre>{%
  \makevalueexpandable
  \def\temp{#2}%
  \edef\next{\gdef\makecsname{SET#1}}%
  \ifx\temp\empty
    \next{}%
  \else
    \setzzz#2\endsetzzz
  \fi
}%</pre>

<p>} % Remove the trailing space setxxx inserted. defsetzzz#1
endsetzzz{next{#1}}</p>

<p>% @clear VAR clears (i.e., unsets) the variable VAR. % parseargdefclear{%</p>

<pre>{%
  \makevalueexpandable
  \global\expandafter\let\csname SET#1\endcsname=\relax
}%</pre>

<p>}</p>

<p>% @value{foo} gets the text saved in variable foo.
defvalue{begingroupmakevalueexpandablevaluexxx}
defvaluexxx#1{expandablevalue{#1}endgroup} {</p>

<pre>\catcode`\- = \active \catcode`\_ = \active
%
\gdef\makevalueexpandable{%
  \let\value = \expandablevalue
  % We don't want these characters active, ...
  \catcode`\-=\other \catcode`\_=\other
  % ..., but we might end up with active ones in the argument if
  % we're called from @code, as @code{@value{foo-bar_}}, though.
  % So \let them to their normal equivalents.
  \let-\realdash \let_\normalunderscore
}</pre>

<p>}</p>

<p>% We have this subroutine so that we can handle at least some @value’s %
properly in indexes (we call makevalueexpandable in indexdummies). % The
command has to be fully expandable (if the variable is set), since % the
result winds up in the index file.  This means that if the % variable’s
value contains other Texinfo commands, it’s almost certain % it will fail
(although perhaps we could fix that with sufficient work % to do a
one-level expansion on the result, instead of complete). %
defexpandablevalue#1{%</p>

<pre>\expandafter\ifx\csname SET#1\endcsname\relax
  {[No value for ``#1'']}%
  \message{Variable `#1', used in @value, is not set.}%
\else
  \csname SET#1\endcsname
\fi</pre>

<p>}</p>

<p>% @ifset VAR … @end ifset reads the `…‘ iff VAR has been defined % with
@set. % % To get special treatment of `@end ifset,’ call makeond and the
redefine. % makecond{ifset} defifset{parsearg{doifset{letnext=ifsetfail}}}
defdoifset#1#2{%</p>

<pre>{%
  \makevalueexpandable
  \let\next=\empty
  \expandafter\ifx\csname SET#2\endcsname\relax
    #1% If not set, redefine \next.
  \fi
  \expandafter
}\next</pre>

<p>} defifsetfail{doignore{ifset}}</p>

<p>% @ifclear VAR … @end ifclear reads the `…‘ iff VAR has never been %
defined with @set, or has been undefined with @clear. % % The `else’ inside
the `doifset’ parameter is a trick to reuse the % above code: if the
variable is not set, do nothing, if it is set, % then redefine next to
ifclearfail. % makecond{ifclear} defifclear{parsearg{doifset{else
letnext=ifclearfail}}} defifclearfail{doignore{ifclear}}</p>

<p>% @dircategory CATEGORY  – specify a category of the dir file % which this
file should belong to.  Ignore this in TeX. letdircategory=comment</p>

<p>% @defininfoenclose. letdefinfoenclose=comment</p>

<p>message{indexing,} % Index generation facilities</p>

<p>% Define newwrite to be identical to plain tex’s newwrite % except not
outer, so it can be used within macros and if’s.
edefnewwrite{makecsname{ptexnewwrite}}</p>

<p>% newindex {foo} defines an index named foo. % It automatically defines
fooindex such that % fooindex …rest of line… puts an entry in the index
foo. % It also defines fooindfile to be the number of the output channel
for % the file that accumulates this index.  The file’s extension is foo. %
The name of an index should be no more than 2 characters long % for the
sake of vms. % defnewindex#1{%</p>

<pre>\iflinks
  \expandafter\newwrite \csname#1indfile\endcsname
  \openout \csname#1indfile\endcsname \jobname.#1 % Open the file
\fi
\expandafter\xdef\csname#1index\endcsname{%     % Define @#1index
  \noexpand\doindex{#1}}</pre>

<p>}</p>

<p>% @defindex foo  ==  newindex{foo} % defdefindex{parseargnewindex}</p>

<p>% Define @defcodeindex, like @defindex except put all entries in @code. %
defdefcodeindex{parseargnewcodeindex} % defnewcodeindex#1{%</p>

<pre>\iflinks
  \expandafter\newwrite \csname#1indfile\endcsname
  \openout \csname#1indfile\endcsname \jobname.#1
\fi
\expandafter\xdef\csname#1index\endcsname{%
  \noexpand\docodeindex{#1}}%</pre>

<p>}</p>

<p>% @synindex foo bar    makes index foo feed into index bar. % Do this
instead of @defindex foo if you don’t want it as a separate index. % %
@syncodeindex foo bar   similar, but put all entries made for index foo %
inside @code. % defsynindex#1 #2 {dosynindexdoindex{#1}{#2}}
defsyncodeindex#1 #2 {dosynindexdocodeindex{#1}{#2}}</p>

<p>% #1 is doindex or docodeindex, #2 the index getting redefined (foo), % #3
the target index (bar). defdosynindex#1#2#3{%</p>

<pre>% Only do \closeout if we haven't already done it, else we'll end up
% closing the target index.
\expandafter \ifx\csname donesynindex#2\endcsname \undefined
  % The \closeout helps reduce unnecessary open files; the limit on the
  % Acorn RISC OS is a mere 16 files.
  \expandafter\closeout\csname#2indfile\endcsname
  \expandafter\let\csname\donesynindex#2\endcsname = 1
\fi
% redefine \fooindfile:
\expandafter\let\expandafter\temp\expandafter=\csname#3indfile\endcsname
\expandafter\let\csname#2indfile\endcsname=\temp
% redefine \fooindex:
\expandafter\xdef\csname#2index\endcsname{\noexpand#1{#3}}%</pre>

<p>}</p>

<p>% Define doindex, the driver for all fooindex macros. % Argument #1 is
generated by the calling fooindex macro, %  and it is “foo”, the name of
the index.</p>

<p>% doindex just uses parsearg; it calls doind for the actual work. % This is
because doind is more useful to call from other macros.</p>

<p>% There is also dosubind {index}{topic}{subtopic} % which makes an entry in
a two-level index such as the operation index.</p>

<p>defdoindex#1{edefindexname{#1}parseargsingleindexer} defsingleindexer
#1{doind{indexname}{#1}}</p>

<p>% like the previous two, but they put @code around the argument.
defdocodeindex#1{edefindexname{#1}parseargsinglecodeindexer}
defsinglecodeindexer #1{doind{indexname}{code{#1}}}</p>

<p>% Take care of Texinfo commands that can appear in an index entry. % Since
there are some commands we want to expand, and others we don’t, % we have
to laboriously prevent expansion for those that we don’t. %
defindexdummies{%</p>

<pre>\escapechar = `\\     % use backslash in output files.
\def\@{@}% change to @@ when we switch to @ as escape char in index files.
\def\ {\realbackslash\space }%
% Need these in case \tex is in effect and \{ is a \delimiter again.
% But can't use \lbracecmd and \rbracecmd because texindex assumes
% braces and backslashes are used only as delimiters.
\let\{ = \mylbrace
\let\} = \myrbrace
%
% Do the redefinitions.
\commondummies</pre>

<p>}</p>

<p>% For the aux and toc files, @ is the escape character.  So we want to %
redefine everything using @ as the escape character (instead of %
realbackslash, still used for index files).  When everything uses @, % this
will be simpler. % defatdummies{%</p>

<pre>\def\@{@@}%
\def\ {@ }%
\let\{ = \lbraceatcmd
\let\} = \rbraceatcmd
%
% Do the redefinitions.
\commondummies</pre>

<p>}</p>

<p>% Called from indexdummies and atdummies. % defcommondummies{%</p>

<pre>%
% \definedummyword defines \#1 as \string\#1\space, thus effectively
% preventing its expansion.  This is used only for control% words,
% not control letters, because the \space would be incorrect for
% control characters, but is needed to separate the control word
% from whatever follows.
%
% For control letters, we have \definedummyletter, which omits the
% space.
%
% These can be used both for control words that take an argument and
% those that do not.  If it is followed by {arg} in the input, then
% that will dutifully get written to the index (or wherever).
%
\def\definedummyword  ##1{\def##1{\string##1\space}}%
\def\definedummyletter##1{\def##1{\string##1}}%
\let\definedummyaccent\definedummyletter
%
\commondummiesnofonts
%
\definedummyletter\_%
%
% Non-English letters.
\definedummyword\AA
\definedummyword\AE
\definedummyword\L
\definedummyword\OE
\definedummyword\O
\definedummyword\aa
\definedummyword\ae
\definedummyword\l
\definedummyword\oe
\definedummyword\o
\definedummyword\ss
\definedummyword\exclamdown
\definedummyword\questiondown
\definedummyword\ordf
\definedummyword\ordm
%
% Although these internal commands shouldn't show up, sometimes they do.
\definedummyword\bf
\definedummyword\gtr
\definedummyword\hat
\definedummyword\less
\definedummyword\sf
\definedummyword\sl
\definedummyword\tclose
\definedummyword\tt
%
\definedummyword\LaTeX
\definedummyword\TeX
%
% Assorted special characters.
\definedummyword\bullet
\definedummyword\comma
\definedummyword\copyright
\definedummyword\registeredsymbol
\definedummyword\dots
\definedummyword\enddots
\definedummyword\equiv
\definedummyword\error
\definedummyword\euro
\definedummyword\expansion
\definedummyword\minus
\definedummyword\pounds
\definedummyword\point
\definedummyword\print
\definedummyword\result
%
% We want to disable all macros so that they are not expanded by \write.
\macrolist
%
\normalturnoffactive
%
% Handle some cases of @value -- where it does not contain any
% (non-fully-expandable) commands.
\makevalueexpandable</pre>

<p>}</p>

<p>% commondummiesnofonts: common to commondummies and indexnofonts. % %
Better have this without active chars. {</p>

<pre>\catcode`\~=\other
\gdef\commondummiesnofonts{%
  % Control letters and accents.
  \definedummyletter\!%
  \definedummyaccent\&quot;%
  \definedummyaccent\'%
  \definedummyletter\*%
  \definedummyaccent\,%
  \definedummyletter\.%
  \definedummyletter\/%
  \definedummyletter\:%
  \definedummyaccent\=%
  \definedummyletter\?%
  \definedummyaccent\^%
  \definedummyaccent\`%
  \definedummyaccent\~%
  \definedummyword\u
  \definedummyword\v
  \definedummyword\H
  \definedummyword\dotaccent
  \definedummyword\ringaccent
  \definedummyword\tieaccent
  \definedummyword\ubaraccent
  \definedummyword\udotaccent
  \definedummyword\dotless
  %
  % Texinfo font commands.
  \definedummyword\b
  \definedummyword\i
  \definedummyword\r
  \definedummyword\sc
  \definedummyword\t
  %
  % Commands that take arguments.
  \definedummyword\acronym
  \definedummyword\cite
  \definedummyword\code
  \definedummyword\command
  \definedummyword\dfn
  \definedummyword\emph
  \definedummyword\env
  \definedummyword\file
  \definedummyword\kbd
  \definedummyword\key
  \definedummyword\math
  \definedummyword\option
  \definedummyword\samp
  \definedummyword\strong
  \definedummyword\tie
  \definedummyword\uref
  \definedummyword\url
  \definedummyword\var
  \definedummyword\verb
  \definedummyword\w
}</pre>

<p>}</p>

<p>% indexnofonts is used when outputting the strings to sort the index % by,
and when constructing control sequence names.  It eliminates all % control
sequences and just writes whatever the best ASCII sort string % would be
for a given command (usually its argument). % defindexnofonts{%</p>

<pre class="ruby"><span class="ruby-string">%QAccent </span><span class="ruby-identifier">commands</span> <span class="ruby-identifier">should</span> <span class="ruby-identifier">become</span> <span class="ruby-ivar">@asis</span>.
\<span class="ruby-identifier">def</span>\<span class="ruby-identifier">definedummyaccent</span><span class="ruby-comment">##1{\let##1\asis}%</span>
<span class="ruby-string">%QWe </span><span class="ruby-identifier">can</span> <span class="ruby-identifier">just</span> <span class="ruby-identifier">ignore</span> <span class="ruby-identifier">other</span> <span class="ruby-identifier">control</span> <span class="ruby-identifier">letters</span>.
\<span class="ruby-identifier">def</span>\<span class="ruby-identifier">definedummyletter</span><span class="ruby-comment">##1{\let##1\empty}%</span>
<span class="ruby-string">%QHopefully, </span><span class="ruby-identifier">all</span> <span class="ruby-identifier">control</span> <span class="ruby-identifier">words</span> <span class="ruby-identifier">can</span> <span class="ruby-identifier">become</span> <span class="ruby-ivar">@asis</span>.
\<span class="ruby-identifier">let</span>\<span class="ruby-identifier">definedummyword</span>\<span class="ruby-identifier">definedummyaccent</span>
<span class="ruby-string">%Q\cmmondummiesnofonts
</span><span class="ruby-operator">%</span>
<span class="ruby-string">%QDon't </span><span class="ruby-identifier">no</span><span class="ruby-operator">-</span><span class="ruby-identifier">op</span> \<span class="ruby-identifier">tt</span>, <span class="ruby-identifier">since</span> <span class="ruby-identifier">it</span> <span class="ruby-identifier">isn</span><span class="ruby-string">'t a user-level command
% and is used in the definitions of the active chars like &lt;, &gt;, |, etc.
% Likewise with the other plain tex font commands.
%\let\tt=\asis
%
\def\ { }%
\def\@{@}%
% how to handle braces?
\def\_{\normalunderscore}%
%
% Non-English letters.
\def\AA{AA}%
\def\AE{AE}%
\def\L{L}%
\def\OE{OE}%
\def\O{O}%
\def\aa{aa}%
\def\ae{ae}%
\def\l{l}%
\def\oe{oe}%
\def\o{o}%
\def\ss{ss}%
\def\exclamdown{!}%
\def\questiondown{?}%
\def\ordf{a}%
\def\ordm{o}%
%
\def\LaTeX{LaTeX}%
\def\TeX{TeX}%
%
% Assorted special characters.
% (The following {} will end up in the sort string, but that'</span><span class="ruby-identifier">s</span> <span class="ruby-identifier">ok</span>.)
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">bullet</span>{<span class="ruby-identifier">bullet</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">comma</span>{,}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">copyright</span>{<span class="ruby-identifier">copyright</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">registeredsymbol</span>{<span class="ruby-constant">R</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">dots</span>{<span class="ruby-operator">...</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">enddots</span>{<span class="ruby-operator">...</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">equiv</span>{<span class="ruby-operator">==</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">error</span>{<span class="ruby-identifier">error</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">euro</span>{<span class="ruby-identifier">euro</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">expansion</span>{<span class="ruby-operator">==</span><span class="ruby-operator">&gt;</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">minus</span>{<span class="ruby-operator">-</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">pounds</span>{<span class="ruby-identifier">pounds</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">point</span>{.}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">print</span>{<span class="ruby-operator">-</span><span class="ruby-operator">|</span>}<span class="ruby-operator">%</span>
\<span class="ruby-keyword">def</span>\<span class="ruby-identifier">result</span>{=<span class="ruby-operator">&gt;</span>}<span class="ruby-operator">%</span>
<span class="ruby-string">%Q% We need to get rid of all macros, leaving only the arguments (if present).
</span><span class="ruby-operator">%</span> <span class="ruby-constant">Of</span> <span class="ruby-identifier">course</span> <span class="ruby-identifier">this</span> <span class="ruby-identifier">is</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">nearly</span> <span class="ruby-identifier">correct</span>, <span class="ruby-identifier">but</span> <span class="ruby-identifier">it</span> <span class="ruby-identifier">is</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">best</span> <span class="ruby-identifier">we</span> <span class="ruby-identifier">can</span> <span class="ruby-keyword">do</span> <span class="ruby-keyword">for</span> <span class="ruby-identifier">now</span>.
<span class="ruby-operator">%</span> <span class="ruby-identifier">makeinfo</span> <span class="ruby-identifier">does</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">expand</span> <span class="ruby-identifier">macros</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">argument</span> <span class="ruby-identifier">to</span> <span class="ruby-ivar">@deffn</span>, <span class="ruby-identifier">which</span> <span class="ruby-identifier">ends</span> <span class="ruby-identifier">up</span>
<span class="ruby-string">%Qwriting </span><span class="ruby-identifier">an</span> <span class="ruby-identifier">index</span> <span class="ruby-identifier">entry</span>, <span class="ruby-keyword">and</span> <span class="ruby-identifier">texindex</span> <span class="ruby-identifier">isn</span><span class="ruby-string">'t prepared for an index sort entry
% that starts with \.
% 
% Since macro invocations are followed by braces, we can just redefine them
% to take a single TeX argument.  The case of a macro invocation that
% goes to end-of-line is not handled.
% 
\macrolist
</span></pre>

<p>}</p>

<p>letindexbackslash=0  %overridden during printindex. letSETmarginindex=relax
% put index entries in margin (undocumented)?</p>

<p>% Most index entries go through here, but dosubind is the general case. %
#1 is the index name, #2 is the entry text.
defdoind#1#2{dosubind{#1}{#2}{}}</p>

<p>% Workhorse for all fooindexes. % #1 is name of index, #2 is stuff to put
there, #3 is subentry – % empty if called from doind, as we usually are
(the main exception % is with most defuns, which call us directly). %
defdosubind#1#2#3{%</p>

<pre>\iflinks
{%
  % Store the main index entry text (including the third arg).
  \toks0 = {#2}%
  % If third arg is present, precede it with a space.
  \def\thirdarg{#3}%
  \ifx\thirdarg\empty \else
    \toks0 = \expandafter{\the\toks0 \space #3}%
  \fi
  %
  \edef\writeto{\csname#1indfile\endcsname}%
  %
  \ifvmode
    \dosubindsanitize
  \else
    \dosubindwrite
  \fi
}%
\fi</pre>

<p>}</p>

<p>% Write the entry in toks0 to the index file: % defdosubindwrite{%</p>

<pre>% Put the index entry in the margin if desired.
\ifx\SETmarginindex\relax\else
  \insert\margin{\hbox{\vrule height8pt depth3pt width0pt \the\toks0}}%
\fi
%
% Remember, we are within a group.
\indexdummies % Must do this here, since \bf, etc expand at this stage
\def\backslashcurfont{\indexbackslash}% \indexbackslash isn't defined now
    % so it will be output as is; and it will print as backslash.
%
% Process the index entry with all font commands turned off, to
% get the string to sort by.
{\indexnofonts
 \edef\temp{\the\toks0}% need full expansion
 \xdef\indexsorttmp{\temp}%
}%
%
% Set up the complete index entry, with both the sort key and
% the original text, including any font commands.  We write
% three arguments to \entry to the .?? file (four in the
% subentry case), texindex reduces to two when writing the .??s
% sorted result.
\edef\temp{%
  \write\writeto{%
    \string\entry{\indexsorttmp}{\noexpand\folio}{\the\toks0}}%
}%
\temp</pre>

<p>}</p>

<p>% Take care of unwanted page breaks: % % If a skip is the last thing on the
list now, preserve it % by backing up by lastskip, doing the write, then
inserting % the skip again.  Otherwise, the whatsit generated by the %
write will make lastskip zero.  The result is that sequences % like this: %
@end defun % @tindex whatever % @defun … % will have extra space inserted,
because the medbreak in the % start of the @defun won’t see the skip
inserted by the @end of % the previous defun. % % But don’t do any of this
if we’re not in vertical mode.  We % don’t want to do a vskip and
prematurely end a paragraph. % % Avoid page breaks due to these extra
skips, too. % % But wait, there is a catch there: % We’ll have to check
whether lastskip is zero skip.  ifdim is not % sufficient for this purpose,
as it ignores stretch and shrink parts % of the skip.  The only way seems
to be to check the textual % representation of the skip. % % The following
is almost like defzeroskipmacro{0.0pt} except that % the “p” and “t”
characters have catcode other, not 11 (letter). %
edefzeroskipmacro{expandafterthecsname z@skipendcsname} % % …, ready, GO: %
defdosubindsanitize{%</p>

<pre>% \lastskip and \lastpenalty cannot both be nonzero simultaneously.
\skip0 = \lastskip
\edef\lastskipmacro{\the\lastskip}%
\count255 = \lastpenalty
%
% If \lastskip is nonzero, that means the last item was a
% skip.  And since a skip is discardable, that means this
% -\skip0 glue we're inserting is preceded by a
% non-discardable item, therefore it is not a potential
% breakpoint, therefore no \nobreak needed.
\ifx\lastskipmacro\zeroskipmacro
\else
  \vskip-\skip0
\fi
%
\dosubindwrite
%
\ifx\lastskipmacro\zeroskipmacro
  % If \lastskip was zero, perhaps the last item was a penalty, and
  % perhaps it was &gt;=10000, e.g., a \nobreak.  In that case, we want
  % to re-insert the same penalty (values &gt;10000 are used for various
  % signals); since we just inserted a non-discardable item, any
  % following glue (such as a \parskip) would be a breakpoint.  For example:
  % 
  %   @deffn deffn-whatever
  %   @vindex index-whatever
  %   Description.
  % would allow a break between the index-whatever whatsit
  % and the &quot;Description.&quot; paragraph.
  \ifnum\count255&gt;9999 \penalty\count255 \fi
\else
  % On the other hand, if we had a nonzero \lastskip,
  % this make-up glue would be preceded by a non-discardable item
  % (the whatsit from the \write), so we must insert a \nobreak.
  \nobreak\vskip\skip0
\fi</pre>

<p>}</p>

<p>% The index entry written in the file actually looks like %  entry
{sortstring}{page}{topic} % or %  entry {sortstring}{page}{topic}{subtopic}
% The texindex program reads in these files and writes files % containing
these kinds of lines: %  initial {c} %     before the first topic whose
initial is c %  entry {topic}{pagelist} %     for a topic that is used
without subtopics %  primary {topic} %     for the beginning of a topic
that is used with subtopics %  secondary {subtopic}{pagelist} %     for
each subtopic.</p>

<p>% Define the user-accessible indexing commands % @findex, @vindex, @kindex,
@cindex.</p>

<p>deffindex {fnindex} defkindex {kyindex} defcindex {cpindex} defvindex
{vrindex} deftindex {tpindex} defpindex {pgindex}</p>

<p>defcindexsub {begingroupobeylinescindexsub} {obeylines % gdefcindexsub “#1”
#2^^M{endgroup % dosubind{cp}{#2}{#1}}}</p>

<p>% Define the macros used in formatting output of the sorted index material.</p>

<p>% @printindex causes a particular index (the ??s file) to get printed. % It
does not print any chapter heading (usually an @unnumbered). %
parseargdefprintindex{begingroup</p>

<pre>\dobreak \chapheadingskip{10000}%
%
\smallfonts \rm
\tolerance = 9500
\everypar = {}% don't want the \kern\-parindent from indentation suppression.
%
% See if the index file exists and is nonempty.
% Change catcode of @ here so that if the index file contains
% \initial {@}
% as its first line, TeX doesn't complain about mismatched braces
% (because it thinks @} is a control sequence).
\catcode`\@ = 11
\openin 1 \jobname.#1s
\ifeof 1
  % \enddoublecolumns gets confused if there is no text in the index,
  % and it loses the chapter title and the aux file entries for the
  % index.  The easiest way to prevent this problem is to make sure
  % there is some text.
  \putwordIndexNonexistent
\else
  %
  % If the index file exists but is empty, then \openin leaves \ifeof
  % false.  We have to make TeX try to read something from the file, so
  % it can discover if there is anything in it.
  \read 1 to \temp
  \ifeof 1
    \putwordIndexIsEmpty
  \else
    % Index files are almost Texinfo source, but we use \ as the escape
    % character.  It would be better to use @, but that's too big a change
    % to make right now.
    \def\indexbackslash{\backslashcurfont}%
    \catcode`\\ = 0
    \escapechar = `\\
    \begindoublecolumns
    \input \jobname.#1s
    \enddoublecolumns
  \fi
\fi
\closein 1</pre>

<p>endgroup}</p>

<p>% These macros are used by the sorted index file itself. % Change them to
control the appearance of the index.</p>

<p>definitial#1{{%</p>

<pre>% Some minor font changes for the special characters.
\let\tentt=\sectt \let\tt=\sectt \let\sf=\sectt
%
% Remove any glue we may have, we'll be inserting our own.
\removelastskip
%
% We like breaks before the index initials, so insert a bonus.
\nobreak
\vskip 0pt plus 3\baselineskip
\penalty 0
\vskip 0pt plus -3\baselineskip
%
% Typeset the initial.  Making this add up to a whole number of
% baselineskips increases the chance of the dots lining up from column
% to column.  It still won't often be perfect, because of the stretch
% we need before each entry, but it's better.
%
% No shrink because it confuses \balancecolumns.
\vskip 1.67\baselineskip plus .5\baselineskip
\leftline{\secbf #1}%
% Do our best not to break after the initial.
\nobreak
\vskip .33\baselineskip plus .1\baselineskip</pre>

<p>}}</p>

<p>% entry typesets a paragraph consisting of the text (#1), dot leaders, and
% then page number (#2) flushed to the right margin.  It is used for index
% and table of contents entries.  The paragraph is indented by leftskip. %
% A straightforward implementation would start like this: %      
defentry#1#2{… % But this frozes the catcodes in the argument, and can
cause problems to % @code, which sets - active.  This problem was fixed by
a kludge— % “-” was active throughout whole index, but this isn’t really
right. % % The right solution is to prevent entry from swallowing the whole
text. %                                 –kasal, 21nov03 defentry{%</p>

<pre>\begingroup
  %
  % Start a new paragraph if necessary, so our assignments below can't
  % affect previous text.
  \par
  %
  % Do not fill out the last line with white space.
  \parfillskip = 0in
  %
  % No extra space above this paragraph.
  \parskip = 0in
  %
  % Do not prefer a separate line ending with a hyphen to fewer lines.
  \finalhyphendemerits = 0
  %
  % \hangindent is only relevant when the entry text and page number
  % don't both fit on one line.  In that case, bob suggests starting the
  % dots pretty far over on the line.  Unfortunately, a large
  % indentation looks wrong when the entry text itself is broken across
  % lines.  So we use a small indentation and put up with long leaders.
  %
  % \hangafter is reset to 1 (which is the value we want) at the start
  % of each paragraph, so we need not do anything with that.
  \hangindent = 2em
  %
  % When the entry text needs to be broken, just fill out the first line
  % with blank space.
  \rightskip = 0pt plus1fil
  %
  % A bit of stretch before each entry for the benefit of balancing
  % columns.
  \vskip 0pt plus1pt
  %
  % Swallow the left brace of the text (first parameter):
  \afterassignment\doentry
  \let\temp =</pre>

<p>} defdoentry{%</p>

<pre>\bgroup % Instead of the swallowed brace.
  \noindent
  \aftergroup\finishentry
  % And now comes the text of the entry.</pre>

<p>} deffinishentry#1{%</p>

<pre>  % #1 is the page number.
  %
  % The following is kludged to not output a line of dots in the index if
  % there are no page numbers.  The next person who breaks this will be
  % cursed by a Unix daemon.
  \def\tempa{{\rm }}%
  \def\tempb{#1}%
  \edef\tempc{\tempa}%
  \edef\tempd{\tempb}%
  \ifx\tempc\tempd
    \ %
  \else
    %
    % If we must, put the page number on a line of its own, and fill out
    % this line with blank space.  (The \hfil is overwhelmed with the
    % fill leaders glue in \indexdotfill if the page number does fit.)
    \hfil\penalty50
    \null\nobreak\indexdotfill % Have leaders before the page number.
    %
    % The `\ ' here is removed by the implicit \unskip that TeX does as
    % part of (the primitive) \par.  Without it, a spurious underfull
    % \hbox ensues.
    \ifpdf
      \pdfgettoks#1.%
      \ \the\toksA
    \else
      \ #1%
    \fi
  \fi
  \par
\endgroup</pre>

<p>}</p>

<p>% Like dotfill except takes at least 1 em. defindexdotfill{cleaders</p>

<pre>\hbox{$\mathsurround=0pt \mkern1.5mu ${\it .}$ \mkern1.5mu$}\hskip 1em plus 1fill}</pre>

<p>defprimary #1{line{#1hfil}}</p>

<p>newskipsecondaryindent secondaryindent=0.5cm defsecondary#1#2{{%</p>

<pre>\parfillskip=0in
\parskip=0in
\hangindent=1in
\hangafter=1
\noindent\hskip\secondaryindent\hbox{#1}\indexdotfill
\ifpdf
  \pdfgettoks#2.\ \the\toksA % The page number ends the paragraph.
\else
  #2
\fi
\par</pre>

<p>}}</p>

<p>% Define two-column mode, which we use to typeset indexes. % Adapted from
the TeXbook, page 416, which is to say, % the manmac.tex format used to
print the TeXbook itself. catcode`@=11</p>

<p>newboxpartialpage newdimendoublecolumnhsize</p>

<p>defbegindoublecolumns{begingroup % ended by enddoublecolumns</p>

<pre>% Grab any single-column material above us.
\output = {%
  %
  % Here is a possibility not foreseen in manmac: if we accumulate a
  % whole lot of material, we might end up calling this \output
  % routine twice in a row (see the doublecol-lose test, which is
  % essentially a couple of indexes with @setchapternewpage off).  In
  % that case we just ship out what is in \partialpage with the normal
  % output routine.  Generally, \partialpage will be empty when this
  % runs and this will be a no-op.  See the indexspread.tex test case.
  \ifvoid\partialpage \else
    \onepageout{\pagecontents\partialpage}%
  \fi
  %
  \global\setbox\partialpage = \vbox{%
    % Unvbox the main output page.
    \unvbox\PAGE
    \kern-\topskip \kern\baselineskip
  }%
}%
\eject % run that output routine to set \partialpage
%
% Use the double-column output routine for subsequent pages.
\output = {\doublecolumnout}%
%
% Change the page size parameters.  We could do this once outside this
% routine, in each of @smallbook, @afourpaper, and the default 8.5x11
% format, but then we repeat the same computation.  Repeating a couple
% of assignments once per index is clearly meaningless for the
% execution time, so we may as well do it in one place.
%
% First we halve the line length, less a little for the gutter between
% the columns.  We compute the gutter based on the line length, so it
% changes automatically with the paper format.  The magic constant
% below is chosen so that the gutter has the same value (well, +-&lt;1pt)
% as it did when we hard-coded it.
%
% We put the result in a separate register, \doublecolumhsize, so we
% can restore it in \pagesofar, after \hsize itself has (potentially)
% been clobbered.
%
\doublecolumnhsize = \hsize
  \advance\doublecolumnhsize by -.04154\hsize
  \divide\doublecolumnhsize by 2
\hsize = \doublecolumnhsize
%
% Double the \vsize as well.  (We don't need a separate register here,
% since nobody clobbers \vsize.)
\vsize = 2\vsize</pre>

<p>}</p>

<p>% The double-column output routine for all double-column pages except % the
last. % defdoublecolumnout{%</p>

<pre>\splittopskip=\topskip \splitmaxdepth=\maxdepth
% Get the available space for the double columns -- the normal
% (undoubled) page height minus any material left over from the
% previous page.
\dimen@ = \vsize
\divide\dimen@ by 2
\advance\dimen@ by -\ht\partialpage
%
% box0 will be the left-hand column, box2 the right.
\setbox0=\vsplit255 to\dimen@ \setbox2=\vsplit255 to\dimen@
\onepageout\pagesofar
\unvbox255
\penalty\outputpenalty</pre>

<p>} % % Re-output the contents of the output page – any previous material, %
followed by the two boxes we just split, in box0 and box2. defpagesofar{%</p>

<pre>\unvbox\partialpage
%
\hsize = \doublecolumnhsize
\wd0=\hsize \wd2=\hsize
\hbox to\pagewidth{\box0\hfil\box2}%</pre>

<p>} % % All done with double columns. defenddoublecolumns{%</p>

<pre>\output = {%
  % Split the last of the double-column material.  Leave it on the
  % current page, no automatic page break.
  \balancecolumns
  %
  % If we end up splitting too much material for the current page,
  % though, there will be another page break right after this \output
  % invocation ends.  Having called \balancecolumns once, we do not
  % want to call it again.  Therefore, reset \output to its normal
  % definition right away.  (We hope \balancecolumns will never be
  % called on to balance too much material, but if it is, this makes
  % the output somewhat more palatable.)
  \global\output = {\onepageout{\pagecontents\PAGE}}%
}%
\eject
\endgroup % started in \begindoublecolumns
%
% \pagegoal was set to the doubled \vsize above, since we restarted
% the current page.  We're now back to normal single-column
% typesetting, so reset \pagegoal to the normal \vsize (after the
% \endgroup where \vsize got restored).
\pagegoal = \vsize</pre>

<p>} % % Called at the end of the double column material. defbalancecolumns{%</p>

<pre>\setbox0 = \vbox{\unvbox255}% like \box255 but more efficient, see p.120.
\dimen@ = \ht0
\advance\dimen@ by \topskip
\advance\dimen@ by-\baselineskip
\divide\dimen@ by 2 % target to split to
%debug\message{final 2-column material height=\the\ht0, target=\the\dimen@.}%
\splittopskip = \topskip
% Loop until we get a decent breakpoint.
{%
  \vbadness = 10000
  \loop
    \global\setbox3 = \copy0
    \global\setbox1 = \vsplit3 to \dimen@
  \ifdim\ht3&gt;\dimen@
    \global\advance\dimen@ by 1pt
  \repeat
}%
%debug\message{split to \the\dimen@, column heights: \the\ht1, \the\ht3.}%
\setbox0=\vbox to\dimen@{\unvbox1}%
\setbox2=\vbox to\dimen@{\unvbox3}%
%
\pagesofar</pre>

<p>} catcode`@ = other</p>

<p>message{sectioning,} % Chapters, sections, etc.</p>

<p>% unnumberedno is an oxymoron, of course.  But we count the unnumbered %
sections so that we can refer to them unambiguously in the pdf % outlines
by their “section number”.  We avoid collisions with chapter % numbers by
starting them at 10000.  (If a document ever has 10000 % chapters, we’re in
trouble anyway, I’m sure.) newcountunnumberedno unnumberedno = 10000
newcountchapno newcountsecno        secno=0 newcountsubsecno     subsecno=0
newcountsubsubsecno  subsubsecno=0</p>

<p>% This counter is funny since it counts through charcodes of letters A, B,
… newcountappendixno  appendixno = `@ % %
defappendixletter{chartheappendixno} % We do the following ugly conditional
instead of the above simple % construct for the sake of pdftex, which needs
the actual % letter in the expansion, not just typeset. %
defappendixletter{%</p>

<pre>\ifnum\appendixno=`A A%
\else\ifnum\appendixno=`B B%
\else\ifnum\appendixno=`C C%
\else\ifnum\appendixno=`D D%
\else\ifnum\appendixno=`E E%
\else\ifnum\appendixno=`F F%
\else\ifnum\appendixno=`G G%
\else\ifnum\appendixno=`H H%
\else\ifnum\appendixno=`I I%
\else\ifnum\appendixno=`J J%
\else\ifnum\appendixno=`K K%
\else\ifnum\appendixno=`L L%
\else\ifnum\appendixno=`M M%
\else\ifnum\appendixno=`N N%
\else\ifnum\appendixno=`O O%
\else\ifnum\appendixno=`P P%
\else\ifnum\appendixno=`Q Q%
\else\ifnum\appendixno=`R R%
\else\ifnum\appendixno=`S S%
\else\ifnum\appendixno=`T T%
\else\ifnum\appendixno=`U U%
\else\ifnum\appendixno=`V V%
\else\ifnum\appendixno=`W W%
\else\ifnum\appendixno=`X X%
\else\ifnum\appendixno=`Y Y%
\else\ifnum\appendixno=`Z Z%
% The \the is necessary, despite appearances, because \appendixletter is
% expanded while writing the .toc file.  \char\appendixno is not
% expandable, thus it is written literally, thus all appendixes come out
% with the same letter (or @) in the toc without it.
\else\char\the\appendixno
\fi\fi\fi\fi\fi\fi\fi\fi\fi\fi\fi\fi\fi
\fi\fi\fi\fi\fi\fi\fi\fi\fi\fi\fi\fi\fi}</pre>

<p>% Each @chapter defines this as the name of the chapter. % page headings
and footings can use it.  @section does likewise. % However, they are not
reliable, because we don’t use marks. defthischapter{} defthissection{}</p>

<p>newcountabsseclevel % used to calculate proper heading level
newcountsecbasesecbase=0 % @raisesections/@lowersections modify this count</p>

<p>% @raisesections: treat @section as chapter, @subsection as section, etc.
defraisesections{globaladvancesecbase by -1} letup=raisesections % original
BFox name</p>

<p>% @lowersections: treat @chapter as section, @section as subsection, etc.
deflowersections{globaladvancesecbase by 1} letdown=lowersections %
original BFox name</p>

<p>% we only have subsub. chardefmaxseclevel = 3 % % A numbered section within
an unnumbered changes to unnumbered too. % To achive this, remember the
“biggest” unnum. sec. we are currently in: chardefunmlevel = maxseclevel %
% Trace whether the current chapter is an appendix or not: % chapheadtype
is “N” or “A”, unnumbered chapters are ignored. defchapheadtype{N}</p>

<p>% Choose a heading macro % #1 is heading type % #2 is heading level % #3 is
text for heading defgenhead#1#2#3{%</p>

<pre>% Compute the abs. sec. level:
\absseclevel=#2
\advance\absseclevel by \secbase
% Make sure \absseclevel doesn't fall outside the range:
\ifnum \absseclevel &lt; 0
  \absseclevel = 0
\else
  \ifnum \absseclevel &gt; 3
    \absseclevel = 3
  \fi
\fi
% The heading type:
\def\headtype{#1}%
\if \headtype U%
  \ifnum \absseclevel &lt; \unmlevel
    \chardef\unmlevel = \absseclevel
  \fi
\else
  % Check for appendix sections:
  \ifnum \absseclevel = 0
    \edef\chapheadtype{\headtype}%
  \else
    \if \headtype A\if \chapheadtype N%
      \errmessage{@appendix... within a non-appendix chapter}%
    \fi\fi
  \fi
  % Check for numbered within unnumbered:
  \ifnum \absseclevel &gt; \unmlevel
    \def\headtype{U}%
  \else
    \chardef\unmlevel = 3
  \fi
\fi
% Now print the heading:
\if \headtype U%
  \ifcase\absseclevel
      \unnumberedzzz{#3}%
  \or \unnumberedseczzz{#3}%
  \or \unnumberedsubseczzz{#3}%
  \or \unnumberedsubsubseczzz{#3}%
  \fi
\else
  \if \headtype A%
    \ifcase\absseclevel
        \appendixzzz{#3}%
    \or \appendixsectionzzz{#3}%
    \or \appendixsubseczzz{#3}%
    \or \appendixsubsubseczzz{#3}%
    \fi
  \else
    \ifcase\absseclevel
        \chapterzzz{#3}%
    \or \seczzz{#3}%
    \or \numberedsubseczzz{#3}%
    \or \numberedsubsubseczzz{#3}%
    \fi
  \fi
\fi
\suppressfirstparagraphindent</pre>

<p>}</p>

<p>% an interface: defnumhead{genhead N} defapphead{genhead A}
defunnmhead{genhead U}</p>

<p>% @chapter, @appendix, @unnumbered.  Increment top-level counter, reset %
all lower-level sectioning counters to zero. % % Also set chaplevelprefix,
which we prepend to @float sequence numbers % (e.g., figures), q.v.  By
default (before any chapter), that is empty. letchaplevelprefix = empty %
outerparseargdefchapter{numhead0{#1}} % normally numhead0 calls chapterzzz
defchapterzzz#1{%</p>

<pre>% section resetting is \global in case the chapter is in a group, such
% as an @include file.
\global\secno=0 \global\subsecno=0 \global\subsubsecno=0
  \global\advance\chapno by 1
%
% Used for \float.
\gdef\chaplevelprefix{\the\chapno.}%
\resetallfloatnos
%
\message{\putwordChapter\space \the\chapno}%
%
% Write the actual heading.
\chapmacro{#1}{Ynumbered}{\the\chapno}%
%
% So @section and the like are numbered underneath this chapter.
\global\let\section = \numberedsec
\global\let\subsection = \numberedsubsec
\global\let\subsubsection = \numberedsubsubsec</pre>

<p>}</p>

<p>outerparseargdefappendix{apphead0{#1}} % normally apphead0 calls
appendixzzz defappendixzzz#1{%</p>

<pre>\global\secno=0 \global\subsecno=0 \global\subsubsecno=0
  \global\advance\appendixno by 1
\gdef\chaplevelprefix{\appendixletter.}%
\resetallfloatnos
%
\def\appendixnum{\putwordAppendix\space \appendixletter}%
\message{\appendixnum}%
%
\chapmacro{#1}{Yappendix}{\appendixletter}%
%
\global\let\section = \appendixsec
\global\let\subsection = \appendixsubsec
\global\let\subsubsection = \appendixsubsubsec</pre>

<p>}</p>

<p>outerparseargdefunnumbered{unnmhead0{#1}} % normally unnmhead0 calls
unnumberedzzz defunnumberedzzz#1{%</p>

<pre>\global\secno=0 \global\subsecno=0 \global\subsubsecno=0
  \global\advance\unnumberedno by 1
%
% Since an unnumbered has no number, no prefix for figures.
\global\let\chaplevelprefix = \empty
\resetallfloatnos
%
% This used to be simply \message{#1}, but TeX fully expands the
% argument to \message.  Therefore, if #1 contained @-commands, TeX
% expanded them.  For example, in `@unnumbered The @cite{Book}', TeX
% expanded @cite (which turns out to cause errors because \cite is meant
% to be executed, not expanded).
%
% Anyway, we don't want the fully-expanded definition of @cite to appear
% as a result of the \message, we just want `@cite' itself.  We use
% \the&lt;toks register&gt; to achieve this: TeX expands \the&lt;toks&gt; only once,
% simply yielding the contents of &lt;toks register&gt;.  (We also do this for
% the toc entries.)
\toks0 = {#1}%
\message{(\the\toks0)}%
%
\chapmacro{#1}{Ynothing}{\the\unnumberedno}%
%
\global\let\section = \unnumberedsec
\global\let\subsection = \unnumberedsubsec
\global\let\subsubsection = \unnumberedsubsubsec</pre>

<p>}</p>

<p>% @centerchap is like @unnumbered, but the heading is centered.
outerparseargdefcenterchap{%</p>

<pre>% Well, we could do the following in a group, but that would break
% an assumption that \chapmacro is called at the outermost level.
% Thus we are safer this way:         --kasal, 24feb04
\let\centerparametersmaybe = \centerparameters
\unnmhead0{#1}%
\let\centerparametersmaybe = \relax</pre>

<p>}</p>

<p>% @top is like @unnumbered. lettopunnumbered</p>

<p>% Sections. outerparseargdefnumberedsec{numhead1{#1}} % normally calls
seczzz defseczzz#1{%</p>

<pre>\global\subsecno=0 \global\subsubsecno=0  \global\advance\secno by 1
\sectionheading{#1}{sec}{Ynumbered}{\the\chapno.\the\secno}%</pre>

<p>}</p>

<p>outerparseargdefappendixsection{apphead1{#1}} % normally calls
appendixsectionzzz defappendixsectionzzz#1{%</p>

<pre>\global\subsecno=0 \global\subsubsecno=0  \global\advance\secno by 1
\sectionheading{#1}{sec}{Yappendix}{\appendixletter.\the\secno}%</pre>

<p>} letappendixsecappendixsection</p>

<p>outerparseargdefunnumberedsec{unnmhead1{#1}} % normally calls
unnumberedseczzz defunnumberedseczzz#1{%</p>

<pre>\global\subsecno=0 \global\subsubsecno=0  \global\advance\secno by 1
\sectionheading{#1}{sec}{Ynothing}{\the\unnumberedno.\the\secno}%</pre>

<p>}</p>

<p>% Subsections. outerparseargdefnumberedsubsec{numhead2{#1}} % normally
calls numberedsubseczzz defnumberedsubseczzz#1{%</p>

<pre>\global\subsubsecno=0  \global\advance\subsecno by 1
\sectionheading{#1}{subsec}{Ynumbered}{\the\chapno.\the\secno.\the\subsecno}%</pre>

<p>}</p>

<p>outerparseargdefappendixsubsec{apphead2{#1}} % normally calls
appendixsubseczzz defappendixsubseczzz#1{%</p>

<pre>\global\subsubsecno=0  \global\advance\subsecno by 1
\sectionheading{#1}{subsec}{Yappendix}%
               {\appendixletter.\the\secno.\the\subsecno}%</pre>

<p>}</p>

<p>outerparseargdefunnumberedsubsec{unnmhead2{#1}} %normally calls
unnumberedsubseczzz defunnumberedsubseczzz#1{%</p>

<pre>\global\subsubsecno=0  \global\advance\subsecno by 1
\sectionheading{#1}{subsec}{Ynothing}%
               {\the\unnumberedno.\the\secno.\the\subsecno}%</pre>

<p>}</p>

<p>% Subsubsections. outerparseargdefnumberedsubsubsec{numhead3{#1}} %
normally numberedsubsubseczzz defnumberedsubsubseczzz#1{%</p>

<pre>\global\advance\subsubsecno by 1
\sectionheading{#1}{subsubsec}{Ynumbered}%
               {\the\chapno.\the\secno.\the\subsecno.\the\subsubsecno}%</pre>

<p>}</p>

<p>outerparseargdefappendixsubsubsec{apphead3{#1}} % normally
appendixsubsubseczzz defappendixsubsubseczzz#1{%</p>

<pre>\global\advance\subsubsecno by 1
\sectionheading{#1}{subsubsec}{Yappendix}%
               {\appendixletter.\the\secno.\the\subsecno.\the\subsubsecno}%</pre>

<p>}</p>

<p>outerparseargdefunnumberedsubsubsec{unnmhead3{#1}} %normally
unnumberedsubsubseczzz defunnumberedsubsubseczzz#1{%</p>

<pre>\global\advance\subsubsecno by 1
\sectionheading{#1}{subsubsec}{Ynothing}%
               {\the\unnumberedno.\the\secno.\the\subsecno.\the\subsubsecno}%</pre>

<p>}</p>

<p>% These macros control what the section commands do, according % to what
kind of chapter we are in (ordinary, appendix, or unnumbered). % Define
them by default for a numbered chapter. letsection = numberedsec
letsubsection = numberedsubsec letsubsubsection = numberedsubsubsec</p>

<p>% Define @majorheading, @heading and @subheading</p>

<p>% NOTE on use of vbox for chapter headings, section headings, and such: %  
1) We use vbox rather than the earlier line to permit %          overlong
headings to fold. %       2) hyphenpenalty is set to 10000 because
hyphenation in a %          heading is obnoxious; this forbids it. %      
3) Likewise, headings look best if no parindent is used, and %          if
justification is not attempted.  Hence raggedright.</p>

<p>defmajorheading{%</p>

<pre>{\advance\chapheadingskip by 10pt \chapbreak }%
\parsearg\chapheadingzzz</pre>

<p>}</p>

<p>defchapheading{chapbreak parseargchapheadingzzz} defchapheadingzzz#1{%</p>

<pre>{\chapfonts \vbox{\hyphenpenalty=10000\tolerance=5000
                  \parindent=0pt\raggedright
                  \rm #1\hfill}}%
\bigskip \par\penalty 200\relax
\suppressfirstparagraphindent</pre>

<p>}</p>

<p>% @heading, @subheading, @subsubheading.
parseargdefheading{sectionheading{#1}{sec}{Yomitfromtoc}{}</p>

<pre>\suppressfirstparagraphindent}</pre>

<p>parseargdefsubheading{sectionheading{#1}{subsec}{Yomitfromtoc}{}</p>

<pre>\suppressfirstparagraphindent}</pre>

<p>parseargdefsubsubheading{sectionheading{#1}{subsubsec}{Yomitfromtoc}{}</p>

<pre>\suppressfirstparagraphindent}</pre>

<p>% These macros generate a chapter, section, etc. heading only % (including
whitespace, linebreaking, etc. around it), % given all the information in
convenient, parsed form.</p>

<p>%%% Args are the skip and penalty (usually negative)
defdobreak#1#2{parifdimlastskip&lt;#1removelastskippenalty#2vskip#1fi}</p>

<p>%%% Define plain chapter starts, and page on/off switching for it %
Parameter controlling skip before chapter headings (if needed)</p>

<p>newskipchapheadingskip</p>

<p>defchapbreak{dobreak chapheadingskip {-4000}}
defchappager{parvfillsupereject} defchapoddpage{chappager ifoddpageno else
hbox to 0pt{} chappagerfi}</p>

<p>defsetchapternewpage #1 {csname CHAPPAG#1endcsname}</p>

<p>defCHAPPAGoff{% globalletcontentsalignmacro = chappager
globalletpchapsepmacro=chapbreak globalletpagealignmacro=chappager}</p>

<p>defCHAPPAGon{% globalletcontentsalignmacro = chappager
globalletpchapsepmacro=chappager globalletpagealignmacro=chappager
globaldefHEADINGSon{HEADINGSsingle}}</p>

<p>defCHAPPAGodd{% globalletcontentsalignmacro = chapoddpage
globalletpchapsepmacro=chapoddpage globalletpagealignmacro=chapoddpage
globaldefHEADINGSon{HEADINGSdouble}}</p>

<p>CHAPPAGon</p>

<p>% Chapter opening. % % #1 is the text, #2 is the section type (Ynumbered,
Ynothing, % Yappendix, Yomitfromtoc), #3 the chapter number. % % To test
against our argument. defYnothingkeyword{Ynothing}
defYomitfromtockeyword{Yomitfromtoc} defYappendixkeyword{Yappendix} %
defchapmacro#1#2#3{%</p>

<pre>\pchapsepmacro
{%
  \chapfonts \rm
  %
  % Have to define \thissection before calling \donoderef, because the
  % xref code eventually uses it.  On the other hand, it has to be called
  % after \pchapsepmacro, or the headline will change too soon.
  \gdef\thissection{#1}%
  \gdef\thischaptername{#1}%
  %
  % Only insert the separating space if we have a chapter/appendix
  % number, and don't print the unnumbered ``number''.
  \def\temptype{#2}%
  \ifx\temptype\Ynothingkeyword
    \setbox0 = \hbox{}%
    \def\toctype{unnchap}%
    \gdef\thischapter{#1}%
  \else\ifx\temptype\Yomitfromtockeyword
    \setbox0 = \hbox{}% contents like unnumbered, but no toc entry
    \def\toctype{omit}%
    \gdef\thischapter{}%
  \else\ifx\temptype\Yappendixkeyword
    \setbox0 = \hbox{\putwordAppendix{} #3\enspace}%
    \def\toctype{app}%
    % We don't substitute the actual chapter name into \thischapter
    % because we don't want its macros evaluated now.  And we don't
    % use \thissection because that changes with each section.
    %
    \xdef\thischapter{\putwordAppendix{} \appendixletter:
                      \noexpand\thischaptername}%
  \else
    \setbox0 = \hbox{#3\enspace}%
    \def\toctype{numchap}%
    \xdef\thischapter{\putwordChapter{} \the\chapno:
                      \noexpand\thischaptername}%
  \fi\fi\fi
  %
  % Write the toc entry for this chapter.  Must come before the
  % \donoderef, because we include the current node name in the toc
  % entry, and \donoderef resets it to empty.
  \writetocentry{\toctype}{#1}{#3}%
  %
  % For pdftex, we have to write out the node definition (aka, make
  % the pdfdest) after any page break, but before the actual text has
  % been typeset.  If the destination for the pdf outline is after the
  % text, then jumping from the outline may wind up with the text not
  % being visible, for instance under high magnification.
  \donoderef{#2}%
  %
  % Typeset the actual heading.
  \vbox{\hyphenpenalty=10000 \tolerance=5000 \parindent=0pt \raggedright
        \hangindent=\wd0 \centerparametersmaybe
        \unhbox0 #1\par}%
}%
\nobreak\bigskip % no page break after a chapter title
\nobreak</pre>

<p>}</p>

<p>% @centerchap – centered and unnumbered. letcenterparametersmaybe = relax
defcenterparameters{%</p>

<pre>\advance\rightskip by 3\rightskip
\leftskip = \rightskip
\parfillskip = 0pt</pre>

<p>}</p>

<p>% I don’t think this chapter style is supported any more, so I’m not %
updating it with the new noderef stuff.  We’ll see.  –karl, 11aug03. %
defsetchapterstyle #1 {csname CHAPF#1endcsname} % defunnchfopen #1{%
chapoddpage {chapfonts vbox{hyphenpenalty=10000tolerance=5000</p>

<pre>\parindent=0pt\raggedright
\rm #1\hfill}}\bigskip \par\nobreak</pre>

<p>} defchfopen #1#2{chapoddpage {chapfonts vbox to 3in{vfil hbox tohsize{hfil
#2} hbox tohsize{hfil #1} vfil}}% parpenalty 5000 % } defcenterchfopen #1{%
chapoddpage {chapfonts vbox{hyphenpenalty=10000tolerance=5000</p>

<pre>\parindent=0pt
\hfill {\rm #1}\hfill}}\bigskip \par\nobreak</pre>

<p>} defCHAPFopen{%</p>

<pre>\global\let\chapmacro=\chfopen
\global\let\centerchapmacro=\centerchfopen}</pre>

<p>% Section titles.  These macros combine the section number parts and % call
the generic sectionheading to do the printing. % newskipsecheadingskip
defsecheadingbreak{dobreak secheadingskip{-1000}}</p>

<p>% Subsection titles. newskipsubsecheadingskip defsubsecheadingbreak{dobreak
subsecheadingskip{-500}}</p>

<p>% Subsubsection titles. defsubsubsecheadingskip{subsecheadingskip}
defsubsubsecheadingbreak{subsecheadingbreak}</p>

<p>% Print any size, any type, section title. % % #1 is the text, #2 is the
section level (sec/subsec/subsubsec), #3 is % the section type for xrefs
(Ynumbered, Ynothing, Yappendix), #4 is the % section number. %
defsectionheading#1#2#3#4{%</p>

<pre>{%
  % Switch to the right set of fonts.
  \csname #2fonts\endcsname \rm
  %
  % Insert space above the heading.
  \csname #2headingbreak\endcsname
  %
  % Only insert the space after the number if we have a section number.
  \def\sectionlevel{#2}%
  \def\temptype{#3}%
  %
  \ifx\temptype\Ynothingkeyword
    \setbox0 = \hbox{}%
    \def\toctype{unn}%
    \gdef\thissection{#1}%
  \else\ifx\temptype\Yomitfromtockeyword
    % for @headings -- no section number, don't include in toc,
    % and don't redefine \thissection.
    \setbox0 = \hbox{}%
    \def\toctype{omit}%
    \let\sectionlevel=\empty
  \else\ifx\temptype\Yappendixkeyword
    \setbox0 = \hbox{#4\enspace}%
    \def\toctype{app}%
    \gdef\thissection{#1}%
  \else
    \setbox0 = \hbox{#4\enspace}%
    \def\toctype{num}%
    \gdef\thissection{#1}%
  \fi\fi\fi
  %
  % Write the toc entry (before \donoderef).  See comments in \chfplain.
  \writetocentry{\toctype\sectionlevel}{#1}{#4}%
  %
  % Write the node reference (= pdf destination for pdftex).
  % Again, see comments in \chfplain.
  \donoderef{#3}%
  %
  % Output the actual section heading.
  \vbox{\hyphenpenalty=10000 \tolerance=5000 \parindent=0pt \raggedright
        \hangindent=\wd0  % zero if no section number
        \unhbox0 #1}%
}%
% Add extra space after the heading -- half of whatever came above it.
% Don't allow stretch, though.
\kern .5 \csname #2headingskip\endcsname
%
% Do not let the kern be a potential breakpoint, as it would be if it
% was followed by glue.
\nobreak
%
% We'll almost certainly start a paragraph next, so don't let that
% glue accumulate.  (Not a breakpoint because it's preceded by a
% discardable item.)
\vskip-\parskip
% 
% This is purely so the last item on the list is a known \penalty &gt;
% 10000.  This is so \startdefun can avoid allowing breakpoints after
% section headings.  Otherwise, it would insert a valid breakpoint between:
% 
%   @section sec-whatever
%   @deffn def-whatever
\penalty 10001</pre>

<p>}</p>

<p>message{toc,} % Table of contents. newwritetocfile</p>

<p>% Write an entry to the toc file, opening it if necessary. % Called from
@chapter, etc. % % Example usage: writetocentry{sec}{Section
Name}{thechapno.thesecno} % We append the current node name (if any) and
page number as additional % arguments for the {chap,sec,…}entry macros
which will eventually % read this.  The node name is used in the pdf
outlines as the % destination to jump to. % % We open the .toc file for
writing here instead of at @setfilename (or % any other fixed time) so that
@contents can be anywhere in the document. % But if #1 is `omit’, then we
don’t do anything.  This is used for the % table of contents chapter
openings themselves. % newififtocfileopened defomitkeyword{omit}% %
defwritetocentry#1#2#3{%</p>

<pre>\edef\writetoctype{#1}%
\ifx\writetoctype\omitkeyword \else
  \iftocfileopened\else
    \immediate\openout\tocfile = \jobname.toc
    \global\tocfileopenedtrue
  \fi
  %
  \iflinks
    {\atdummies
     \edef\temp{%
       \write\tocfile{@#1entry{#2}{#3}{\lastnode}{\noexpand\folio}}}%
     \temp
    }
  \fi
\fi
%
% Tell \shipout to create a pdf destination on each page, if we're
% writing pdf.  These are used in the table of contents.  We can't
% just write one on every page because the title pages are numbered
% 1 and 2 (the page numbers aren't printed), and so are the first
% two pages of the document.  Thus, we'd have two destinations named
% `1', and two named `2'.
\ifpdf \global\pdfmakepagedesttrue \fi</pre>

<p>}</p>

<p>% These characters do not print properly in the Computer Modern roman %
fonts, so we must take special care.  This is more or less redundant % with
the Texinfo input format setup at the end of this file. % 
defactivecatcodes{%</p>

<pre>\catcode`\&quot;=\active
\catcode`\$=\active
\catcode`\&lt;=\active
\catcode`\&gt;=\active
\catcode`\\=\active
\catcode`\^=\active
\catcode`\_=\active
\catcode`\|=\active
\catcode`\~=\active</pre>

<p>}</p>

<p>% Read the toc file, which is essentially Texinfo input. defreadtocfile{%</p>

<pre>\setupdatafile
\activecatcodes
\input \jobname.toc</pre>

<p>}</p>

<p>newskipcontentsrightmargin contentsrightmargin=1in newcountsavepageno
newcountlastnegativepageno lastnegativepageno = -1</p>

<p>% Prepare to read what we’ve written to tocfile. % defstartcontents#1{%</p>

<pre>% If @setchapternewpage on, and @headings double, the contents should
% start on an odd page, unlike chapters.  Thus, we maintain
% \contentsalignmacro in parallel with \pagealignmacro.
% From: Torbjorn Granlund &lt;tege@matematik.su.se&gt;
\contentsalignmacro
\immediate\closeout\tocfile
%
% Don't need to put `Contents' or `Short Contents' in the headline.
% It is abundantly clear what they are.
\def\thischapter{}%
\chapmacro{#1}{Yomitfromtoc}{}%
%
\savepageno = \pageno
\begingroup                  % Set up to handle contents files properly.
  \raggedbottom              % Worry more about breakpoints than the bottom.
  \advance\hsize by -\contentsrightmargin % Don't use the full line length.
  %
  % Roman numerals for page numbers.
  \ifnum \pageno&gt;0 \global\pageno = \lastnegativepageno \fi</pre>

<p>}</p>

<p>% Normal (long) toc. defcontents{%</p>

<pre>\startcontents{\putwordTOC}%
  \openin 1 \jobname.toc
  \ifeof 1 \else
    \readtocfile
  \fi
  \vfill \eject
  \contentsalignmacro % in case @setchapternewpage odd is in effect
  \ifeof 1 \else
    \pdfmakeoutlines
  \fi
  \closein 1
\endgroup
\lastnegativepageno = \pageno
\global\pageno = \savepageno</pre>

<p>}</p>

<p>% And just the chapters. defsummarycontents{%</p>

<pre>\startcontents{\putwordShortTOC}%
  %
  \let\numchapentry = \shortchapentry
  \let\appentry = \shortchapentry
  \let\unnchapentry = \shortunnchapentry
  % We want a true roman here for the page numbers.
  \secfonts
  \let\rm=\shortcontrm \let\bf=\shortcontbf
  \let\sl=\shortcontsl \let\tt=\shortconttt
  \rm
  \hyphenpenalty = 10000
  \advance\baselineskip by 1pt % Open it up a little.
  \def\numsecentry##1##2##3##4{}
  \let\appsecentry = \numsecentry
  \let\unnsecentry = \numsecentry
  \let\numsubsecentry = \numsecentry
  \let\appsubsecentry = \numsecentry
  \let\unnsubsecentry = \numsecentry
  \let\numsubsubsecentry = \numsecentry
  \let\appsubsubsecentry = \numsecentry
  \let\unnsubsubsecentry = \numsecentry
  \openin 1 \jobname.toc
  \ifeof 1 \else
    \readtocfile
  \fi
  \closein 1
  \vfill \eject
  \contentsalignmacro % in case @setchapternewpage odd is in effect
\endgroup
\lastnegativepageno = \pageno
\global\pageno = \savepageno</pre>

<p>} letshortcontents = summarycontents</p>

<p>% Typeset the label for a chapter or appendix for the short contents. % The
arg is, e.g., `A’ for an appendix, or `3’ for a chapter. %
defshortchaplabel#1{%</p>

<pre>% This space should be enough, since a single number is .5em, and the
% widest letter (M) is 1em, at least in the Computer Modern fonts.
% But use \hss just in case.
% (This space doesn't include the extra space that gets added after
% the label; that gets put in by \shortchapentry above.)
%
% We'd like to right-justify chapter numbers, but that looks strange
% with appendix letters.  And right-justifying numbers and
% left-justifying letters looks strange when there is less than 10
% chapters.  Have to read the whole toc once to know how many chapters
% there are before deciding ...
\hbox to 1em{#1\hss}%</pre>

<p>}</p>

<p>% These macros generate individual entries in the table of contents. % The
first argument is the chapter or section name. % The last argument is the
page number. % The arguments in between are the chapter number, section
number, …</p>

<p>% Chapters, in the main contents.
defnumchapentry#1#2#3#4{dochapentry{#2labelspace#1}{#4}} % % Chapters, in
the short toc. % See comments in dochapentry re vbox and related settings.
defshortchapentry#1#2#3#4{%</p>

<pre>\tocentry{\shortchaplabel{#2}\labelspace #1}{\doshortpageno\bgroup#4\egroup}%</pre>

<p>}</p>

<p>% Appendices, in the main contents. % Need the word Appendix, and a
fixed-size box. % defappendixbox#1{%</p>

<pre>% We use M since it's probably the widest letter.
\setbox0 = \hbox{\putwordAppendix{} M}%
\hbox to \wd0{\putwordAppendix{} #1\hss}}</pre>

<p>% defappentry#1#2#3#4{dochapentry{appendixbox{#2}labelspace#1}{#4}}</p>

<p>% Unnumbered chapters. defunnchapentry#1#2#3#4{dochapentry{#1}{#4}}
defshortunnchapentry#1#2#3#4{tocentry{#1}{doshortpagenobgroup#4egroup}}</p>

<p>% Sections. defnumsecentry#1#2#3#4{dosecentry{#2labelspace#1}{#4}}
letappsecentry=numsecentry defunnsecentry#1#2#3#4{dosecentry{#1}{#4}}</p>

<p>% Subsections. defnumsubsecentry#1#2#3#4{dosubsecentry{#2labelspace#1}{#4}}
letappsubsecentry=numsubsecentry
defunnsubsecentry#1#2#3#4{dosubsecentry{#1}{#4}}</p>

<p>% And subsubsections.
defnumsubsubsecentry#1#2#3#4{dosubsubsecentry{#2labelspace#1}{#4}}
letappsubsubsecentry=numsubsubsecentry
defunnsubsubsecentry#1#2#3#4{dosubsubsecentry{#1}{#4}}</p>

<p>% This parameter controls the indentation of the various levels. % Same as
defaultparindent. newdimentocindent tocindent = 15pt</p>

<p>% Now for the actual typesetting. In all these, #1 is the text and #2 is
the % page number. % % If the toc has to be broken over pages, we want it
to be at chapters % if at all possible; hence the penalty.
defdochapentry#1#2{%</p>

<pre>\penalty-300 \vskip1\baselineskip plus.33\baselineskip minus.25\baselineskip
\begingroup
  \chapentryfonts
  \tocentry{#1}{\dopageno\bgroup#2\egroup}%
\endgroup
\nobreak\vskip .25\baselineskip plus.1\baselineskip</pre>

<p>}</p>

<p>defdosecentry#1#2{begingroup</p>

<pre>\secentryfonts \leftskip=\tocindent
\tocentry{#1}{\dopageno\bgroup#2\egroup}%</pre>

<p>endgroup}</p>

<p>defdosubsecentry#1#2{begingroup</p>

<pre>\subsecentryfonts \leftskip=2\tocindent
\tocentry{#1}{\dopageno\bgroup#2\egroup}%</pre>

<p>endgroup}</p>

<p>defdosubsubsecentry#1#2{begingroup</p>

<pre>\subsubsecentryfonts \leftskip=3\tocindent
\tocentry{#1}{\dopageno\bgroup#2\egroup}%</pre>

<p>endgroup}</p>

<p>% We use the same entry macro as for the index entries. lettocentry = entry</p>

<p>% Space between chapter (or whatever) number and the title.
deflabelspace{hskip1em relax}</p>

<p>defdopageno#1{{rm #1}} defdoshortpageno#1{{rm #1}}</p>

<p>defchapentryfonts{secfonts rm} defsecentryfonts{textfonts}
defsubsecentryfonts{textfonts} defsubsubsecentryfonts{textfonts}</p>

<p>message{environments,} % @foo … @end foo.</p>

<p>% @point{}, @result{}, @expansion{}, @print{}, @equiv{}. % % Since these
characters are used in examples, it should be an even number of % tt
widths. Each tt character is 1en, so two makes it 1em. % defpoint{$star$}
defresult{leavevmoderaise.15exhbox to 1em{hfil$Rightarrow$hfil}}
defexpansion{leavevmoderaise.1exhbox to 1em{hfil$mapsto$hfil}}
defprint{leavevmodelower.1exhbox to 1em{hfil$dashv$hfil}}
defequiv{leavevmodelower.1exhbox to 1em{hfil$ptexequiv$hfil}}</p>

<p>% The @error{} command. % Adapted from the TeXbook’s boxit. %
newboxerrorbox % {tentt globaldimen0 = 3em}% Width of the box. dimen2 =
.55pt % Thickness of rules % The text. (`r’ is open on the right, `e’
somewhat less so on the left.) setbox0 = hbox{kern-.75pt tensf
errorkern-1.5pt} % setboxerrorbox=hbox to dimen0{hfil</p>

<pre>\hsize = \dimen0 \advance\hsize by -5.8pt % Space to left+right.
\advance\hsize by -2\dimen2 % Rules.
\vbox{%
   \hrule height\dimen2
   \hbox{\vrule width\dimen2 \kern3pt          % Space to left of text.
      \vtop{\kern2.4pt \box0 \kern2.4pt}% Space above/below.
      \kern3pt\vrule width\dimen2}% Space to right.
   \hrule height\dimen2}
 \hfil}</pre>

<p>% deferror{leavevmodelower.7excopyerrorbox}</p>

<p>% @tex … @end tex    escapes into raw Tex temporarily. % One exception: @
is still an escape character, so that @end tex works. % But \ or @@ will
get a plain tex @ character.</p>

<p>envdeftex{%</p>

<pre>\catcode `\\=0 \catcode `\{=1 \catcode `\}=2
\catcode `\$=3 \catcode `\&amp;=4 \catcode `\#=6
\catcode `\^=7 \catcode `\_=8 \catcode `\~=\active \let~=\tie
\catcode `\%=14
\catcode `\+=\other
\catcode `\&quot;=\other
\catcode `\|=\other
\catcode `\&lt;=\other
\catcode `\&gt;=\other
\escapechar=`\\
%
\let\b=\ptexb
\let\bullet=\ptexbullet
\let\c=\ptexc
\let\,=\ptexcomma
\let\.=\ptexdot
\let\dots=\ptexdots
\let\equiv=\ptexequiv
\let\!=\ptexexclam
\let\i=\ptexi
\let\indent=\ptexindent
\let\noindent=\ptexnoindent
\let\{=\ptexlbrace
\let\+=\tabalign
\let\}=\ptexrbrace
\let\/=\ptexslash
\let\*=\ptexstar
\let\t=\ptext
\let\frenchspacing=\plainfrenchspacing
%
\def\endldots{\mathinner{\ldots\ldots\ldots\ldots}}%
\def\enddots{\relax\ifmmode\endldots\else$\mathsurround=0pt \endldots\,$\fi}%
\def\@{@}%</pre>

<p>} % There is no need to define Etex.</p>

<p>% Define @lisp … @end lisp. % @lisp environment forms a group so it can
rebind things, % including the definition of @end lisp (which normally is
erroneous).</p>

<p>% Amount to narrow the margins by for @lisp. newskiplispnarrowing
lispnarrowing=0.4in</p>

<p>% This is the definition that ^^M gets inside @lisp, @example, and other %
such environments.  null is better than a space, since it doesn’t % have
any width. deflisppar{nullendgraf}</p>

<p>% This space is always present above and below environments.
newskipenvskipamount envskipamount = 0pt</p>

<p>% Make spacing and below environment symmetrical.  We use parskip here % to
help in doing that, since in @example-like environments parskip % is reset
to zero; thus the afterenvbreak inserts no space – but the % start of the
next paragraph will insert parskip. % defaboveenvbreak{{%</p>

<pre>% =10000 instead of &lt;10000 because of a special case in \itemzzz and
% \sectionheading, q.v.
\ifnum \lastpenalty=10000 \else
  \advance\envskipamount by \parskip
  \endgraf
  \ifdim\lastskip&lt;\envskipamount
    \removelastskip
    % it's not a good place to break if the last penalty was \nobreak
    % or better ...
    \ifnum\lastpenalty&lt;10000 \penalty-50 \fi
    \vskip\envskipamount
  \fi
\fi</pre>

<p>}}</p>

<p>letafterenvbreak = aboveenvbreak</p>

<p>% nonarrowing is a flag.  If “set”, @lisp etc don’t narrow margins; it will
% also clear it, so that its embedded environments do the narrowing again.
letnonarrowing=relax</p>

<p>% @cartouche … @end cartouche: draw rectangle w/rounded corners around %
environment contents. fontcircle=lcircle10 newdimencircthick
newdimencartouternewdimencartinner
newskipnormbskipnewskipnormpskipnewskipnormlskip circthick=fontdimen8circle
% defctl{{circlechar’013hskip -6pt}}% 6pt from pl file: 1/2charwidth
defctr{{hskip 6ptcirclechar’010}} defcbl{{circlechar’012hskip -6pt}}
defcbr{{hskip 6ptcirclechar’011}} defcarttop{hbox to cartouter{hskiplskip</p>

<pre>\ctl\leaders\hrule height\circthick\hfil\ctr
\hskip\rskip}}</pre>

<p>defcartbot{hbox to cartouter{hskiplskip</p>

<pre>\cbl\leaders\hrule height\circthick\hfil\cbr
\hskip\rskip}}</pre>

<p>% newskiplskipnewskiprskip</p>

<p>envdefcartouche{%</p>

<pre>\ifhmode\par\fi  % can't be in the midst of a paragraph.
\startsavinginserts
\lskip=\leftskip \rskip=\rightskip
\leftskip=0pt\rightskip=0pt % we want these *outside*.
\cartinner=\hsize \advance\cartinner by-\lskip
\advance\cartinner by-\rskip
\cartouter=\hsize
\advance\cartouter by 18.4pt  % allow for 3pt kerns on either
                              % side, and for 6pt waste from
                              % each corner char, and rule thickness
\normbskip=\baselineskip \normpskip=\parskip \normlskip=\lineskip
% Flag to tell @lisp, etc., not to narrow margin.
\let\nonarrowing = t%
\vbox\bgroup
    \baselineskip=0pt\parskip=0pt\lineskip=0pt
    \carttop
    \hbox\bgroup
        \hskip\lskip
        \vrule\kern3pt
        \vbox\bgroup
            \kern3pt
            \hsize=\cartinner
            \baselineskip=\normbskip
            \lineskip=\normlskip
            \parskip=\normpskip
            \vskip -\parskip
            \comment % For explanation, see the end of \def\group.</pre>

<p>} defEcartouche{%</p>

<pre>            \ifhmode\par\fi
            \kern3pt
        \egroup
        \kern3pt\vrule
        \hskip\rskip
    \egroup
    \cartbot
\egroup
\checkinserts</pre>

<p>}</p>

<p>% This macro is called at the beginning of all the @example variants, %
inside a group. defnonfillstart{%</p>

<pre>\aboveenvbreak
\hfuzz = 12pt % Don't be fussy
\sepspaces % Make spaces be word-separators rather than space tokens.
\let\par = \lisppar % don't ignore blank lines
\obeylines % each line of input is a line of output
\parskip = 0pt
\parindent = 0pt
\emergencystretch = 0pt % don't try to avoid overfull boxes
\ifx\nonarrowing\relax
  \advance \leftskip by \lispnarrowing
  \exdentamount=\lispnarrowing
\else
  \let\nonarrowing = \relax
\fi
\let\exdent=\nofillexdent</pre>

<p>}</p>

<p>% If you want all examples etc. small: @set dispenvsize small. % If you
want even small examples the full size: @set dispenvsize nosmall. % This
affects the following displayed environments: %    @example, @display,
@format, @lisp % defsmallword{small} defnosmallword{nosmall}
letSETdispenvsizerelax defsetnormaldispenv{%</p>

<pre>\ifx\SETdispenvsize\smallword
  \smallexamplefonts \rm
\fi</pre>

<p>} defsetsmalldispenv{%</p>

<pre>\ifx\SETdispenvsize\nosmallword
\else
  \smallexamplefonts \rm
\fi</pre>

<p>}</p>

<p>% We often define two environments, @foo and @smallfoo. % Let’s do it by
one command: defmakedispenv #1#2{</p>

<pre>\expandafter\envdef\csname#1\endcsname {\setnormaldispenv #2}
\expandafter\envdef\csname small#1\endcsname {\setsmalldispenv #2}
\expandafter\let\csname E#1\endcsname \afterenvbreak
\expandafter\let\csname Esmall#1\endcsname \afterenvbreak</pre>

<p>}</p>

<p>% Define two synonyms: defmaketwodispenvs #1#2#3{</p>

<pre>\makedispenv{#1}{#3}
\makedispenv{#2}{#3}</pre>

<p>}</p>

<p>% @lisp: indented, narrowed, typewriter font; @example: same as @lisp. % %
@smallexample and @smalllisp: use smaller fonts. % Originally contributed
by xerox at Pavel. % maketwodispenvs {lisp}{example}{%</p>

<pre>\nonfillstart
\tt
\let\kbdfont = \kbdexamplefont % Allow @kbd to do something special.
\gobble       % eat return</pre>

<p>}</p>

<p>% @display/@smalldisplay: same as @lisp except keep current font. %
makedispenv {display}{%</p>

<pre>\nonfillstart
\gobble</pre>

<p>}</p>

<p>% @format/@smallformat: same as @display except don’t narrow margins. %
makedispenv{format}{%</p>

<pre>\let\nonarrowing = t%
\nonfillstart
\gobble</pre>

<p>}</p>

<p>% @flushleft: same as @format, but doesn’t obey SETdispenvsize.
envdefflushleft{%</p>

<pre>\let\nonarrowing = t%
\nonfillstart
\gobble</pre>

<p>} letEflushleft = afterenvbreak</p>

<p>% @flushright. % envdefflushright{%</p>

<pre>\let\nonarrowing = t%
\nonfillstart
\advance\leftskip by 0pt plus 1fill
\gobble</pre>

<p>} letEflushright = afterenvbreak</p>

<p>% @quotation does normal linebreaking (hence we can’t use nonfillstart) %
and narrows the margins.  We keep parskip nonzero in general, since % we’re
doing normal filling.  So, when using aboveenvbreak and % afterenvbreak,
temporarily make parskip 0. % envdefquotation{%</p>

<pre>{\parskip=0pt \aboveenvbreak}% because \aboveenvbreak inserts \parskip
\parindent=0pt
%
% @cartouche defines \nonarrowing to inhibit narrowing at next level down.
\ifx\nonarrowing\relax
  \advance\leftskip by \lispnarrowing
  \advance\rightskip by \lispnarrowing
  \exdentamount = \lispnarrowing
\else
  \let\nonarrowing = \relax
\fi
\parsearg\quotationlabel</pre>

<p>}</p>

<p>% We have retained a nonzero parskip for the environment, since we’re %
doing normal filling. % defEquotation{%</p>

<pre>\par
\ifx\quotationauthor\undefined\else
  % indent a bit.
  \leftline{\kern 2\leftskip \sl ---\quotationauthor}%
\fi
{\parskip=0pt \afterenvbreak}%</pre>

<p>}</p>

<p>% If we’re given an argument, typeset it in bold with a colon after.
defquotationlabel#1{%</p>

<pre>\def\temp{#1}%
\ifx\temp\empty \else
  {\bf #1: }%
\fi</pre>

<p>}</p>

<p>% LaTeX-like @verbatim…@end verbatim and @verb{&lt;char&gt;…&lt;char&gt;} %
If we want to allow any &lt;char&gt; as delimiter, % we need the curly
braces so that makeinfo sees the @verb command, eg: % `@verbx…x’ would look
like the ‘@verbx’ command.  –janneke@gnu.org % % [Knuth]: Donald Ervin
Knuth, 1996.  The TeXbook. % % [Knuth] p.344; only we need to do the other
characters Texinfo sets % active too.  Otherwise, they get lost as the
first character on a % verbatim line. defdospecials{%</p>

<pre>\do\ \do\\\do\{\do\}\do\$\do\&amp;%
\do\#\do\^\do\^^K\do\_\do\^^A\do\%\do\~%
\do\&lt;\do\&gt;\do\|\do\@\do+\do\&quot;%</pre>

<p>} % % [Knuth] p. 380 defuncatcodespecials{%</p>

<pre>\def\do##1{\catcode`##1=\other}\dospecials}</pre>

<p>% % [Knuth] pp. 380,381,391 % Disable Spanish ligatures ?` and !` of tt
font begingroup</p>

<pre>\catcode`\`=\active\gdef`{\relax\lq}</pre>

<p>endgroup % % Setup for the @verb command. % % Eight spaces for a tab
begingroup</p>

<pre>\catcode`\^^I=\active
\gdef\tabeightspaces{\catcode`\^^I=\active\def^^I{\ \ \ \ \ \ \ \ }}</pre>

<p>endgroup % defsetupverb{%</p>

<pre>\tt  % easiest (and conventionally used) font for verbatim
\def\par{\leavevmode\endgraf}%
\catcode`\`=\active
\tabeightspaces
% Respect line breaks,
% print special symbols as themselves, and
% make each space count
% must do in this order:
\obeylines \uncatcodespecials \sepspaces</pre>

<p>}</p>

<p>% Setup for the @verbatim environment % % Real tab expansion newdimentabw
setbox0=hbox{ttspace} tabw=8wd0 % tab amount %
defstarttabbox{setbox0=hboxbgroup} begingroup</p>

<pre>\catcode`\^^I=\active
\gdef\tabexpand{%
  \catcode`\^^I=\active
  \def^^I{\leavevmode\egroup
    \dimen0=\wd0 % the width so far, or since the previous tab
    \divide\dimen0 by\tabw
    \multiply\dimen0 by\tabw % compute previous multiple of \tabw
    \advance\dimen0 by\tabw  % advance to next multiple of \tabw
    \wd0=\dimen0 \box0 \starttabbox
  }%
}</pre>

<p>endgroup defsetupverbatim{%</p>

<pre>\let\nonarrowing = t%
\nonfillstart
% Easiest (and conventionally used) font for verbatim
\tt
\def\par{\leavevmode\egroup\box0\endgraf}%
\catcode`\`=\active
\tabexpand
% Respect line breaks,
% print special symbols as themselves, and
% make each space count
% must do in this order:
\obeylines \uncatcodespecials \sepspaces
\everypar{\starttabbox}%</pre>

<p>}</p>

<p>% Do the @verb magic: verbatim text is quoted by unique % delimiter
characters.  Before first delimiter expect a % right brace, after last
delimiter expect closing brace: % %   
defdoverb’{‘&lt;char&gt;#1&lt;char&gt;’}‘{#1} % % [Knuth] p. 382; only eat
outer {} begingroup</p>

<pre>\catcode`[=1\catcode`]=2\catcode`\{=\other\catcode`\}=\other
\gdef\doverb{#1[\def\next##1#1}[##1\endgroup]\next]</pre>

<p>endgroup % defverb{begingroupsetupverbdoverb} % % % Do the @verbatim magic:
define the macro doverbatim so that % the (first) argument ends when ‘@end
verbatim’ is reached, ie: % %     defdoverbatim#1@end verbatim{#1} % % For
Texinfo it’s a lot easier than for LaTeX, % because texinfo’s verbatim
doesn’t stop at ‘end{verbatim}’: % we need not redefine ‘', ’{‘ and ’}‘. %
% Inspired by LaTeX’s verbatim command set [latex.ltx] % begingroup</p>

<pre>\catcode`\ =\active
\obeylines %
% ignore everything up to the first ^^M, that's the newline at the end
% of the @verbatim input line itself.  Otherwise we get an extra blank
% line in the output.
\xdef\doverbatim#1^^M#2@end verbatim{#2\noexpand\end\gobble verbatim}%
% We really want {...\end verbatim} in the body of the macro, but
% without the active space; thus we have to use \xdef and \gobble.</pre>

<p>endgroup % envdefverbatim{%</p>

<pre>\setupverbatim\doverbatim</pre>

<p>} letEverbatim = afterenvbreak</p>

<p>% @verbatiminclude FILE - insert text of file in verbatim environment. %
defverbatiminclude{parseargusingfilenamecatcodesdoverbatiminclude} %
defdoverbatiminclude#1{%</p>

<pre>{%
  \makevalueexpandable
  \setupverbatim
  \input #1
  \afterenvbreak
}%</pre>

<p>}</p>

<p>% @copying … @end copying. % Save the text away for @insertcopying later. %
% We save the uninterpreted tokens, rather than creating a box. % Saving
the text in a box would be much easier, but then all the % typesetting
commands (@smallbook, font changes, etc.) have to be done % beforehand –
and a) we want @copying to be done first in the source % file; b) letting
users define the frontmatter in as flexible order as % possible is very
desirable. % defcopying{checkenv{}begingroupscanargctxtdocopying}
defdocopying#1@end copying{endgroupdefcopyingtext{#1}} % definsertcopying{%</p>

<pre>\begingroup
  \parindent = 0pt  % paragraph indentation looks wrong on title page
  \scanexp\copyingtext
\endgroup</pre>

<p>}</p>

<p>message{defuns,} % @defun etc.</p>

<p>newskipdefbodyindent defbodyindent=.4in newskipdefargsindent
defargsindent=50pt newskipdeflastargmargin deflastargmargin=18pt</p>

<p>% Start the processing of @deffn: defstartdefun{%</p>

<pre class="ruby">\<span class="ruby-identifier">ifnum</span>\<span class="ruby-identifier">lastpenalty</span><span class="ruby-operator">&lt;</span><span class="ruby-value">10000</span>
  \<span class="ruby-identifier">medbreak</span>
\<span class="ruby-keyword">else</span>
  <span class="ruby-string">%QIf </span><span class="ruby-identifier">there</span> <span class="ruby-identifier">are</span> <span class="ruby-identifier">two</span> <span class="ruby-ivar">@def</span> <span class="ruby-identifier">commands</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">a</span> <span class="ruby-identifier">row</span>, <span class="ruby-identifier">we</span><span class="ruby-string">'ll have a \nobreak,
  % which is there to keep the function description together with its
  % header.  But if there'</span><span class="ruby-identifier">s</span> <span class="ruby-identifier">nothing</span> <span class="ruby-identifier">but</span> <span class="ruby-identifier">headers</span>, <span class="ruby-identifier">we</span> <span class="ruby-identifier">need</span> <span class="ruby-identifier">to</span> <span class="ruby-identifier">allow</span> <span class="ruby-identifier">a</span>
  <span class="ruby-string">%Qbreak </span><span class="ruby-identifier">somewhere</span>.  <span class="ruby-constant">Check</span> <span class="ruby-identifier">specifically</span> <span class="ruby-keyword">for</span> <span class="ruby-identifier">penalty</span> <span class="ruby-value">10002</span>, <span class="ruby-identifier">inserted</span>
  <span class="ruby-string">%Qby </span>\<span class="ruby-identifier">defargscommonending</span>, <span class="ruby-identifier">instead</span> <span class="ruby-identifier">of</span> <span class="ruby-value">10000</span>, <span class="ruby-identifier">since</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">sectioning</span>
  <span class="ruby-string">%Qcommands </span><span class="ruby-identifier">also</span> <span class="ruby-identifier">insert</span> <span class="ruby-identifier">a</span> <span class="ruby-identifier">nobreak</span> <span class="ruby-identifier">penalty</span>, <span class="ruby-keyword">and</span> <span class="ruby-identifier">we</span> <span class="ruby-identifier">don</span><span class="ruby-string">'t want to allow
  % a break between a section heading and a defun.
  % 
  \ifnum\lastpenalty=10002 \penalty2000 \fi
  %
  % Similarly, after a section heading, do not allow a break.
  % But do insert the glue.
  \medskip  % preceded by discardable penalty, so not a breakpoint
\fi
%
\parindent=0in
\advance\leftskip by \defbodyindent
\exdentamount=\defbodyindent
</span></pre>

<p>}</p>

<p>defdodefunx#1{%</p>

<pre>% First, check whether we are in the right environment:
\checkenv#1%
%
% As above, allow line break if we have multiple x headers in a row.
% It's not a great place, though.
\ifnum\lastpenalty=10002 \penalty3000 \fi
%
% And now, it's time to reuse the body of the original defun:
\expandafter\gobbledefun#1%</pre>

<p>} defgobbledefun#1startdefun{}</p>

<p>% printdefunline deffnheader{text} % defprintdefunline#1#2{%</p>

<pre>\begingroup
  % call \deffnheader:
  #1#2 \endheader
  % common ending:
  \interlinepenalty = 10000
  \advance\rightskip by 0pt plus 1fil
  \endgraf
  \nobreak\vskip -\parskip
  \penalty 10002  % signal to \startdefun and \dodefunx
  % Some of the @defun-type tags do not enable magic parentheses,
  % rendering the following check redundant.  But we don't optimize.
  \checkparencounts
\endgroup</pre>

<p>}</p>

<p>defEdefun{endgrafmedbreak}</p>

<p>% makedefun{deffn} creates deffn, deffnx and Edeffn; % the only thing
remainnig is to define deffnheader. % defmakedefun#1{%</p>

<pre>\expandafter\let\csname E#1\endcsname = \Edefun
\edef\temp{\noexpand\domakedefun
  \makecsname{#1}\makecsname{#1x}\makecsname{#1header}}%
\temp</pre>

<p>}</p>

<p>% domakedefun deffn deffnx deffnheader % % Define deffn and deffnx, without
parameters. % deffnheader has to be defined explicitly. %
defdomakedefun#1#2#3{%</p>

<pre>\envdef#1{%
  \startdefun
  \parseargusing\activeparens{\printdefunline#3}%
}%
\def#2{\dodefunx#1}%
\def#3%</pre>

<p>}</p>

<p>%%% Untyped functions:</p>

<p>% @deffn category name args makedefun{deffn}{deffngeneral{}}</p>

<p>% @deffn category class name args makedefun{defop}#1 {defopon{#1\
putwordon}}</p>

<p>% defopon {category on}class name args defdefopon#1#2
{deffngeneral{putwordon\ code{#2}}{#1\ code{#2}} }</p>

<p>% deffngeneral {subind}category name args % defdeffngeneral#1#2 #3
#4endheader{%</p>

<pre>% Remember that \dosubind{fn}{foo}{} is equivalent to \doind{fn}{foo}.
\dosubind{fn}{\code{#3}}{#1}%
\defname{#2}{}{#3}\magicamp\defunargs{#4\unskip}%</pre>

<p>}</p>

<p>%%% Typed functions:</p>

<p>% @deftypefn category type name args
makedefun{deftypefn}{deftypefngeneral{}}</p>

<p>% @deftypeop category class type name args makedefun{deftypeop}#1
{deftypeopon{#1\ putwordon}}</p>

<p>% deftypeopon {category on}class type name args defdeftypeopon#1#2
{deftypefngeneral{putwordon\ code{#2}}{#1\ code{#2}} }</p>

<p>% deftypefngeneral {subind}category type name args %
defdeftypefngeneral#1#2 #3 #4 #5endheader{%</p>

<pre>\dosubind{fn}{\code{#4}}{#1}%
\defname{#2}{#3}{#4}\defunargs{#5\unskip}%</pre>

<p>}</p>

<p>%%% Typed variables:</p>

<p>% @deftypevr category type var args
makedefun{deftypevr}{deftypecvgeneral{}}</p>

<p>% @deftypecv category class type var args makedefun{deftypecv}#1
{deftypecvof{#1\ putwordof}}</p>

<p>% deftypecvof {category of}class type var args defdeftypecvof#1#2
{deftypecvgeneral{putwordof\ code{#2}}{#1\ code{#2}} }</p>

<p>% deftypecvgeneral {subind}category type var args % defdeftypecvgeneral#1#2
#3 #4 #5endheader{%</p>

<pre>\dosubind{vr}{\code{#4}}{#1}%
\defname{#2}{#3}{#4}\defunargs{#5\unskip}%</pre>

<p>}</p>

<p>%%% Untyped variables:</p>

<p>% @defvr category var args makedefun{defvr}#1 {deftypevrheader{#1} {} }</p>

<p>% @defcv category class var args makedefun{defcv}#1 {defcvof{#1\
putwordof}}</p>

<p>% defcvof {category of}class var args defdefcvof#1#2 {deftypecvof{#1}#2 {}
}</p>

<p>%%% Type: % @deftp category name args makedefun{deftp}#1 #2 #3endheader{%</p>

<pre>\doind{tp}{\code{#2}}%
\defname{#1}{}{#2}\defunargs{#3\unskip}%</pre>

<p>}</p>

<p>% Remaining @defun-like shortcuts:
makedefun{defun}{deffnheader{putwordDeffunc} }
makedefun{defmac}{deffnheader{putwordDefmac} }
makedefun{defspec}{deffnheader{putwordDefspec} }
makedefun{deftypefun}{deftypefnheader{putwordDeffunc} }
makedefun{defvar}{defvrheader{putwordDefvar} }
makedefun{defopt}{defvrheader{putwordDefopt} }
makedefun{deftypevar}{deftypevrheader{putwordDefvar} }
makedefun{defmethod}{defoponputwordMethodon}
makedefun{deftypemethod}{deftypeoponputwordMethodon}
makedefun{defivar}{defcvofputwordInstanceVariableof}
makedefun{deftypeivar}{deftypecvofputwordInstanceVariableof}</p>

<p>% defname, which formats the name of the @def (not the args). % #1 is the
category, such as “Function”. % #2 is the return type, if any. % #3 is the
function name. % % We are followed by (but not passed) the arguments, if
any. % defdefname#1#2#3{%</p>

<pre>% Get the values of \leftskip and \rightskip as they were outside the @def...
\advance\leftskip by -\defbodyindent
%
% How we'll format the type name.  Putting it in brackets helps
% distinguish it from the body text that may end up on the next line
% just below it.
\def\temp{#1}%
\setbox0=\hbox{\kern\deflastargmargin \ifx\temp\empty\else [\rm\temp]\fi}
%
% Figure out line sizes for the paragraph shape.
% The first line needs space for \box0; but if \rightskip is nonzero,
% we need only space for the part of \box0 which exceeds it:
\dimen0=\hsize  \advance\dimen0 by -\wd0  \advance\dimen0 by \rightskip
% The continuations:
\dimen2=\hsize  \advance\dimen2 by -\defargsindent
% (plain.tex says that \dimen1 should be used only as global.)
\parshape 2 0in \dimen0 \defargsindent \dimen2
%
% Put the type name to the right margin.
\noindent
\hbox to 0pt{%
  \hfil\box0 \kern-\hsize
  % \hsize has to be shortened this way:
  \kern\leftskip
  % Intentionally do not respect \rightskip, since we need the space.
}%
%
% Allow all lines to be underfull without complaint:
\tolerance=10000 \hbadness=10000
\exdentamount=\defbodyindent
{%
  % defun fonts. We use typewriter by default (used to be bold) because:
  % . we're printing identifiers, they should be in tt in principle.
  % . in languages with many accents, such as Czech or French, it's
  %   common to leave accents off identifiers.  The result looks ok in
  %   tt, but exceedingly strange in rm.
  % . we don't want -- and --- to be treated as ligatures.
  % . this still does not fix the ?` and !` ligatures, but so far no
  %   one has made identifiers using them :).
  \df \tt
  \def\temp{#2}% return value type
  \ifx\temp\empty\else \tclose{\temp} \fi
  #3% output function name
}%
{\rm\enskip}% hskip 0.5 em of \tenrm
%
\boldbrax
% arguments will be output next, if any.</pre>

<p>}</p>

<p>% Print arguments in slanted roman (not ttsl), inconsistently with using %
tt for the name.  This is because literal text is sometimes needed in % the
argument list (groff manual), and ttsl and tt are not very %
distinguishable.  Prevent hyphenation at `-‘ chars. % defdefunargs#1{%</p>

<pre>% use sl by default (not ttsl),
% tt for the names.
\df \sl \hyphenchar\font=0
%
% On the other hand, if an argument has two dashes (for instance), we
% want a way to get ttsl.  Let's try @var for that.
\let\var=\ttslanted
#1%
\sl\hyphenchar\font=45</pre>

<p>}</p>

<p>% We want ()&amp;[] to print specially on the defun line. %
defactiveparens{%</p>

<pre>\catcode`\(=\active \catcode`\)=\active
\catcode`\[=\active \catcode`\]=\active
\catcode`\&amp;=\active</pre>

<p>}</p>

<p>% Make control sequences which act like normal parenthesis chars. letlparen
= ( letrparen = )</p>

<p>% Be sure that we always have a definition for `(‘, etc.  For example, % if
the fn name has parens in it, boldbrax will not be in effect yet, % so TeX
would otherwise complain about undefined control sequence. {</p>

<pre>\activeparens
\global\let(=\lparen \global\let)=\rparen
\global\let[=\lbrack \global\let]=\rbrack
\global\let&amp; = \&amp;

\gdef\boldbrax{\let(=\opnr\let)=\clnr\let[=\lbrb\let]=\rbrb}
\gdef\magicamp{\let&amp;=\amprm}</pre>

<p>}</p>

<p>newcountparencount</p>

<p>% If we encounter &amp;foo, then turn on ()-hacking afterwards
newififampseen defamprm#1 {ampseentrue{bf&amp;#1 }}</p>

<p>defparenfont{%</p>

<pre>\ifampseen
  % At the first level, print parens in roman,
  % otherwise use the default font.
  \ifnum \parencount=1 \rm \fi
\else
  % The \sf parens (in \boldbrax) actually are a little bolder than
  % the contained text.  This is especially needed for [ and ] .
  \sf
\fi</pre>

<p>} definfirstlevel#1{%</p>

<pre>\ifampseen
  \ifnum\parencount=1
    #1%
  \fi
\fi</pre>

<p>} defbfafterword#1 {#1 bf}</p>

<p>defopnr{%</p>

<pre>\global\advance\parencount by 1
{\parenfont(}%
\infirstlevel \bfafterword</pre>

<p>} defclnr{%</p>

<pre>{\parenfont)}%
\infirstlevel \sl
\global\advance\parencount by -1</pre>

<p>}</p>

<p>newcountbrackcount deflbrb{%</p>

<pre>\global\advance\brackcount by 1
{\bf[}%</pre>

<p>} defrbrb{%</p>

<pre>{\bf]}%
\global\advance\brackcount by -1</pre>

<p>}</p>

<p>defcheckparencounts{%</p>

<pre>\ifnum\parencount=0 \else \badparencount \fi
\ifnum\brackcount=0 \else \badbrackcount \fi</pre>

<p>} defbadparencount{%</p>

<pre>\errmessage{Unbalanced parentheses in @def}%
\global\parencount=0</pre>

<p>} defbadbrackcount{%</p>

<pre>\errmessage{Unbalanced square braces in @def}%
\global\brackcount=0</pre>

<p>}</p>

<p>message{macros,} % @macro.</p>

<p>% To do this right we need a feature of e-TeX, scantokens, % which we
arrange to emulate with a temporary file in ordinary TeX.
ifxeTeXversionundefined</p>

<pre>\newwrite\macscribble
\def\scantokens#1{%
  \toks0={#1}%
  \immediate\openout\macscribble=\jobname.tmp
  \immediate\write\macscribble{\the\toks0}%
  \immediate\closeout\macscribble
  \input \jobname.tmp
}</pre>

<p>fi</p>

<p>defscanmacro#1{%</p>

<pre>\begingroup
  \newlinechar`\^^M
  \let\xeatspaces\eatspaces
  % Undo catcode changes of \startcontents and \doprintindex
  % When called from @insertcopying or (short)caption, we need active
  % backslash to get it printed correctly.  Previously, we had
  % \catcode`\\=\other instead.  We'll see whether a problem appears
  % with macro expansion.                             --kasal, 19aug04
  \catcode`\@=0 \catcode`\\=\active \escapechar=`\@
  % ... and \example
  \spaceisspace
  %
  % Append \endinput to make sure that TeX does not see the ending newline.
  %
  % I've verified that it is necessary both for e-TeX and for ordinary TeX
  %                                                   --kasal, 29nov03
  \scantokens{#1\endinput}%
\endgroup</pre>

<p>}</p>

<p>defscanexp#1{%</p>

<pre>\edef\temp{\noexpand\scanmacro{#1}}%
\temp</pre>

<p>}</p>

<p>newcountparamno   % Count of parameters newtoksmacname    % Macro name
newififrecursive  % Is it recursive?</p>

<p>% List of all defined macros in the form %   
definedummywordmacro1definedummywordmacro2… % Currently is also contains
all @aliases; the list can be split % if there is a need. defmacrolist{}</p>

<p>% Add the macro to macrolist defaddtomacrolist#1{expandafter
addtomacrolistxxx csname#1endcsname} defaddtomacrolistxxx#1{%</p>

<pre>\toks0 = \expandafter{\macrolist\definedummyword#1}%
\xdef\macrolist{\the\toks0}%</pre>

<p>}</p>

<p>% Utility routines. % This does let #1 = #2, with csnames; that is, %   let
csname#1endcsname = csname#2endcsname % (except of course we have to play
expansion games). %  defcslet#1#2{%</p>

<pre>\expandafter\let
\csname#1\expandafter\endcsname
\csname#2\endcsname</pre>

<p>}</p>

<p>% Trim leading and trailing spaces off a string. % Concepts from aro-bend
problem 15 (see CTAN). {catcode`@=11 gdefeatspaces
#1{expandaftertrim@expandafter{#1 }} gdeftrim@ #1{trim@@ @#1 @ #1 @ @@}
gdeftrim@@ #1@ #2@ #3@@{trim@@@empty #2 @} defunbrace#1{#1}
unbrace{gdeftrim@@@ #1 } #2@{#1} }</p>

<p>% Trim a single trailing ^^M off a string. {catcode`^^M=other catcode`Q=3%
gdefeatcr #1{eatcra #1Q^^MQ}% gdefeatcra#1^^MQ{eatcrb#1Q}%
gdefeatcrb#1Q#2Q{#1}% }</p>

<p>% Macro bodies are absorbed as an argument in a context where % all
characters are catcode 10, 11 or 12, except \ which is active % (as in
normal texinfo). It is necessary to change the definition of .</p>

<p>% It’s necessary to have hard CRs when the macro is executed. This is %
done by  making ^^M (endlinechar) catcode 12 when reading the macro % body,
and then making it the newlinechar in scanmacro.</p>

<p>defscanctxt{%</p>

<pre>\catcode`\&quot;=\other
\catcode`\+=\other
\catcode`\&lt;=\other
\catcode`\&gt;=\other
\catcode`\@=\other
\catcode`\^=\other
\catcode`\_=\other
\catcode`\|=\other
\catcode`\~=\other</pre>

<p>}</p>

<p>defscanargctxt{%</p>

<pre>\scanctxt
\catcode`\\=\other
\catcode`\^^M=\other</pre>

<p>}</p>

<p>defmacrobodyctxt{%</p>

<pre>\scanctxt
\catcode`\{=\other
\catcode`\}=\other
\catcode`\^^M=\other
\usembodybackslash</pre>

<p>}</p>

<p>defmacroargctxt{%</p>

<pre>\scanctxt
\catcode`\\=\other</pre>

<p>}</p>

<p>% mbodybackslash is the definition of \ in @macro bodies. % It maps foo\
=&gt; csname macarg.fooendcsname =&gt; #N % where N is the macro parameter
number. % We define csname macarg.endcsname to be realbackslash, so % \ in
macro replacement text gets you a backslash.</p>

<p>{catcode`@=0 @catcode`@=@active</p>

<pre>@gdef@usembodybackslash{@let\=@mbodybackslash}
@gdef@mbodybackslash#1\{@csname macarg.#1@endcsname}</pre>

<p>} expandafterdefcsname macarg.endcsname{realbackslash}</p>

<p>defmacro{recursivefalseparseargmacroxxx}
defrmacro{recursivetrueparseargmacroxxx}</p>

<p>defmacroxxx#1{%</p>

<pre>\getargs{#1}%           now \macname is the macname and \argl the arglist
\ifx\argl\empty       % no arguments
   \paramno=0%
\else
   \expandafter\parsemargdef \argl;%
\fi
\if1\csname ismacro.\the\macname\endcsname
   \message{Warning: redefining \the\macname}%
\else
   \expandafter\ifx\csname \the\macname\endcsname \relax
   \else \errmessage{Macro name \the\macname\space already defined}\fi
   \global\cslet{macsave.\the\macname}{\the\macname}%
   \global\expandafter\let\csname ismacro.\the\macname\endcsname=1%
   \addtomacrolist{\the\macname}%
\fi
\begingroup \macrobodyctxt
\ifrecursive \expandafter\parsermacbody
\else \expandafter\parsemacbody
\fi}</pre>

<p>parseargdefunmacro{%</p>

<pre>\if1\csname ismacro.#1\endcsname
  \global\cslet{#1}{macsave.#1}%
  \global\expandafter\let \csname ismacro.#1\endcsname=0%
  % Remove the macro name from \macrolist:
  \begingroup
    \expandafter\let\csname#1\endcsname \relax
    \let\definedummyword\unmacrodo
    \xdef\macrolist{\macrolist}%
  \endgroup
\else
  \errmessage{Macro #1 not defined}%
\fi</pre>

<p>}</p>

<p>% Called by do from dounmacro on each macro.  The idea is to omit any %
macro definitions that have been changed to relax. % defunmacrodo#1{%</p>

<pre>\ifx #1\relax
  % remove this
\else
  \noexpand\definedummyword \noexpand#1%
\fi</pre>

<p>}</p>

<p>% This makes use of the obscure feature that if the last token of a %
&lt;parameter list&gt; is #, then the preceding argument is delimited by %
an opening brace, and that opening brace is not consumed.
defgetargs#1{getargsxxx#1{}} defgetargsxxx#1#{getmacname #1
relaxgetmacargs} defgetmacname #1 #2relax{macname={#1}}
defgetmacargs#1{defargl{#1}}</p>

<p>% Parse the optional {params} list.  Set up paramno and paramlist % so
defmacro knows what to do.  Define macarg.blah for each blah % in the
params list, to be ##N where N is the position in that list. % That gets
used by mbodybackslash (above).</p>

<p>% We need to get `macro parameter char #‘ into several definitions. % The
technique used is stolen from LaTeX:  let hash be something % unexpandable,
insert that wherever you need a #, and then redefine % it to # just before
using the token list produced. % % The same technique is used to protect
eatspaces till just before % the macro is used.</p>

<p>defparsemargdef#1;{paramno=0defparamlist{}%</p>

<pre>\let\hash\relax\let\xeatspaces\relax\parsemargdefxxx#1,;,}</pre>

<p>defparsemargdefxxx#1,{%</p>

<pre>\if#1;\let\next=\relax
\else \let\next=\parsemargdefxxx
  \advance\paramno by 1%
  \expandafter\edef\csname macarg.\eatspaces{#1}\endcsname
      {\xeatspaces{\hash\the\paramno}}%
  \edef\paramlist{\paramlist\hash\the\paramno,}%
\fi\next}</pre>

<p>% These two commands read recursive and nonrecursive macro bodies. %
(They’re different since rec and nonrec macros end differently.)</p>

<p>longdefparsemacbody#1@end macro% {xdeftemp{eatcr{#1}}endgroupdefmacro}%
longdefparsermacbody#1@end rmacro% {xdeftemp{eatcr{#1}}endgroupdefmacro}%</p>

<p>% This defines the macro itself. There are six cases: recursive and %
nonrecursive macros of zero, one, and many arguments. % Much magic with
expandafter here. % xdef is used so that macro definitions will survive the
file % they’re defined in; @include reads the file inside a group.
defdefmacro{%</p>

<pre>\let\hash=##% convert placeholders to macro parameter chars
\ifrecursive
  \ifcase\paramno
  % 0
    \expandafter\xdef\csname\the\macname\endcsname{%
      \noexpand\scanmacro{\temp}}%
  \or % 1
    \expandafter\xdef\csname\the\macname\endcsname{%
       \bgroup\noexpand\macroargctxt
       \noexpand\braceorline
       \expandafter\noexpand\csname\the\macname xxx\endcsname}%
    \expandafter\xdef\csname\the\macname xxx\endcsname##1{%
       \egroup\noexpand\scanmacro{\temp}}%
  \else % many
    \expandafter\xdef\csname\the\macname\endcsname{%
       \bgroup\noexpand\macroargctxt
       \noexpand\csname\the\macname xx\endcsname}%
    \expandafter\xdef\csname\the\macname xx\endcsname##1{%
        \expandafter\noexpand\csname\the\macname xxx\endcsname ##1,}%
    \expandafter\expandafter
    \expandafter\xdef
    \expandafter\expandafter
      \csname\the\macname xxx\endcsname
        \paramlist{\egroup\noexpand\scanmacro{\temp}}%
  \fi
\else
  \ifcase\paramno
  % 0
    \expandafter\xdef\csname\the\macname\endcsname{%
      \noexpand\norecurse{\the\macname}%
      \noexpand\scanmacro{\temp}\egroup}%
  \or % 1
    \expandafter\xdef\csname\the\macname\endcsname{%
       \bgroup\noexpand\macroargctxt
       \noexpand\braceorline
       \expandafter\noexpand\csname\the\macname xxx\endcsname}%
    \expandafter\xdef\csname\the\macname xxx\endcsname##1{%
      \egroup
      \noexpand\norecurse{\the\macname}%
      \noexpand\scanmacro{\temp}\egroup}%
  \else % many
    \expandafter\xdef\csname\the\macname\endcsname{%
       \bgroup\noexpand\macroargctxt
       \expandafter\noexpand\csname\the\macname xx\endcsname}%
    \expandafter\xdef\csname\the\macname xx\endcsname##1{%
        \expandafter\noexpand\csname\the\macname xxx\endcsname ##1,}%
    \expandafter\expandafter
    \expandafter\xdef
    \expandafter\expandafter
    \csname\the\macname xxx\endcsname
    \paramlist{%
        \egroup
        \noexpand\norecurse{\the\macname}%
        \noexpand\scanmacro{\temp}\egroup}%
  \fi
\fi}</pre>

<p>defnorecurse#1{bgroupcslet{#1}{macsave.#1}}</p>

<p>% braceorline decides whether the next nonwhitespace character is a % {. 
If so it reads up to the closing }, if not, it reads the whole % line. 
Whatever was read is then fed to the next control sequence % as an argument
(by parsebrace or parsearg)
defbraceorline#1{letnext=#1futureletncharbraceorlinexxx}
defbraceorlinexxx{%</p>

<pre>\ifx\nchar\bgroup\else
  \expandafter\parsearg
\fi \next}</pre>

<p>% @alias. % We need some trickery to remove the optional spaces around the
equal % sign.  Just make them active and then expand them all to nothing.
defalias{parseargusingobeyspacesaliasxxx} defaliasxxx #1{aliasyyy#1relax}
defaliasyyy #1=#2relax{%</p>

<pre>{%
  \expandafter\let\obeyedspace=\empty
  \addtomacrolist{#1}%
  \xdef\next{\global\let\makecsname{#1}=\makecsname{#2}}%
}%
\next</pre>

<p>}</p>

<p>message{cross references,}</p>

<p>newwriteauxfile</p>

<p>newififhavexrefs    % True if xref values are known. newififwarnedxrefs  %
True if we warned once that they aren’t known.</p>

<p>% @inforef is relatively simple. definforef #1{inforefzzz #1,,,,**}
definforefzzz #1,#2,#3,#4**{putwordSee{} putwordInfo{} putwordfile{}
file{ignorespaces #3{}},</p>

<pre>node \samp{\ignorespaces#1{}}}</pre>

<p>% @node’s only job in TeX is to define lastnode, which is used in %
cross-references.  The @node line might or might not have commas, and %
might or might not have spaces before the first comma, like: % @node foo ,
bar , … % We don’t want such trailing spaces in the node name. %
parseargdefnode{checkenv{}donode #1 ,finishnodeparse} % % also remove a
trailing comma, in case of something like this: % @node Help-Cross,  ,  ,
Cross-refs defdonode#1 ,#2finishnodeparse{dodonode #1,finishnodeparse}
defdodonode#1,#2finishnodeparse{gdeflastnode{#1}}</p>

<p>letnwnode=node letlastnode=empty</p>

<p>% Write a cross-reference definition for the current node.  #1 is the %
type (Ynumbered, Yappendix, Ynothing). % defdonoderef#1{%</p>

<pre>\ifx\lastnode\empty\else
  \setref{\lastnode}{#1}%
  \global\let\lastnode=\empty
\fi</pre>

<p>}</p>

<p>% @anchor{NAME} – define xref target at arbitrary point. %
newcountsavesfregister % defsavesf{relax ifhmode savesfregister=spacefactor
fi} defrestoresf{relax ifhmode spacefactor=savesfregister fi}
defanchor#1{savesf setref{#1}{Ynothing}restoresf ignorespaces}</p>

<p>% setref{NAME}{SNT} defines a cross-reference point NAME (a node or an %
anchor), which consists of three parts: % 1) NAME-title - the current
sectioning name taken from thissection, %                 or the anchor
name. % 2) NAME-snt   - section number and type, passed as the SNT arg, or
%                 empty for anchors. % 3) NAME-pg    - the page number. % %
This is called from donoderef, anchor, and dofloat.  In the case of %
floats, there is an additional part, which is not written here: % 4)
NAME-lof   - the text as it should appear in a @listoffloats. %
defsetref#1#2{%</p>

<pre>\pdfmkdest{#1}%
\iflinks
  {%
    \atdummies  % preserve commands, but don't expand them
    \edef\writexrdef##1##2{%
      \write\auxfile{@xrdef{#1-% #1 of \setref, expanded by the \edef
        ##1}{##2}}% these are parameters of \writexrdef
    }%
    \toks0 = \expandafter{\thissection}%
    \immediate \writexrdef{title}{\the\toks0 }%
    \immediate \writexrdef{snt}{\csname #2\endcsname}% \Ynumbered etc.
    \writexrdef{pg}{\folio}% will be written later, during \shipout
  }%
\fi</pre>

<p>}</p>

<p>% @xref, @pxref, and @ref generate cross-references.  For xrefX, #1 is %
the node name, #2 the name of the Info cross-reference, #3 the printed %
node name, #4 the name of the Info file, #5 the name of the printed %
manual.  All but the node name can be omitted. % defpxref#1{putwordsee{}
xrefX[#1,,,,,,,]} defxref#1{putwordSee{} xrefX[#1,,,,,,,]} defref#1{<a
href=“#1,,,,,,,”>xrefX</a>} defxrefX[#1,#2,#3,#4,#5,#6]{begingroup</p>

<pre>\unsepspaces
\def\printedmanual{\ignorespaces #5}%
\def\printedrefname{\ignorespaces #3}%
\setbox1=\hbox{\printedmanual\unskip}%
\setbox0=\hbox{\printedrefname\unskip}%
\ifdim \wd0 = 0pt
  % No printed node name was explicitly given.
  \expandafter\ifx\csname SETxref-automatic-section-title\endcsname\relax
    % Use the node name inside the square brackets.
    \def\printedrefname{\ignorespaces #1}%
  \else
    % Use the actual chapter/section title appear inside
    % the square brackets.  Use the real section title if we have it.
    \ifdim \wd1 &gt; 0pt
      % It is in another manual, so we don't have it.
      \def\printedrefname{\ignorespaces #1}%
    \else
      \ifhavexrefs
        % We know the real title if we have the xref values.
        \def\printedrefname{\refx{#1-title}{}}%
      \else
        % Otherwise just copy the Info node name.
        \def\printedrefname{\ignorespaces #1}%
      \fi%
    \fi
  \fi
\fi
%
% Make link in pdf output.
\ifpdf
  \leavevmode
  \getfilename{#4}%
  {\turnoffactive
   % See comments at \activebackslashdouble.
   {\activebackslashdouble \xdef\pdfxrefdest{#1}%
    \backslashparens\pdfxrefdest}%
   %
   \ifnum\filenamelength&gt;0
     \startlink attr{/Border [0 0 0]}%
       goto file{\the\filename.pdf} name{\pdfxrefdest}%
   \else
     \startlink attr{/Border [0 0 0]}%
       goto name{\pdfmkpgn{\pdfxrefdest}}%
   \fi
  }%
  \linkcolor
\fi
%
% Float references are printed completely differently: &quot;Figure 1.2&quot;
% instead of &quot;[somenode], p.3&quot;.  We distinguish them by the
% LABEL-title being set to a magic string.
{%
  % Have to otherify everything special to allow the \csname to
  % include an _ in the xref name, etc.
  \indexnofonts
  \turnoffactive
  \expandafter\global\expandafter\let\expandafter\Xthisreftitle
    \csname XR#1-title\endcsname
}%
\iffloat\Xthisreftitle
  % If the user specified the print name (third arg) to the ref,
  % print it instead of our usual &quot;Figure 1.2&quot;.
  \ifdim\wd0 = 0pt
    \refx{#1-snt}%
  \else
    \printedrefname
  \fi
  %
  % if the user also gave the printed manual name (fifth arg), append
  % &quot;in MANUALNAME&quot;.
  \ifdim \wd1 &gt; 0pt
    \space \putwordin{} \cite{\printedmanual}%
  \fi
\else
  % node/anchor (non-float) references.
  %
  % If we use \unhbox0 and \unhbox1 to print the node names, TeX does not
  % insert empty discretionaries after hyphens, which means that it will
  % not find a line break at a hyphen in a node names.  Since some manuals
  % are best written with fairly long node names, containing hyphens, this
  % is a loss.  Therefore, we give the text of the node name again, so it
  % is as if TeX is seeing it for the first time.
  \ifdim \wd1 &gt; 0pt
    \putwordsection{} ``\printedrefname'' \putwordin{} \cite{\printedmanual}%
  \else
    % _ (for example) has to be the character _ for the purposes of the
    % control sequence corresponding to the node, but it has to expand
    % into the usual \leavevmode...\vrule stuff for purposes of
    % printing. So we \turnoffactive for the \refx-snt, back on for the
    % printing, back off for the \refx-pg.
    {\turnoffactive
     % Only output a following space if the -snt ref is nonempty; for
     % @unnumbered and @anchor, it won't be.
     \setbox2 = \hbox{\ignorespaces \refx{#1-snt}{}}%
     \ifdim \wd2 &gt; 0pt \refx{#1-snt}\space\fi
    }%
    % output the `[mynode]' via a macro so it can be overridden.
    \xrefprintnodename\printedrefname
    %
    % But we always want a comma and a space:
    ,\space
    %
    % output the `page 3'.
    \turnoffactive \putwordpage\tie\refx{#1-pg}{}%
  \fi
\fi
\endlink</pre>

<p>endgroup}</p>

<p>% This macro is called from xrefX for the `[nodename]‘ part of xref %
output.  It’s a separate macro only so it can be changed more easily, %
since square brackets don’t work well in some documents.  Particularly %
one that Bob is working on :). % defxrefprintnodename#1{[#1]}</p>

<p>% Things referred to by setref. % defYnothing{} defYomitfromtoc{}
defYnumbered{%</p>

<pre>\ifnum\secno=0
  \putwordChapter@tie \the\chapno
\else \ifnum\subsecno=0
  \putwordSection@tie \the\chapno.\the\secno
\else \ifnum\subsubsecno=0
  \putwordSection@tie \the\chapno.\the\secno.\the\subsecno
\else
  \putwordSection@tie \the\chapno.\the\secno.\the\subsecno.\the\subsubsecno
\fi\fi\fi</pre>

<p>} defYappendix{%</p>

<pre>\ifnum\secno=0
   \putwordAppendix@tie @char\the\appendixno{}%
\else \ifnum\subsecno=0
   \putwordSection@tie @char\the\appendixno.\the\secno
\else \ifnum\subsubsecno=0
  \putwordSection@tie @char\the\appendixno.\the\secno.\the\subsecno
\else
  \putwordSection@tie
    @char\the\appendixno.\the\secno.\the\subsecno.\the\subsubsecno
\fi\fi\fi</pre>

<p>}</p>

<p>% Define refx{NAME}{SUFFIX} to reference a cross-reference string named
NAME. % If its value is nonempty, SUFFIX is output afterward. %
defrefx#1#2{%</p>

<pre>{%
  \indexnofonts
  \otherbackslash
  \expandafter\global\expandafter\let\expandafter\thisrefX
    \csname XR#1\endcsname
}%
\ifx\thisrefX\relax
  % If not defined, say something at least.
  \angleleft un\-de\-fined\angleright
  \iflinks
    \ifhavexrefs
      \message{\linenumber Undefined cross reference `#1'.}%
    \else
      \ifwarnedxrefs\else
        \global\warnedxrefstrue
        \message{Cross reference values unknown; you must run TeX again.}%
      \fi
    \fi
  \fi
\else
  % It's defined, so just use it.
  \thisrefX
\fi
#2% Output the suffix in any case.</pre>

<p>}</p>

<p>% This is the macro invoked by entries in the aux file.  Usually it’s %
just a def (we prepend XR to the control sequence name to avoid %
collisions).  But if this is a float type, we have more work to do. %
defxrdef#1#2{%</p>

<pre>\expandafter\gdef\csname XR#1\endcsname{#2}% remember this xref value.
%
% Was that xref control sequence that we just defined for a float?
\expandafter\iffloat\csname XR#1\endcsname
  % it was a float, and we have the (safe) float type in \iffloattype.
  \expandafter\let\expandafter\floatlist
    \csname floatlist\iffloattype\endcsname
  %
  % Is this the first time we've seen this float type?
  \expandafter\ifx\floatlist\relax
    \toks0 = {\do}% yes, so just \do
  \else
    % had it before, so preserve previous elements in list.
    \toks0 = \expandafter{\floatlist\do}%
  \fi
  %
  % Remember this xref in the control sequence \floatlistFLOATTYPE,
  % for later use in \listoffloats.
  \expandafter\xdef\csname floatlist\iffloattype\endcsname{\the\toks0{#1}}%
\fi</pre>

<p>}</p>

<p>% Read the last existing aux file, if any.  No error if none exists. %
deftryauxfile{%</p>

<pre>\openin 1 \jobname.aux
\ifeof 1 \else
  \readdatafile{aux}%
  \global\havexrefstrue
\fi
\closein 1</pre>

<p>}</p>

<p>defsetupdatafile{%</p>

<pre>\catcode`\^^@=\other
\catcode`\^^A=\other
\catcode`\^^B=\other
\catcode`\^^C=\other
\catcode`\^^D=\other
\catcode`\^^E=\other
\catcode`\^^F=\other
\catcode`\^^G=\other
\catcode`\^^H=\other
\catcode`\^^K=\other
\catcode`\^^L=\other
\catcode`\^^N=\other
\catcode`\^^P=\other
\catcode`\^^Q=\other
\catcode`\^^R=\other
\catcode`\^^S=\other
\catcode`\^^T=\other
\catcode`\^^U=\other
\catcode`\^^V=\other
\catcode`\^^W=\other
\catcode`\^^X=\other
\catcode`\^^Z=\other
\catcode`\^^[=\other
\catcode`\^^\=\other
\catcode`\^^]=\other
\catcode`\^^^=\other
\catcode`\^^_=\other
% It was suggested to set the catcode of ^ to 7, which would allow ^^e4 etc.
% in xref tags, i.e., node names.  But since ^^e4 notation isn't
% supported in the main text, it doesn't seem desirable.  Furthermore,
% that is not enough: for node names that actually contain a ^
% character, we would end up writing a line like this: 'xrdef {'hat
% b-title}{'hat b} and \xrdef does a \csname...\endcsname on the first
% argument, and \hat is not an expandable control sequence.  It could
% all be worked out, but why?  Either we support ^^ or we don't.
%
% The other change necessary for this was to define \auxhat:
% \def\auxhat{\def^{'hat }}% extra space so ok if followed by letter
% and then to call \auxhat in \setq.
%
\catcode`\^=\other
%
% Special characters.  Should be turned off anyway, but...
\catcode`\~=\other
\catcode`\[=\other
\catcode`\]=\other
\catcode`\&quot;=\other
\catcode`\_=\other
\catcode`\|=\other
\catcode`\&lt;=\other
\catcode`\&gt;=\other
\catcode`\$=\other
\catcode`\#=\other
\catcode`\&amp;=\other
\catcode`\%=\other
\catcode`+=\other % avoid \+ for paranoia even though we've turned it off
%
% This is to support \ in node names and titles, since the \
% characters end up in a \csname.  It's easier than
% leaving it active and making its active definition an actual \
% character.  What I don't understand is why it works in the *value*
% of the xrdef.  Seems like it should be a catcode12 \, and that
% should not typeset properly.  But it works, so I'm moving on for
% now.  --karl, 15jan04.
\catcode`\\=\other
%
% Make the characters 128-255 be printing characters.
{%
  \count1=128
  \def\loop{%
    \catcode\count1=\other
    \advance\count1 by 1
    \ifnum \count1&lt;256 \loop \fi
  }%
}%
%
% @ is our escape character in .aux files, and we need braces.
\catcode`\{=1
\catcode`\}=2
\catcode`\@=0</pre>

<p>}</p>

<p>defreaddatafile#1{% begingroup</p>

<pre>\setupdatafile
\input\jobname.#1</pre>

<p>endgroup}</p>

<p>message{insertions,} % including footnotes.</p>

<p>newcount footnoteno</p>

<p>% The trailing space in the following definition for supereject is % vital
for proper filling; pages come out unaligned when you do a % pagealignmacro
call if that space before the closing brace is % removed. (Generally,
numeric constants should always be followed by a % space to prevent strange
expansion errors.) defsupereject{parpenalty -20000footnoteno =0 }</p>

<p>% @footnotestyle is meaningful for info output only.
letfootnotestyle=comment</p>

<p>{catcode `@=11 % % Auto-number footnotes.  Otherwise like plain.
gdeffootnote{%</p>

<pre>\let\indent=\ptexindent
\let\noindent=\ptexnoindent
\global\advance\footnoteno by \@ne
\edef\thisfootno{$^{\the\footnoteno}$}%
%
% In case the footnote comes at the end of a sentence, preserve the
% extra spacing after we do the footnote number.
\let\@sf\empty
\ifhmode\edef\@sf{\spacefactor\the\spacefactor}\ptexslash\fi
%
% Remove inadvertent blank space before typesetting the footnote number.
\unskip
\thisfootno\@sf
\dofootnote</pre>

<p>}%</p>

<p>% Don’t bother with the trickery in plain.tex to not require the % footnote
text as a parameter.  Our footnotes don’t need to be so general. % % Oh
yes, they do; otherwise, @ifset (and anything else that uses %
parseargline) fails inside footnotes because the tokens are fixed when %
the footnote is read.  –karl, 16nov96. % gdefdofootnote{%</p>

<pre>\insert\footins\bgroup
% We want to typeset this text as a normal paragraph, even if the
% footnote reference occurs in (for example) a display environment.
% So reset some parameters.
\hsize=\pagewidth
\interlinepenalty\interfootnotelinepenalty
\splittopskip\ht\strutbox % top baseline for broken footnotes
\splitmaxdepth\dp\strutbox
\floatingpenalty\@MM
\leftskip\z@skip
\rightskip\z@skip
\spaceskip\z@skip
\xspaceskip\z@skip
\parindent\defaultparindent
%
\smallfonts \rm
%
% Because we use hanging indentation in footnotes, a @noindent appears
% to exdent this text, so make it be a no-op.  makeinfo does not use
% hanging indentation so @noindent can still be needed within footnote
% text after an @example or the like (not that this is good style).
\let\noindent = \relax
%
% Hang the footnote text off the number.  Use \everypar in case the
% footnote extends for more than one paragraph.
\everypar = {\hang}%
\textindent{\thisfootno}%
%
% Don't crash into the line above the footnote text.  Since this
% expands into a box, it must come within the paragraph, lest it
% provide a place where TeX can split the footnote.
\footstrut
\futurelet\next\fo@t</pre>

<p>} }%end catcode `@=11</p>

<p>% In case a @footnote appears in a vbox, save the footnote text and create
% the real insert just after the vbox finished.  Otherwise, the insertion %
would be lost. % Similarily, if a @footnote appears inside an alignment,
save the footnote % text to a box and make the insert when a row of the
table is finished. % And the same can be done for other insert classes. 
–kasal, 16nov03.</p>

<p>% Replace the insert primitive by a cheating macro. % Deeper inside, just
make sure that the saved insertions are not spilled % out prematurely. %
defstartsavinginserts{%</p>

<pre>\ifx \insert\ptexinsert
  \let\insert\saveinsert
\else
  \let\checkinserts\relax
\fi</pre>

<p>}</p>

<p>% This insert replacement works for both insertfootins{foo} and %
insertfootinsbgroup fooegroup, but it doesn’t work for insert27{foo}. %
defsaveinsert#1{%</p>

<pre>\edef\next{\noexpand\savetobox \makeSAVEname#1}%
\afterassignment\next
% swallow the left brace
\let\temp =</pre>

<p>} defmakeSAVEname#1{makecsname{SAVEexpandaftergobblestring#1}}
defsavetobox#1{globalsetbox#1 = vboxbgroup unvbox#1}</p>

<p>defchecksaveins#1{ifvoid#1else placesaveins#1fi}</p>

<p>defplacesaveins#1{%</p>

<pre>\ptexinsert \csname\expandafter\gobblesave\string#1\endcsname
  {\box#1}%</pre>

<p>}</p>

<p>% eat @SAVE – beware, all of them have catcode other: {</p>

<pre>\def\dospecials{\do S\do A\do V\do E} \uncatcodespecials  %  ;-)
\gdef\gobblesave @SAVE{}</pre>

<p>}</p>

<p>% initialization: defnewsaveins #1{%</p>

<pre>\edef\next{\noexpand\newsaveinsX \makeSAVEname#1}%
\next</pre>

<p>} defnewsaveinsX #1{%</p>

<pre>\csname newbox\endcsname #1%
\expandafter\def\expandafter\checkinserts\expandafter{\checkinserts
  \checksaveins #1}%</pre>

<p>}</p>

<p>% initialize: letcheckinsertsempty newsaveinsfootins newsaveinsmargin</p>

<p>% @image.  We use the macros from epsf.tex to support this. % If epsf.tex
is not installed and @image is used, we complain. % % Check for and read
epsf.tex up front.  If we read it only at @image % time, we might be inside
a group, and then its definitions would get % undone and the next image
would fail. openin 1 = epsf.tex ifeof 1 else</p>

<pre>% Do not bother showing banner with epsf.tex v2.7k (available in
% doc/epsf.tex and on ctan).
\def\epsfannounce{\toks0 = }%
\input epsf.tex</pre>

<p>fi closein 1 % % We will only complain once about lack of epsf.tex.
newififwarnednoepsf newhelpnoepsfhelp{epsf.tex must be installed for images
to</p>

<pre>work.  It is also included in the Texinfo distribution, or you can get
it from ftp://tug.org/tex/epsf.tex.}</pre>

<p>% defimage#1{%</p>

<pre>\ifx\epsfbox\undefined
  \ifwarnednoepsf \else
    \errhelp = \noepsfhelp
    \errmessage{epsf.tex not found, images will be ignored}%
    \global\warnednoepsftrue
  \fi
\else
  \imagexxx #1,,,,,\finish
\fi</pre>

<p>} % % Arguments to @image: % #1 is (mandatory) image filename; we tack on
.eps extension. % #2 is (optional) width, #3 is (optional) height. % #4 is
(ignored optional) html alt text. % #5 is (ignored optional) extension. %
#6 is just the usual extra ignored arg for parsing this stuff.
newififimagevmode defimagexxx#1,#2,#3,#4,#5,#6finish{begingroup</p>

<pre>\catcode`\^^M = 5     % in case we're inside an example
\normalturnoffactive  % allow _ et al. in names
% If the image is by itself, center it.
\ifvmode
  \imagevmodetrue
  \nobreak\bigskip
  % Usually we'll have text after the image which will insert
  % \parskip glue, so insert it here too to equalize the space
  % above and below.
  \nobreak\vskip\parskip
  \nobreak
  \line\bgroup\hss
\fi
%
% Output the image.
\ifpdf
  \dopdfimage{#1}{#2}{#3}%
\else
  % \epsfbox itself resets \epsf?size at each figure.
  \setbox0 = \hbox{\ignorespaces #2}\ifdim\wd0 &gt; 0pt \epsfxsize=#2\relax \fi
  \setbox0 = \hbox{\ignorespaces #3}\ifdim\wd0 &gt; 0pt \epsfysize=#3\relax \fi
  \epsfbox{#1.eps}%
\fi
%
\ifimagevmode \hss \egroup \bigbreak \fi  % space after the image</pre>

<p>endgroup}</p>

<p>% @float FLOATTYPE,LABEL,LOC … @end float for displayed figures, tables, %
etc.  We don’t actually implement floating yet, we always include the %
float “here”.  But it seemed the best name for the future. %
envparseargdeffloat{eatcommaspaceeatcommaspacedofloat#1, , ,finish}</p>

<p>% There may be a space before second and/or third parameter; delete it.
defeatcommaspace#1, {#1,}</p>

<p>% #1 is the optional FLOATTYPE, the text label for this float, typically %
“Figure”, “Table”, “Example”, etc.  Can’t contain commas.  If omitted, %
this float will not be numbered and cannot be referred to. % % #2 is the
optional xref label.  Also must be present for the float to % be referable.
% % #3 is the optional positioning argument; for now, it is ignored.  It %
will somehow specify the positions allowed to float to (here, top, bottom).
% % We keep a separate counter for each FLOATTYPE, which we reset at each %
chapter-level command. letresetallfloatnos=empty %
defdofloat#1,#2,#3,#4finish{%</p>

<pre>\let\thiscaption=\empty
\let\thisshortcaption=\empty
%
% don't lose footnotes inside @float.
%
% BEWARE: when the floats start float, we have to issue warning whenever an
% insert appears inside a float which could possibly float. --kasal, 26may04
%
\startsavinginserts
%
% We can't be used inside a paragraph.
\par
%
\vtop\bgroup
  \def\floattype{#1}%
  \def\floatlabel{#2}%
  \def\floatloc{#3}% we do nothing with this yet.
  %
  \ifx\floattype\empty
    \let\safefloattype=\empty
  \else
    {%
      % the floattype might have accents or other special characters,
      % but we need to use it in a control sequence name.
      \indexnofonts
      \turnoffactive
      \xdef\safefloattype{\floattype}%
    }%
  \fi
  %
  % If label is given but no type, we handle that as the empty type.
  \ifx\floatlabel\empty \else
    % We want each FLOATTYPE to be numbered separately (Figure 1,
    % Table 1, Figure 2, ...).  (And if no label, no number.)
    %
    \expandafter\getfloatno\csname\safefloattype floatno\endcsname
    \global\advance\floatno by 1
    %
    {%
      % This magic value for \thissection is output by \setref as the
      % XREFLABEL-title value.  \xrefX uses it to distinguish float
      % labels (which have a completely different output format) from
      % node and anchor labels.  And \xrdef uses it to construct the
      % lists of floats.
      %
      \edef\thissection{\floatmagic=\safefloattype}%
      \setref{\floatlabel}{Yfloat}%
    }%
  \fi
  %
  % start with \parskip glue, I guess.
  \vskip\parskip
  %
  % Don't suppress indentation if a float happens to start a section.
  \restorefirstparagraphindent</pre>

<p>}</p>

<p>% we have these possibilities: % @float Foo,lbl &amp; @caption{Cap}: Foo
1.1: Cap % @float Foo,lbl &amp; no caption:    Foo 1.1 % @float Foo &amp;
@caption{Cap}:     Foo: Cap % @float Foo &amp; no caption:        Foo %
@float ,lbl &amp; Caption{Cap}:     1.1: Cap % @float ,lbl &amp; no
caption:       1.1 % @float &amp; @caption{Cap}:         Cap % @float &amp;
no caption: % defEfloat{%</p>

<pre>  \let\floatident = \empty
  %
  % In all cases, if we have a float type, it comes first.
  \ifx\floattype\empty \else \def\floatident{\floattype}\fi
  %
  % If we have an xref label, the number comes next.
  \ifx\floatlabel\empty \else
    \ifx\floattype\empty \else % if also had float type, need tie first.
      \appendtomacro\floatident{\tie}%
    \fi
    % the number.
    \appendtomacro\floatident{\chaplevelprefix\the\floatno}%
  \fi
  %
  % Start the printed caption with what we've constructed in
  % \floatident, but keep it separate; we need \floatident again.
  \let\captionline = \floatident
  %
  \ifx\thiscaption\empty \else
    \ifx\floatident\empty \else
      \appendtomacro\captionline{: }% had ident, so need a colon between
    \fi
    %
    % caption text.
    \appendtomacro\captionline{\scanexp\thiscaption}%
  \fi
  %
  % If we have anything to print, print it, with space before.
  % Eventually this needs to become an \insert.
  \ifx\captionline\empty \else
    \vskip.5\parskip
    \captionline
    %
    % Space below caption.
    \vskip\parskip
  \fi
  %
  % If have an xref label, write the list of floats info.  Do this
  % after the caption, to avoid chance of it being a breakpoint.
  \ifx\floatlabel\empty \else
    % Write the text that goes in the lof to the aux file as
    % \floatlabel-lof.  Besides \floatident, we include the short
    % caption if specified, else the full caption if specified, else nothing.
    {%
      \atdummies
      % since we read the caption text in the macro world, where ^^M
      % is turned into a normal character, we have to scan it back, so
      % we don't write the literal three characters &quot;^^M&quot; into the aux file.
      \scanexp{%
        \xdef\noexpand\gtemp{%
          \ifx\thisshortcaption\empty
            \thiscaption
          \else
            \thisshortcaption
          \fi
        }%
      }%
      \immediate\write\auxfile{@xrdef{\floatlabel-lof}{\floatident
        \ifx\gtemp\empty \else : \gtemp \fi}}%
    }%
  \fi
\egroup  % end of \vtop
%
% place the captured inserts
%
% BEWARE: when the floats start float, we have to issue warning whenever an
% insert appears inside a float which could possibly float. --kasal, 26may04
%
\checkinserts</pre>

<p>}</p>

<p>% Append the tokens #2 to the definition of macro #1, not expanding either.
% defappendtomacro#1#2{%</p>

<pre>\expandafter\def\expandafter#1\expandafter{#1#2}%</pre>

<p>}</p>

<p>% @caption, @shortcaption % defcaption{docaptionthiscaption}
defshortcaption{docaptionthisshortcaption} defdocaption{checkenvfloat
bgroupscanargctxtdefcaption} defdefcaption#1#2{egroup def#1{#2}}</p>

<p>% The parameter is the control sequence identifying the counter we are %
going to use.  Create it if it doesn’t exist and assign it to floatno.
defgetfloatno#1{%</p>

<pre>\ifx#1\relax
    % Haven't seen this figure type before.
    \csname newcount\endcsname #1%
    %
    % Remember to reset this floatno at the next chap.
    \expandafter\gdef\expandafter\resetallfloatnos
      \expandafter{\resetallfloatnos #1=0 }%
\fi
\let\floatno#1%</pre>

<p>}</p>

<p>% setref calls this to get the XREFLABEL-snt value.  We want an @xref % to
the FLOATLABEL to expand to “Figure 3.1”.  We call setref when we % first
read the @float command. % defYfloat{floattype@tie
chaplevelprefixthefloatno}%</p>

<p>% Magic string used for the XREFLABEL-title value, so xrefX can %
distinguish floats from other xref types. deffloatmagic{!!float!!}</p>

<p>% #1 is the control sequence we are passed; we expand into a conditional %
which is true if #1 represents a float ref.  That is, the magic %
thissection value which we setref above. %
defiffloat#1{expandafterdoiffloat#1==finish} % % #1 is (maybe) the
floatmagic string.  If so, #2 will be the % (safe) float type for this
float.  We set iffloattype to #2. % defdoiffloat#1=#2=#3finish{%</p>

<pre>\def\temp{#1}%
\def\iffloattype{#2}%
\ifx\temp\floatmagic</pre>

<p>}</p>

<p>% @listoffloats FLOATTYPE - print a list of floats like a table of
contents. % parseargdeflistoffloats{%</p>

<pre>\def\floattype{#1}% floattype
{%
  % the floattype might have accents or other special characters,
  % but we need to use it in a control sequence name.
  \indexnofonts
  \turnoffactive
  \xdef\safefloattype{\floattype}%
}%
%
% \xrdef saves the floats as a \do-list in \floatlistSAFEFLOATTYPE.
\expandafter\ifx\csname floatlist\safefloattype\endcsname \relax
  \ifhavexrefs
    % if the user said @listoffloats foo but never @float foo.
    \message{\linenumber No `\safefloattype' floats to list.}%
  \fi
\else
  \begingroup
    \leftskip=\tocindent  % indent these entries like a toc
    \let\do=\listoffloatsdo
    \csname floatlist\safefloattype\endcsname
  \endgroup
\fi</pre>

<p>}</p>

<p>% This is called on each entry in a list of floats.  We’re passed the %
xref label, in the form LABEL-title, which is how we save it in the % aux
file.  We strip off the -title and look up XRLABEL-lof, which % has the
text we’re supposed to typeset here. % % Figures without xref labels will
not be included in the list (since % they won’t appear in the aux file). %
deflistoffloatsdo#1{listoffloatsdoentry#1finish}
deflistoffloatsdoentry#1-titlefinish{{%</p>

<pre>% Can't fully expand XR#1-lof because it can contain anything.  Just
% pass the control sequence.  On the other hand, XR#1-pg is just the
% page number, and we want to fully expand that so we can get a link
% in pdf output.
\toksA = \expandafter{\csname XR#1-lof\endcsname}%
%
% use the same \entry macro we use to generate the TOC and index.
\edef\writeentry{\noexpand\entry{\the\toksA}{\csname XR#1-pg\endcsname}}%
\writeentry</pre>

<p>}}</p>

<p>message{localization,} % and i18n.</p>

<p>% @documentlanguage is usually given very early, just after % @setfilename.
If done too late, it may not override everything % properly.  Single
argument is the language abbreviation. % It would be nice if we could set
up a hyphenation file here. % parseargdefdocumentlanguage{%</p>

<pre>\tex % read txi-??.tex file in plain TeX.
  % Read the file if it exists.
  \openin 1 txi-#1.tex
  \ifeof 1
    \errhelp = \nolanghelp
    \errmessage{Cannot read language file txi-#1.tex}%
  \else
    \input txi-#1.tex
  \fi
  \closein 1
\endgroup</pre>

<p>} newhelpnolanghelp{The given language definition file cannot be found or
is empty.  Maybe you need to install it?  In the current directory should
work if nowhere else does.}</p>

<p>% @documentencoding should change something in TeX eventually, most %
likely, but for now just recognize it. letdocumentencoding = comment</p>

<p>% Page size parameters. % newdimendefaultparindent defaultparindent = 15pt</p>

<p>chapheadingskip = 15pt plus 4pt minus 2pt secheadingskip = 12pt plus 3pt
minus 2pt subsecheadingskip = 9pt plus 2pt minus 2pt</p>

<p>% Prevent underfull vbox error messages. vbadness = 10000</p>

<p>% Don’t be so finicky about underfull hboxes, either. hbadness = 2000</p>

<p>% Following George Bush, just get rid of widows and orphans.
widowpenalty=10000 clubpenalty=10000</p>

<p>% Use TeX 3.0’s emergencystretch to help line breaking, but if we’re %
using an old version of TeX, don’t do anything.  We want the amount of %
stretch added to depend on the line length, hence the dependence on %
hsize.  We call this whenever the paper size is set. %
defsetemergencystretch{%</p>

<pre>\ifx\emergencystretch\thisisundefined
  % Allow us to assign to \emergencystretch anyway.
  \def\emergencystretch{\dimen0}%
\else
  \emergencystretch = .15\hsize
\fi</pre>

<p>}</p>

<p>% Parameters in order: 1) textheight; 2) textwidth; % 3) voffset; 4)
hoffset; 5) binding offset; 6) topskip; % 7) physical page height; 8)
physical page width. % % We also call setleading{textleading}, so the
caller should define % textleading.  The caller should also set parskip. %
definternalpagesizes#1#2#3#4#5#6#7#8{%</p>

<pre>\voffset = #3\relax
\topskip = #6\relax
\splittopskip = \topskip
%
\vsize = #1\relax
\advance\vsize by \topskip
\outervsize = \vsize
\advance\outervsize by 2\topandbottommargin
\pageheight = \vsize
%
\hsize = #2\relax
\outerhsize = \hsize
\advance\outerhsize by 0.5in
\pagewidth = \hsize
%
\normaloffset = #4\relax
\bindingoffset = #5\relax
%
\ifpdf
  \pdfpageheight #7\relax
  \pdfpagewidth #8\relax
\fi
%
\setleading{\textleading}
%
\parindent = \defaultparindent
\setemergencystretch</pre>

<p>}</p>

<p>% @letterpaper (the default). defletterpaper{{globaldefs = 1</p>

<pre>\parskip = 3pt plus 2pt minus 1pt
\textleading = 13.2pt
%
% If page is nothing but text, make it come out even.
\internalpagesizes{46\baselineskip}{6in}%
                  {\voffset}{.25in}%
                  {\bindingoffset}{36pt}%
                  {11in}{8.5in}%</pre>

<p>}}</p>

<p>% Use @smallbook to reset parameters for 7x9.25 trim size.
defsmallbook{{globaldefs = 1</p>

<pre>\parskip = 2pt plus 1pt
\textleading = 12pt
%
\internalpagesizes{7.5in}{5in}%
                  {\voffset}{.25in}%
                  {\bindingoffset}{16pt}%
                  {9.25in}{7in}%
%
\lispnarrowing = 0.3in
\tolerance = 700
\hfuzz = 1pt
\contentsrightmargin = 0pt
\defbodyindent = .5cm</pre>

<p>}}</p>

<p>% Use @smallerbook to reset parameters for 6x9 trim size. % (Just testing,
parameters still in flux.) defsmallerbook{{globaldefs = 1</p>

<pre>\parskip = 1.5pt plus 1pt
\textleading = 12pt
%
\internalpagesizes{7.4in}{4.8in}%
                  {-.2in}{-.4in}%
                  {0pt}{14pt}%
                  {9in}{6in}%
%
\lispnarrowing = 0.25in
\tolerance = 700
\hfuzz = 1pt
\contentsrightmargin = 0pt
\defbodyindent = .4cm</pre>

<p>}}</p>

<p>% Use @afourpaper to print on European A4 paper. defafourpaper{{globaldefs
= 1</p>

<pre>\parskip = 3pt plus 2pt minus 1pt
\textleading = 13.2pt
%
% Double-side printing via postscript on Laserjet 4050
% prints double-sided nicely when \bindingoffset=10mm and \hoffset=-6mm.
% To change the settings for a different printer or situation, adjust
% \normaloffset until the front-side and back-side texts align.  Then
% do the same for \bindingoffset.  You can set these for testing in
% your texinfo source file like this:
% @tex
% \global\normaloffset = -6mm
% \global\bindingoffset = 10mm
% @end tex
\internalpagesizes{51\baselineskip}{160mm}
                  {\voffset}{\hoffset}%
                  {\bindingoffset}{44pt}%
                  {297mm}{210mm}%
%
\tolerance = 700
\hfuzz = 1pt
\contentsrightmargin = 0pt
\defbodyindent = 5mm</pre>

<p>}}</p>

<p>% Use @afivepaper to print on European A5 paper. % From
romildo@urano.iceb.ufop.br, 2 July 2000. % He also recommends making
@example and @lisp be small. defafivepaper{{globaldefs = 1</p>

<pre>\parskip = 2pt plus 1pt minus 0.1pt
\textleading = 12.5pt
%
\internalpagesizes{160mm}{120mm}%
                  {\voffset}{\hoffset}%
                  {\bindingoffset}{8pt}%
                  {210mm}{148mm}%
%
\lispnarrowing = 0.2in
\tolerance = 800
\hfuzz = 1.2pt
\contentsrightmargin = 0pt
\defbodyindent = 2mm
\tableindent = 12mm</pre>

<p>}}</p>

<p>% A specific text layout, 24x15cm overall, intended for A4 paper.
defafourlatex{{globaldefs = 1</p>

<pre>\afourpaper
\internalpagesizes{237mm}{150mm}%
                  {\voffset}{4.6mm}%
                  {\bindingoffset}{7mm}%
                  {297mm}{210mm}%
%
% Must explicitly reset to 0 because we call \afourpaper.
\globaldefs = 0</pre>

<p>}}</p>

<p>% Use @afourwide to print on A4 paper in landscape format.
defafourwide{{globaldefs = 1</p>

<pre>\afourpaper
\internalpagesizes{241mm}{165mm}%
                  {\voffset}{-2.95mm}%
                  {\bindingoffset}{7mm}%
                  {297mm}{210mm}%
\globaldefs = 0</pre>

<p>}}</p>

<p>% @pagesizes <a href=",TEXTWIDTH">TEXTHEIGHT</a> % Perhaps we should allow
setting the margins, topskip, parskip, % and/or leading, also. Or perhaps
we should compute them somehow. % parseargdefpagesizes{pagesizesyyy
#1,,finish} defpagesizesyyy#1,#2,#3finish{{%</p>

<pre>\setbox0 = \hbox{\ignorespaces #2}\ifdim\wd0 &gt; 0pt \hsize=#2\relax \fi
\globaldefs = 1
%
\parskip = 3pt plus 2pt minus 1pt
\setleading{\textleading}%
%
\dimen0 = #1
\advance\dimen0 by \voffset
%
\dimen2 = \hsize
\advance\dimen2 by \normaloffset
%
\internalpagesizes{#1}{\hsize}%
                  {\voffset}{\normaloffset}%
                  {\bindingoffset}{44pt}%
                  {\dimen0}{\dimen2}%</pre>

<p>}}</p>

<p>% Set default to letter. % letterpaper</p>

<p>message{and turning on texinfo input format.}</p>

<p>% Define macros to output various characters with catcode for normal text.
catcode`&quot;=other catcode`~=other catcode`^=other catcode`_=other
catcode`|=other catcode`&lt;=other catcode`&gt;=other catcode`+=other
catcode`$=other defnormaldoublequote{“} defnormaltilde{~} defnormalcaret{^}
defnormalunderscore{_} defnormalverticalbar{|} defnormalless{&lt;}
defnormalgreater{&gt;} defnormalplus{+} defnormaldollar{$}%$ font-lock fix</p>

<p>% This macro is used to make a character print one way in tt % (where it
can probably be output as-is), and another way in other fonts, % where
something hairier probably needs to be done. % % #1 is what to print if we
are indeed using tt; #2 is what to print % otherwise.  Since all the
Computer Modern typewriter fonts have zero % interword stretch (and
shrink), and it is reasonable to expect all % typewriter fonts to have
this, we can check that font parameter. % defifusingtt#1#2{ifdim
fontdimen3font=0pt #1else #2fi}</p>

<p>% Same as above, but check for italic font.  Actually this also catches %
non-italic slanted fonts since it is impossible to distinguish them from %
italic fonts.  But since this is only used by $ and it uses sl anyway %
this is not a problem. defifusingit#1#2{ifdim fontdimen1font&gt;0pt #1else
#2fi}</p>

<p>% Turn off all special characters except @ % (and those which the user can
use as if they were ordinary). % Most of these we simply print from the tt
font, but for some, we can % use math or other variants that look better in
normal text.</p>

<p>catcode`&quot;=active defactivedoublequote{{ttchar34}}
let“=activedoublequote catcode`~=active def~{{ttchar126}} chardefhat=`^
catcode`^=active def^{{tt hat}}</p>

<p>catcode`_=active def_{ifusingttnormalunderscore_} letrealunder=_ %
Subroutine for the previous macro. def_{leavevmode kern.07em vbox{hrule
width.3em height.1ex}kern .07em }</p>

<p>catcode`|=active def|{{ttchar124}} chardef less=`&lt; catcode`&lt;=active
def&lt;{{tt less}} chardef gtr=`&gt; catcode`&gt;=active def&gt;{{tt gtr}}
catcode`+=active def+{{tt char 43}} catcode`$=active
def${ifusingit{{sl$}}normaldollar}%$ font-lock fix</p>

<p>% If a .fmt file is being used, characters that might appear in a file %
name cannot be active until we have parsed the command line. % So turn them
off again, and have everyjob (or @setfilename) turn them on. %
otherifyactive is called near the end of this file.
defotherifyactive{catcode`+=other catcode`_=other}</p>

<p>catcode`@=0</p>

<p>% backslashcurfont outputs one backslash character in current font, % as in
char`\. globalchardefbackslashcurfont=`\
globalletrawbackslashxx=backslashcurfont  % let existing .??s files work</p>

<p>% rawbackslash defines an active \ to do backslashcurfont. % otherbackslash
defines an active \ to be a literal `' character with % catcode other.
{catcode`\=active</p>

<pre>@gdef@rawbackslash{@let\=@backslashcurfont}
@gdef@otherbackslash{@let\=@realbackslash}</pre>

<p>}</p>

<p>% realbackslash is an actual character `' with catcode other, and %
doublebackslash is two of them (for the pdf outlines). {catcode`\=other
@gdef@realbackslash{} @gdef@doublebackslash{\}}</p>

<p>% normalbackslash outputs one backslash in fixed width font.
defnormalbackslash{{ttbackslashcurfont}}</p>

<p>catcode`\=active</p>

<p>% Used sometimes to turn off (effectively) the active characters % even
after parsing them. @def@turnoffactive{%</p>

<pre>@let&quot;=@normaldoublequote
@let\=@realbackslash
@let~=@normaltilde
@let^=@normalcaret
@let_=@normalunderscore
@let|=@normalverticalbar
@let&lt;=@normalless
@let&gt;=@normalgreater
@let+=@normalplus
@let$=@normaldollar %$ font-lock fix
@unsepspaces</pre>

<p>}</p>

<p>% Same as @turnoffactive except outputs \ as {ttchar`\} instead of % the
literal character `'.  (Thus, \ is not expandable when this is in %
effect.) % @def@normalturnoffactive{@turnoffactive @let=@normalbackslash}</p>

<p>% Make _ and + other characters, temporarily. % This is canceled by
@fixbackslash. @otherifyactive</p>

<p>% If a .fmt file is being used, we don’t want the `input texinfo’ to show
up. % That is what eatinput is for; after that, the `' should revert to
printing % a backslash. % @gdef@eatinput input texinfo{@fixbackslash}
@global@let\ = @eatinput</p>

<p>% On the other hand, perhaps the file did not have a `input texinfo’. Then
% the first `{ in the file would cause an error. This macro tries to fix %
that, assuming it is called before the first `' could plausibly occur. %
Also turn back on active characters that might appear in the input % file
name, in case not using a pre-dumped format. % @gdef@fixbackslash{%</p>

<pre>@ifx\@eatinput @let\ = @normalbackslash @fi
@catcode`+=@active
@catcode`@_=@active</pre>

<p>}</p>

<p>% Say @foo, not foo, in error messages. @escapechar = `@@</p>

<p>% These look ok in all fonts, so just make them not special.
@catcode`@&amp; = @other @catcode`@# = @other @catcode`@% = @other</p>

<p>@c Local variables: @c eval: (add-hook ‘write-file-hooks ’time-stamp) @c
page-delimiter: “^\\message” @c time-stamp-start: “def\\texinfoversion{” @c
time-stamp-format: “%:y-%02m-%02d.%02H” @c time-stamp-end: “}” @c End:</p>

<p>@c vim:sw=2:</p>

<p>@ignore</p>

<pre>arch-tag: e1b36e32-c96e-4135-a41a-0b2efa2ea115</pre>

<p>@end ignore</p>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

