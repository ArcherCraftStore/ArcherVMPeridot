<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>win32.S - ffi-1.9.3-x86-mingw32 Documentation</title>

<link href="../../../../../fonts.css" rel="stylesheet">
<link href="../../../../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../../../";
</script>

<script src="../../../../../js/jquery.js"></script>
<script src="../../../../../js/navigation.js"></script>
<script src="../../../../../js/search_index.js"></script>
<script src="../../../../../js/search.js"></script>
<script src="../../../../../js/searcher.js"></script>
<script src="../../../../../js/darkfish.js"></script>


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog.html">ChangeLog</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog_libffi.html">ChangeLog.libffi</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog_libgcj.html">ChangeLog.libgcj</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog_v1.html">ChangeLog.v1</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_vc.html">Makefile.vc</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_vc64.html">Makefile.vc64</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/README.html">README</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/acinclude_m4.html">acinclude.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/build-ios_sh.html">build-ios.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/compile.html">compile</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/config_guess.html">config.guess</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/config_sub.html">config.sub</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/configure.html">configure</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/configure_ac.html">configure.ac</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/configure_host.html">configure.host</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/depcomp.html">depcomp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/doc/libffi_info.html">libffi.info</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/doc/stamp-vti.html">stamp-vti</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/doc/version_texi.html">version.texi</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/fficonfig_h_in.html">fficonfig.h.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/include/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/include/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/install-sh.html">install-sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/libffi_pc_in.html">libffi.pc.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/libtool-version.html">libtool-version</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ltmain_sh.html">ltmain.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_cc_maxopt_m4.html">ax_cc_maxopt.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_cflags_warn_all_m4.html">ax_cflags_warn_all.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_check_compiler_flags_m4.html">ax_check_compiler_flags.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_compiler_vendor_m4.html">ax_compiler_vendor.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_configure_args_m4.html">ax_configure_args.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_enable_builddir_m4.html">ax_enable_builddir.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_gcc_archflag_m4.html">ax_gcc_archflag.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_gcc_x86_cpuid_m4.html">ax_gcc_x86_cpuid.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/ffi_3.html">ffi.3</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/ffi_call_3.html">ffi_call.3</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/ffi_prep_cif_3.html">ffi_prep_cif.3</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/mdate-sh.html">mdate-sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/missing.html">missing</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/msvcc_sh.html">msvcc.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/alpha/osf_S.html">osf.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/arm/gentramp_sh.html">gentramp.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/arm/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/arm/trampoline_S.html">trampoline.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/avr32/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/cris/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/frv/eabi_S.html">eabi.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/ia64/unix_S.html">unix.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/m32r/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/m68k/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/mips/n32_S.html">n32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/mips/o32_S.html">o32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/moxie/eabi_S.html">eabi.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/pa/hpux32_S.html">hpux32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/pa/linux_S.html">linux.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/aix_S.html">aix.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/aix_closure_S.html">aix_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/darwin_S.html">darwin.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/darwin_closure_S.html">darwin_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/linux64_S.html">linux64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/linux64_closure_S.html">linux64_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/ppc_closure_S.html">ppc_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/s390/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sh/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sh64/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sparc/v8_S.html">v8.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sparc/v9_S.html">v9.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/darwin_S.html">darwin.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/darwin64_S.html">darwin64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/freebsd_S.html">freebsd.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/unix64_S.html">unix64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/win32_S.html">win32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/win64_S.html">win64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/config/default_exp.html">default.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/libffi-dg_exp.html">libffi-dg.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/libffi_exp.html">libffi.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/target-libpath_exp.html">target-libpath.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/wrapper_exp.html">wrapper.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/libffi_call/call_exp.html">call.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/libffi_special/special_exp.html">special.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/texinfo_tex.html">texinfo.tex</a>
  
    <li><a href="../../../../../lib/ffi/platform/arm-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-cygwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-freebsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-gnu/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-netbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-openbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-windows/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/ia64-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/mips-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/mipsel-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/powerpc-aix/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/powerpc-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/powerpc-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/s390-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/s390x-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/sparc-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/sparc-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/sparcv9-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-cygwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-freebsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-netbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-openbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-windows/types_conf.html">types.conf</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page ext/ffi_c/libffi/src/x86/win32.S">

<pre>-----------------------------------------------------------------------
win32.S - Copyright (c) 1996, 1998, 2001, 2002, 2009  Red Hat, Inc.
          Copyright (c) 2001  John Beniton
          Copyright (c) 2002  Ranjit Mathew
          Copyright (c) 2009  Daniel Witte

X86 Foreign Function Interface

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
``Software''), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED ``AS IS'', WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT.  IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
DEALINGS IN THE SOFTWARE.
-----------------------------------------------------------------------</pre>

<p>define LIBFFI_ASM include &lt;fficonfig.h&gt; include &lt;ffi.h&gt;</p>

<p>ifdef _MSC_VER</p>

<p>.386 .MODEL FLAT, C</p>

<p>EXTRN ffi_closure_SYSV_inner:NEAR</p>

<p>_TEXT SEGMENT</p>

<p>ffi_call_win32 PROC NEAR,</p>

<pre>ffi_prep_args : NEAR PTR DWORD,
ecif          : NEAR PTR DWORD,
cif_bytes     : DWORD,
cif_flags     : DWORD,
rvalue        : NEAR PTR DWORD,
fn            : NEAR PTR DWORD

    ;; Make room for all of the new args.
    mov  ecx, cif_bytes
    sub  esp, ecx

    mov  eax, esp

    ;; Place all of the ffi_prep_args in position
    push ecif
    push eax
    call ffi_prep_args

    ;; Return stack to previous state and call the function
    add  esp, 8

    call fn

    ;; cdecl:   we restore esp in the epilogue, so there's no need to
    ;;          remove the space we pushed for the args.
    ;; stdcall: the callee has already cleaned the stack.

    ;; Load ecx with the return type code
    mov  ecx, cif_flags

    ;; If the return value pointer is NULL, assume no return value.
    cmp  rvalue, 0
    jne  ca_jumptable

    ;; Even if there is no space for the return value, we are
    ;; obliged to handle floating-point values.
    cmp  ecx, FFI_TYPE_FLOAT
    jne  ca_epilogue
    fstp st(0)

    jmp  ca_epilogue</pre>

<p>ca_jumptable:</p>

<pre>jmp  [ca_jumpdata + 4 * ecx]</pre>

<p>ca_jumpdata:</p>

<pre>;; Do not insert anything here between label and jump table.
dd offset ca_epilogue       ;; FFI_TYPE_VOID
dd offset ca_retint         ;; FFI_TYPE_INT
dd offset ca_retfloat       ;; FFI_TYPE_FLOAT
dd offset ca_retdouble      ;; FFI_TYPE_DOUBLE
dd offset ca_retlongdouble  ;; FFI_TYPE_LONGDOUBLE
dd offset ca_retint8        ;; FFI_TYPE_UINT8
dd offset ca_retint8        ;; FFI_TYPE_SINT8
dd offset ca_retint16       ;; FFI_TYPE_UINT16
dd offset ca_retint16       ;; FFI_TYPE_SINT16
dd offset ca_retint         ;; FFI_TYPE_UINT32
dd offset ca_retint         ;; FFI_TYPE_SINT32
dd offset ca_retint64       ;; FFI_TYPE_UINT64
dd offset ca_retint64       ;; FFI_TYPE_SINT64
dd offset ca_epilogue       ;; FFI_TYPE_STRUCT
dd offset ca_retint         ;; FFI_TYPE_POINTER
dd offset ca_retint8        ;; FFI_TYPE_SMALL_STRUCT_1B
dd offset ca_retint16       ;; FFI_TYPE_SMALL_STRUCT_2B
dd offset ca_retint         ;; FFI_TYPE_SMALL_STRUCT_4B</pre>

<p>ca_retint8:</p>

<pre>;; Load %ecx with the pointer to storage for the return value
mov   ecx, rvalue
mov   [ecx + 0], al
jmp   ca_epilogue</pre>

<p>ca_retint16:</p>

<pre>;; Load %ecx with the pointer to storage for the return value
mov   ecx, rvalue
mov   [ecx + 0], ax
jmp   ca_epilogue</pre>

<p>ca_retint:</p>

<pre>;; Load %ecx with the pointer to storage for the return value
mov   ecx, rvalue
mov   [ecx + 0], eax
jmp   ca_epilogue</pre>

<p>ca_retint64:</p>

<pre>;; Load %ecx with the pointer to storage for the return value
mov   ecx, rvalue
mov   [ecx + 0], eax
mov   [ecx + 4], edx
jmp   ca_epilogue</pre>

<p>ca_retfloat:</p>

<pre>;; Load %ecx with the pointer to storage for the return value
mov   ecx, rvalue
fstp  DWORD PTR [ecx]
jmp   ca_epilogue</pre>

<p>ca_retdouble:</p>

<pre>;; Load %ecx with the pointer to storage for the return value
mov   ecx, rvalue
fstp  QWORD PTR [ecx]
jmp   ca_epilogue</pre>

<p>ca_retlongdouble:</p>

<pre>;; Load %ecx with the pointer to storage for the return value
mov   ecx, rvalue
fstp  TBYTE PTR [ecx]
jmp   ca_epilogue</pre>

<p>ca_epilogue:</p>

<pre>;; Epilogue code is autogenerated.
ret</pre>

<p>ffi_call_win32 ENDP</p>

<p>ffi_closure_SYSV PROC NEAR FORCEFRAME</p>

<pre>;; the ffi_closure ctx is passed in eax by the trampoline.

    sub  esp, 40
    lea  edx, [ebp - 24]
    mov  [ebp - 12], edx         ;; resp
    lea  edx, [ebp + 8]
    mov  [esp + 8], edx          ;; args
    lea  edx, [ebp - 12]
    mov  [esp + 4], edx          ;; &amp;resp
    mov  [esp], eax              ;; closure
    call ffi_closure_SYSV_inner
    mov  ecx, [ebp - 12]</pre>

<p>cs_jumptable:</p>

<pre>jmp  [cs_jumpdata + 4 * eax]</pre>

<p>cs_jumpdata:</p>

<pre>;; Do not insert anything here between the label and jump table.
dd offset cs_epilogue       ;; FFI_TYPE_VOID
dd offset cs_retint         ;; FFI_TYPE_INT
dd offset cs_retfloat       ;; FFI_TYPE_FLOAT
dd offset cs_retdouble      ;; FFI_TYPE_DOUBLE
dd offset cs_retlongdouble  ;; FFI_TYPE_LONGDOUBLE
dd offset cs_retint8        ;; FFI_TYPE_UINT8
dd offset cs_retint8        ;; FFI_TYPE_SINT8
dd offset cs_retint16       ;; FFI_TYPE_UINT16
dd offset cs_retint16       ;; FFI_TYPE_SINT16
dd offset cs_retint         ;; FFI_TYPE_UINT32
dd offset cs_retint         ;; FFI_TYPE_SINT32
dd offset cs_retint64       ;; FFI_TYPE_UINT64
dd offset cs_retint64       ;; FFI_TYPE_SINT64
dd offset cs_retstruct      ;; FFI_TYPE_STRUCT
dd offset cs_retint         ;; FFI_TYPE_POINTER
dd offset cs_retint8        ;; FFI_TYPE_SMALL_STRUCT_1B
dd offset cs_retint16       ;; FFI_TYPE_SMALL_STRUCT_2B
dd offset cs_retint         ;; FFI_TYPE_SMALL_STRUCT_4B</pre>

<p>cs_retint8:</p>

<pre>mov   al, [ecx]
jmp   cs_epilogue</pre>

<p>cs_retint16:</p>

<pre>mov   ax, [ecx]
jmp   cs_epilogue</pre>

<p>cs_retint:</p>

<pre>mov   eax, [ecx]
jmp   cs_epilogue</pre>

<p>cs_retint64:</p>

<pre>mov   eax, [ecx + 0]
mov   edx, [ecx + 4]
jmp   cs_epilogue</pre>

<p>cs_retfloat:</p>

<pre>fld   DWORD PTR [ecx]
jmp   cs_epilogue</pre>

<p>cs_retdouble:</p>

<pre>fld   QWORD PTR [ecx]
jmp   cs_epilogue</pre>

<p>cs_retlongdouble:</p>

<pre>fld   TBYTE PTR [ecx]
jmp   cs_epilogue</pre>

<p>cs_retstruct:</p>

<pre>;; Caller expects us to pop struct return value pointer hidden arg.
;; Epilogue code is autogenerated.
ret     4</pre>

<p>cs_epilogue:</p>

<pre>;; Epilogue code is autogenerated.
ret</pre>

<p>ffi_closure_SYSV ENDP</p>

<p>if !FFI_NO_RAW_API</p>

<p>define RAW_CLOSURE_CIF_OFFSET ((FFI_TRAMPOLINE_SIZE + 3) AND NOT 3) define
RAW_CLOSURE_FUN_OFFSET (RAW_CLOSURE_CIF_OFFSET + 4) define
RAW_CLOSURE_USER_DATA_OFFSET (RAW_CLOSURE_FUN_OFFSET + 4) define
CIF_FLAGS_OFFSET 20</p>

<p>ffi_closure_raw_SYSV PROC NEAR USES esi</p>

<pre>;; the ffi_closure ctx is passed in eax by the trampoline.

    sub  esp, 40
    mov  esi, [eax + RAW_CLOSURE_CIF_OFFSET]        ;; closure-&gt;cif
    mov  edx, [eax + RAW_CLOSURE_USER_DATA_OFFSET]  ;; closure-&gt;user_data
    mov  [esp + 12], edx                            ;; user_data
    lea  edx, [ebp + 8]
    mov  [esp + 8], edx                             ;; raw_args
    lea  edx, [ebp - 24]
    mov  [esp + 4], edx                             ;; &amp;res
    mov  [esp], esi                                 ;; cif
    call DWORD PTR [eax + RAW_CLOSURE_FUN_OFFSET]   ;; closure-&gt;fun
    mov  eax, [esi + CIF_FLAGS_OFFSET]              ;; cif-&gt;flags
    lea  ecx, [ebp - 24]</pre>

<p>cr_jumptable:</p>

<pre>jmp  [cr_jumpdata + 4 * eax]</pre>

<p>cr_jumpdata:</p>

<pre>;; Do not insert anything here between the label and jump table.
dd offset cr_epilogue       ;; FFI_TYPE_VOID
dd offset cr_retint         ;; FFI_TYPE_INT
dd offset cr_retfloat       ;; FFI_TYPE_FLOAT
dd offset cr_retdouble      ;; FFI_TYPE_DOUBLE
dd offset cr_retlongdouble  ;; FFI_TYPE_LONGDOUBLE
dd offset cr_retint8        ;; FFI_TYPE_UINT8
dd offset cr_retint8        ;; FFI_TYPE_SINT8
dd offset cr_retint16       ;; FFI_TYPE_UINT16
dd offset cr_retint16       ;; FFI_TYPE_SINT16
dd offset cr_retint         ;; FFI_TYPE_UINT32
dd offset cr_retint         ;; FFI_TYPE_SINT32
dd offset cr_retint64       ;; FFI_TYPE_UINT64
dd offset cr_retint64       ;; FFI_TYPE_SINT64
dd offset cr_epilogue       ;; FFI_TYPE_STRUCT
dd offset cr_retint         ;; FFI_TYPE_POINTER
dd offset cr_retint8        ;; FFI_TYPE_SMALL_STRUCT_1B
dd offset cr_retint16       ;; FFI_TYPE_SMALL_STRUCT_2B
dd offset cr_retint         ;; FFI_TYPE_SMALL_STRUCT_4B</pre>

<p>cr_retint8:</p>

<pre>mov   al, [ecx]
jmp   cr_epilogue</pre>

<p>cr_retint16:</p>

<pre>mov   ax, [ecx]
jmp   cr_epilogue</pre>

<p>cr_retint:</p>

<pre>mov   eax, [ecx]
jmp   cr_epilogue</pre>

<p>cr_retint64:</p>

<pre>mov   eax, [ecx + 0]
mov   edx, [ecx + 4]
jmp   cr_epilogue</pre>

<p>cr_retfloat:</p>

<pre>fld   DWORD PTR [ecx]
jmp   cr_epilogue</pre>

<p>cr_retdouble:</p>

<pre>fld   QWORD PTR [ecx]
jmp   cr_epilogue</pre>

<p>cr_retlongdouble:</p>

<pre>fld   TBYTE PTR [ecx]
jmp   cr_epilogue</pre>

<p>cr_epilogue:</p>

<pre>;; Epilogue code is autogenerated.
ret</pre>

<p>ffi_closure_raw_SYSV ENDP</p>

<p>endif    !FFI_NO_RAW_API</p>

<p>ffi_closure_STDCALL PROC NEAR FORCEFRAME</p>

<pre>;; the ffi_closure ctx is passed in eax by the trampoline.

    sub  esp, 40
    lea  edx, [ebp - 24]
    mov  [ebp - 12], edx         ;; resp
    lea  edx, [ebp + 12]         ;; account for stub return address on stack
    mov  [esp + 8], edx          ;; args
    lea  edx, [ebp - 12]
    mov  [esp + 4], edx          ;; &amp;resp
    mov  [esp], eax              ;; closure
    call ffi_closure_SYSV_inner
    mov  ecx, [ebp - 12]</pre>

<p>cd_jumptable:</p>

<pre>jmp  [cd_jumpdata + 4 * eax]</pre>

<p>cd_jumpdata:</p>

<pre>;; Do not insert anything here between the label and jump table.
dd offset cd_epilogue       ;; FFI_TYPE_VOID
dd offset cd_retint         ;; FFI_TYPE_INT
dd offset cd_retfloat       ;; FFI_TYPE_FLOAT
dd offset cd_retdouble      ;; FFI_TYPE_DOUBLE
dd offset cd_retlongdouble  ;; FFI_TYPE_LONGDOUBLE
dd offset cd_retint8        ;; FFI_TYPE_UINT8
dd offset cd_retint8        ;; FFI_TYPE_SINT8
dd offset cd_retint16       ;; FFI_TYPE_UINT16
dd offset cd_retint16       ;; FFI_TYPE_SINT16
dd offset cd_retint         ;; FFI_TYPE_UINT32
dd offset cd_retint         ;; FFI_TYPE_SINT32
dd offset cd_retint64       ;; FFI_TYPE_UINT64
dd offset cd_retint64       ;; FFI_TYPE_SINT64
dd offset cd_epilogue       ;; FFI_TYPE_STRUCT
dd offset cd_retint         ;; FFI_TYPE_POINTER
dd offset cd_retint8        ;; FFI_TYPE_SMALL_STRUCT_1B
dd offset cd_retint16       ;; FFI_TYPE_SMALL_STRUCT_2B
dd offset cd_retint         ;; FFI_TYPE_SMALL_STRUCT_4B</pre>

<p>cd_retint8:</p>

<pre>mov   al, [ecx]
jmp   cd_epilogue</pre>

<p>cd_retint16:</p>

<pre>mov   ax, [ecx]
jmp   cd_epilogue</pre>

<p>cd_retint:</p>

<pre>mov   eax, [ecx]
jmp   cd_epilogue</pre>

<p>cd_retint64:</p>

<pre>mov   eax, [ecx + 0]
mov   edx, [ecx + 4]
jmp   cd_epilogue</pre>

<p>cd_retfloat:</p>

<pre>fld   DWORD PTR [ecx]
jmp   cd_epilogue</pre>

<p>cd_retdouble:</p>

<pre>fld   QWORD PTR [ecx]
jmp   cd_epilogue</pre>

<p>cd_retlongdouble:</p>

<pre>fld   TBYTE PTR [ecx]
jmp   cd_epilogue</pre>

<p>cd_epilogue:</p>

<pre>;; Epilogue code is autogenerated.
ret</pre>

<p>ffi_closure_STDCALL ENDP</p>

<p>_TEXT ENDS END</p>

<p>else</p>

<pre>.text

# This assumes we are using gas.
.balign 16
.globl  _ffi_call_win32</pre>

<p>ifndef <em>OS2</em></p>

<pre class="ruby">.<span class="ruby-identifier">def</span>    <span class="ruby-identifier">_ffi_call_win32</span>;        .<span class="ruby-identifier">scl</span>    <span class="ruby-value">2</span>;      .<span class="ruby-identifier">type</span>   <span class="ruby-value">32</span>;     .<span class="ruby-identifier">endef</span>
</pre>

<p>endif _ffi_call_win32: .LFB1:</p>

<pre>pushl %ebp</pre>

<p>.LCFI0:</p>

<pre>movl  %esp,%ebp</pre>

<p>.LCFI1:</p>

<pre># Make room for all of the new args.
movl  16(%ebp),%ecx                                                     
subl  %ecx,%esp

movl  %esp,%eax

# Place all of the ffi_prep_args in position
pushl 12(%ebp)
pushl %eax
call  *8(%ebp)

# Return stack to previous state and call the function
addl  $8,%esp

# FIXME: Align the stack to a 128-bit boundary to avoid
# potential performance hits.

call  *28(%ebp)

# stdcall functions pop arguments off the stack themselves

# Load %ecx with the return type code
movl  20(%ebp),%ecx

# If the return value pointer is NULL, assume no return value.
cmpl  $0,24(%ebp)
jne   0f

# Even if there is no space for the return value, we are
# obliged to handle floating-point values.
cmpl  $FFI_TYPE_FLOAT,%ecx
jne   .Lnoretval
fstp  %st(0)

jmp   .Lepilogue</pre>

<p>0:</p>

<pre>call    1f
# Do not insert anything here between the call and the jump table.</pre>

<p>.Lstore_table:</p>

<pre>.long   .Lnoretval              /* FFI_TYPE_VOID */
.long   .Lretint                /* FFI_TYPE_INT */
.long   .Lretfloat              /* FFI_TYPE_FLOAT */
.long   .Lretdouble             /* FFI_TYPE_DOUBLE */
.long   .Lretlongdouble         /* FFI_TYPE_LONGDOUBLE */
.long   .Lretuint8              /* FFI_TYPE_UINT8 */
.long   .Lretsint8              /* FFI_TYPE_SINT8 */
.long   .Lretuint16             /* FFI_TYPE_UINT16 */
.long   .Lretsint16             /* FFI_TYPE_SINT16 */
.long   .Lretint                /* FFI_TYPE_UINT32 */
.long   .Lretint                /* FFI_TYPE_SINT32 */
.long   .Lretint64              /* FFI_TYPE_UINT64 */
.long   .Lretint64              /* FFI_TYPE_SINT64 */
.long   .Lretstruct             /* FFI_TYPE_STRUCT */
.long   .Lretint                /* FFI_TYPE_POINTER */
.long   .Lretstruct1b           /* FFI_TYPE_SMALL_STRUCT_1B */
.long   .Lretstruct2b           /* FFI_TYPE_SMALL_STRUCT_2B */
.long   .Lretstruct4b           /* FFI_TYPE_SMALL_STRUCT_4B */</pre>

<p>1:</p>

<pre>add     %ecx, %ecx
add     %ecx, %ecx
add     (%esp),%ecx
add     $4, %esp
jmp     *(%ecx)

/* Sign/zero extend as appropriate.  */</pre>

<p>.Lretsint8:</p>

<pre>movsbl  %al, %eax
jmp     .Lretint</pre>

<p>.Lretsint16:</p>

<pre>movswl  %ax, %eax
jmp     .Lretint</pre>

<p>.Lretuint8:</p>

<pre>movzbl  %al, %eax
jmp     .Lretint</pre>

<p>.Lretuint16:</p>

<pre>movzwl  %ax, %eax
jmp     .Lretint</pre>

<p>.Lretint:</p>

<pre># Load %ecx with the pointer to storage for the return value
movl  24(%ebp),%ecx
movl  %eax,0(%ecx)
jmp   .Lepilogue</pre>

<p>.Lretfloat:</p>

<pre> # Load %ecx with the pointer to storage for the return value
movl  24(%ebp),%ecx
fstps (%ecx)
jmp   .Lepilogue</pre>

<p>.Lretdouble:</p>

<pre># Load %ecx with the pointer to storage for the return value
movl  24(%ebp),%ecx
fstpl (%ecx)
jmp   .Lepilogue</pre>

<p>.Lretlongdouble:</p>

<pre># Load %ecx with the pointer to storage for the return value
movl  24(%ebp),%ecx
fstpt (%ecx)
jmp   .Lepilogue</pre>

<p>.Lretint64:</p>

<pre># Load %ecx with the pointer to storage for the return value
movl  24(%ebp),%ecx
movl  %eax,0(%ecx)
movl  %edx,4(%ecx)
jmp   .Lepilogue</pre>

<p>.Lretstruct1b:</p>

<pre># Load %ecx with the pointer to storage for the return value
movl  24(%ebp),%ecx
movb  %al,0(%ecx)
jmp   .Lepilogue</pre>

<p>.Lretstruct2b:</p>

<pre># Load %ecx with the pointer to storage for the return value
movl  24(%ebp),%ecx
movw  %ax,0(%ecx)
jmp   .Lepilogue</pre>

<p>.Lretstruct4b:</p>

<pre># Load %ecx with the pointer to storage for the return value
movl  24(%ebp),%ecx
movl  %eax,0(%ecx)
jmp   .Lepilogue</pre>

<p>.Lretstruct:</p>

<pre># Nothing to do!</pre>

<p>.Lnoretval: .Lepilogue:</p>

<pre>movl %ebp,%esp
popl %ebp
ret</pre>

<p>.ffi_call_win32_end: .LFE1:</p>

<pre># This assumes we are using gas.
.balign 16
.globl  _ffi_closure_SYSV</pre>

<p>ifndef <em>OS2</em></p>

<pre class="ruby">.<span class="ruby-identifier">def</span>    <span class="ruby-identifier">_ffi_closure_SYSV</span>;      .<span class="ruby-identifier">scl</span>    <span class="ruby-value">2</span>;      .<span class="ruby-identifier">type</span>   <span class="ruby-value">32</span>;     .<span class="ruby-identifier">endef</span>
</pre>

<p>endif _ffi_closure_SYSV: .LFB3:</p>

<pre>pushl   %ebp</pre>

<p>.LCFI4:</p>

<pre>movl    %esp, %ebp</pre>

<p>.LCFI5:</p>

<pre>subl    $40, %esp
leal    -24(%ebp), %edx
movl    %edx, -12(%ebp) /* resp */
leal    8(%ebp), %edx
movl    %edx, 4(%esp)   /* args = __builtin_dwarf_cfa () */
leal    -12(%ebp), %edx
movl    %edx, (%esp)    /* &amp;resp */
call    _ffi_closure_SYSV_inner
movl    -12(%ebp), %ecx</pre>

<p>0:</p>

<pre>call    1f
# Do not insert anything here between the call and the jump table.</pre>

<p>.Lcls_store_table:</p>

<pre>.long   .Lcls_noretval          /* FFI_TYPE_VOID */
.long   .Lcls_retint            /* FFI_TYPE_INT */
.long   .Lcls_retfloat          /* FFI_TYPE_FLOAT */
.long   .Lcls_retdouble         /* FFI_TYPE_DOUBLE */
.long   .Lcls_retldouble        /* FFI_TYPE_LONGDOUBLE */
.long   .Lcls_retuint8          /* FFI_TYPE_UINT8 */
.long   .Lcls_retsint8          /* FFI_TYPE_SINT8 */
.long   .Lcls_retuint16         /* FFI_TYPE_UINT16 */
.long   .Lcls_retsint16         /* FFI_TYPE_SINT16 */
.long   .Lcls_retint            /* FFI_TYPE_UINT32 */
.long   .Lcls_retint            /* FFI_TYPE_SINT32 */
.long   .Lcls_retllong          /* FFI_TYPE_UINT64 */
.long   .Lcls_retllong          /* FFI_TYPE_SINT64 */
.long   .Lcls_retstruct         /* FFI_TYPE_STRUCT */
.long   .Lcls_retint            /* FFI_TYPE_POINTER */
.long   .Lcls_retstruct1        /* FFI_TYPE_SMALL_STRUCT_1B */
.long   .Lcls_retstruct2        /* FFI_TYPE_SMALL_STRUCT_2B */
.long   .Lcls_retstruct4        /* FFI_TYPE_SMALL_STRUCT_4B */</pre>

<p>1:</p>

<pre>add     %eax, %eax
add     %eax, %eax
add     (%esp),%eax
add     $4, %esp
jmp     *(%eax)

/* Sign/zero extend as appropriate.  */</pre>

<p>.Lcls_retsint8:</p>

<pre>movsbl  (%ecx), %eax
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retsint16:</p>

<pre>movswl  (%ecx), %eax
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retuint8:</p>

<pre>movzbl  (%ecx), %eax
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retuint16:</p>

<pre>movzwl  (%ecx), %eax
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retint:</p>

<pre>movl    (%ecx), %eax
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retfloat:</p>

<pre>flds    (%ecx)
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retdouble:</p>

<pre>fldl    (%ecx)
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retldouble:</p>

<pre>fldt    (%ecx)
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retllong:</p>

<pre>movl    (%ecx), %eax
movl    4(%ecx), %edx
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retstruct1:</p>

<pre>movsbl  (%ecx), %eax
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retstruct2:</p>

<pre>movswl  (%ecx), %eax
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retstruct4:</p>

<pre>movl    (%ecx), %eax
jmp     .Lcls_epilogue</pre>

<p>.Lcls_retstruct:</p>

<pre># Caller expects us to pop struct return value pointer hidden arg.
movl    %ebp, %esp
popl    %ebp
ret     $0x4</pre>

<p>.Lcls_noretval: .Lcls_epilogue:</p>

<pre>movl    %ebp, %esp
popl    %ebp
ret</pre>

<p>.ffi_closure_SYSV_end: .LFE3:</p>

<p>if !FFI_NO_RAW_API</p>

<p>define RAW_CLOSURE_CIF_OFFSET ((FFI_TRAMPOLINE_SIZE + 3) &amp; ~3) define
RAW_CLOSURE_FUN_OFFSET (RAW_CLOSURE_CIF_OFFSET + 4) define
RAW_CLOSURE_USER_DATA_OFFSET (RAW_CLOSURE_FUN_OFFSET + 4) define
CIF_FLAGS_OFFSET 20</p>

<pre># This assumes we are using gas.
.balign 16
.globl  _ffi_closure_raw_SYSV</pre>

<p>ifndef <em>OS2</em></p>

<pre class="ruby">.<span class="ruby-identifier">def</span>    <span class="ruby-identifier">_ffi_closure_raw_SYSV</span>;  .<span class="ruby-identifier">scl</span>    <span class="ruby-value">2</span>;      .<span class="ruby-identifier">type</span>   <span class="ruby-value">32</span>;     .<span class="ruby-identifier">endef</span>
</pre>

<p>endif _ffi_closure_raw_SYSV: .LFB4:</p>

<pre>pushl   %ebp</pre>

<p>.LCFI6:</p>

<pre>movl    %esp, %ebp</pre>

<p>.LCFI7:</p>

<pre>pushl   %esi</pre>

<p>.LCFI8:</p>

<pre>subl    $36, %esp
movl    RAW_CLOSURE_CIF_OFFSET(%eax), %esi       /* closure-&gt;cif */
movl    RAW_CLOSURE_USER_DATA_OFFSET(%eax), %edx /* closure-&gt;user_data */
movl    %edx, 12(%esp)  /* user_data */
leal    8(%ebp), %edx   /* __builtin_dwarf_cfa () */
movl    %edx, 8(%esp)   /* raw_args */
leal    -24(%ebp), %edx
movl    %edx, 4(%esp)   /* &amp;res */
movl    %esi, (%esp)    /* cif */
call    *RAW_CLOSURE_FUN_OFFSET(%eax)            /* closure-&gt;fun */
movl    CIF_FLAGS_OFFSET(%esi), %eax             /* rtype */</pre>

<p>0:</p>

<pre>call    1f
# Do not insert anything here between the call and the jump table.</pre>

<p>.Lrcls_store_table:</p>

<pre>.long   .Lrcls_noretval         /* FFI_TYPE_VOID */
.long   .Lrcls_retint           /* FFI_TYPE_INT */
.long   .Lrcls_retfloat         /* FFI_TYPE_FLOAT */
.long   .Lrcls_retdouble        /* FFI_TYPE_DOUBLE */
.long   .Lrcls_retldouble       /* FFI_TYPE_LONGDOUBLE */
.long   .Lrcls_retuint8         /* FFI_TYPE_UINT8 */
.long   .Lrcls_retsint8         /* FFI_TYPE_SINT8 */
.long   .Lrcls_retuint16        /* FFI_TYPE_UINT16 */
.long   .Lrcls_retsint16        /* FFI_TYPE_SINT16 */
.long   .Lrcls_retint           /* FFI_TYPE_UINT32 */
.long   .Lrcls_retint           /* FFI_TYPE_SINT32 */
.long   .Lrcls_retllong         /* FFI_TYPE_UINT64 */
.long   .Lrcls_retllong         /* FFI_TYPE_SINT64 */
.long   .Lrcls_retstruct        /* FFI_TYPE_STRUCT */
.long   .Lrcls_retint           /* FFI_TYPE_POINTER */
.long   .Lrcls_retstruct1       /* FFI_TYPE_SMALL_STRUCT_1B */
.long   .Lrcls_retstruct2       /* FFI_TYPE_SMALL_STRUCT_2B */
.long   .Lrcls_retstruct4       /* FFI_TYPE_SMALL_STRUCT_4B */</pre>

<p>1:</p>

<pre>add     %eax, %eax
add     %eax, %eax
add     (%esp),%eax
add     $4, %esp
jmp     *(%eax)

/* Sign/zero extend as appropriate.  */</pre>

<p>.Lrcls_retsint8:</p>

<pre>movsbl  -24(%ebp), %eax
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retsint16:</p>

<pre>movswl  -24(%ebp), %eax
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retuint8:</p>

<pre>movzbl  -24(%ebp), %eax
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retuint16:</p>

<pre>movzwl  -24(%ebp), %eax
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retint:</p>

<pre>movl    -24(%ebp), %eax
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retfloat:</p>

<pre>flds    -24(%ebp)
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retdouble:</p>

<pre>fldl    -24(%ebp)
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retldouble:</p>

<pre>fldt    -24(%ebp)
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retllong:</p>

<pre>movl    -24(%ebp), %eax
movl    -20(%ebp), %edx
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retstruct1:</p>

<pre>movsbl  -24(%ebp), %eax
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retstruct2:</p>

<pre>movswl  -24(%ebp), %eax
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retstruct4:</p>

<pre>movl    -24(%ebp), %eax
jmp     .Lrcls_epilogue</pre>

<p>.Lrcls_retstruct:</p>

<pre># Nothing to do!</pre>

<p>.Lrcls_noretval: .Lrcls_epilogue:</p>

<pre>addl    $36, %esp
popl    %esi
popl    %ebp
ret</pre>

<p>.ffi_closure_raw_SYSV_end: .LFE4:</p>

<p>endif /* !FFI_NO_RAW_API */</p>

<pre># This assumes we are using gas.
.balign 16
.globl  _ffi_closure_STDCALL</pre>

<p>ifndef <em>OS2</em></p>

<pre class="ruby">.<span class="ruby-identifier">def</span>    <span class="ruby-identifier">_ffi_closure_STDCALL</span>;   .<span class="ruby-identifier">scl</span>    <span class="ruby-value">2</span>;      .<span class="ruby-identifier">type</span>   <span class="ruby-value">32</span>;     .<span class="ruby-identifier">endef</span>
</pre>

<p>endif _ffi_closure_STDCALL: .LFB5:</p>

<pre>pushl   %ebp</pre>

<p>.LCFI9:</p>

<pre>movl    %esp, %ebp</pre>

<p>.LCFI10:</p>

<pre>subl    $40, %esp
leal    -24(%ebp), %edx
movl    %edx, -12(%ebp) /* resp */
leal    12(%ebp), %edx  /* account for stub return address on stack */
movl    %edx, 4(%esp)   /* args */
leal    -12(%ebp), %edx
movl    %edx, (%esp)    /* &amp;resp */
call    _ffi_closure_SYSV_inner
movl    -12(%ebp), %ecx</pre>

<p>0:</p>

<pre>call    1f
# Do not insert anything here between the call and the jump table.</pre>

<p>.Lscls_store_table:</p>

<pre>.long   .Lscls_noretval         /* FFI_TYPE_VOID */
.long   .Lscls_retint           /* FFI_TYPE_INT */
.long   .Lscls_retfloat         /* FFI_TYPE_FLOAT */
.long   .Lscls_retdouble        /* FFI_TYPE_DOUBLE */
.long   .Lscls_retldouble       /* FFI_TYPE_LONGDOUBLE */
.long   .Lscls_retuint8         /* FFI_TYPE_UINT8 */
.long   .Lscls_retsint8         /* FFI_TYPE_SINT8 */
.long   .Lscls_retuint16        /* FFI_TYPE_UINT16 */
.long   .Lscls_retsint16        /* FFI_TYPE_SINT16 */
.long   .Lscls_retint           /* FFI_TYPE_UINT32 */
.long   .Lscls_retint           /* FFI_TYPE_SINT32 */
.long   .Lscls_retllong         /* FFI_TYPE_UINT64 */
.long   .Lscls_retllong         /* FFI_TYPE_SINT64 */
.long   .Lscls_retstruct        /* FFI_TYPE_STRUCT */
.long   .Lscls_retint           /* FFI_TYPE_POINTER */
.long   .Lscls_retstruct1       /* FFI_TYPE_SMALL_STRUCT_1B */
.long   .Lscls_retstruct2       /* FFI_TYPE_SMALL_STRUCT_2B */
.long   .Lscls_retstruct4       /* FFI_TYPE_SMALL_STRUCT_4B */</pre>

<p>1:</p>

<pre>add     %eax, %eax
add     %eax, %eax
add     (%esp),%eax
add     $4, %esp
jmp     *(%eax)

/* Sign/zero extend as appropriate.  */</pre>

<p>.Lscls_retsint8:</p>

<pre>movsbl  (%ecx), %eax
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retsint16:</p>

<pre>movswl  (%ecx), %eax
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retuint8:</p>

<pre>movzbl  (%ecx), %eax
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retuint16:</p>

<pre>movzwl  (%ecx), %eax
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retint:</p>

<pre>movl    (%ecx), %eax
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retfloat:</p>

<pre>flds    (%ecx)
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retdouble:</p>

<pre>fldl    (%ecx)
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retldouble:</p>

<pre>fldt    (%ecx)
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retllong:</p>

<pre>movl    (%ecx), %eax
movl    4(%ecx), %edx
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retstruct1:</p>

<pre>movsbl  (%ecx), %eax
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retstruct2:</p>

<pre>movswl  (%ecx), %eax
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retstruct4:</p>

<pre>movl    (%ecx), %eax
jmp     .Lscls_epilogue</pre>

<p>.Lscls_retstruct:</p>

<pre># Nothing to do!</pre>

<p>.Lscls_noretval: .Lscls_epilogue:</p>

<pre>movl    %ebp, %esp
popl    %ebp
ret</pre>

<p>.ffi_closure_STDCALL_end: .LFE5:</p>

<p>ifndef <em>OS2</em></p>

<pre>.section        .eh_frame,&quot;w&quot;</pre>

<p>endif .Lframe1: .LSCIE1:</p>

<pre>.long   .LECIE1-.LASCIE1  /* Length of Common Information Entry */</pre>

<p>.LASCIE1:</p>

<pre>.long   0x0     /* CIE Identifier Tag */
.byte   0x1     /* CIE Version */</pre>

<p>ifdef __PIC__</p>

<pre>.ascii &quot;zR\0&quot;   /* CIE Augmentation */</pre>

<p>else</p>

<pre>.ascii &quot;\0&quot;     /* CIE Augmentation */</pre>

<p>endif</p>

<pre>.byte   0x1     /* .uleb128 0x1; CIE Code Alignment Factor */
.byte   0x7c    /* .sleb128 -4; CIE Data Alignment Factor */
.byte   0x8     /* CIE RA Column */</pre>

<p>ifdef __PIC__</p>

<pre>.byte   0x1     /* .uleb128 0x1; Augmentation size */
.byte   0x1b    /* FDE Encoding (pcrel sdata4) */</pre>

<p>endif</p>

<pre>.byte   0xc     /* DW_CFA_def_cfa CFA = r4 + 4 = 4(%esp) */
.byte   0x4     /* .uleb128 0x4 */
.byte   0x4     /* .uleb128 0x4 */
.byte   0x88    /* DW_CFA_offset, column 0x8 %eip at CFA + 1 * -4 */
.byte   0x1     /* .uleb128 0x1 */
.align 4</pre>

<p>.LECIE1:</p>

<p>.LSFDE1:</p>

<pre>.long   .LEFDE1-.LASFDE1        /* FDE Length */</pre>

<p>.LASFDE1:</p>

<pre>.long   .LASFDE1-.Lframe1       /* FDE CIE offset */</pre>

<p>if defined __PIC__ &amp;&amp; defined HAVE_AS_X86_PCREL</p>

<pre>.long   .LFB1-. /* FDE initial location */</pre>

<p>else</p>

<pre>.long   .LFB1</pre>

<p>endif</p>

<pre>.long   .LFE1-.LFB1     /* FDE address range */</pre>

<p>ifdef __PIC__</p>

<pre>.byte   0x0     /* .uleb128 0x0; Augmentation size */</pre>

<p>endif</p>

<pre>/* DW_CFA_xxx CFI instructions go here.  */

.byte   0x4     /* DW_CFA_advance_loc4 */
.long   .LCFI0-.LFB1
.byte   0xe     /* DW_CFA_def_cfa_offset CFA = r4 + 8 = 8(%esp) */
.byte   0x8     /* .uleb128 0x8 */
.byte   0x85    /* DW_CFA_offset, column 0x5 %ebp at CFA + 2 * -4 */
.byte   0x2     /* .uleb128 0x2 */

.byte   0x4     /* DW_CFA_advance_loc4 */
.long   .LCFI1-.LCFI0
.byte   0xd     /* DW_CFA_def_cfa_register CFA = r5 = %ebp */
.byte   0x5     /* .uleb128 0x5 */

/* End of DW_CFA_xxx CFI instructions.  */
.align 4</pre>

<p>.LEFDE1:</p>

<p>.LSFDE3:</p>

<pre>.long   .LEFDE3-.LASFDE3        /* FDE Length */</pre>

<p>.LASFDE3:</p>

<pre>.long   .LASFDE3-.Lframe1       /* FDE CIE offset */</pre>

<p>if defined __PIC__ &amp;&amp; defined HAVE_AS_X86_PCREL</p>

<pre>.long   .LFB3-. /* FDE initial location */</pre>

<p>else</p>

<pre>.long   .LFB3</pre>

<p>endif</p>

<pre>.long   .LFE3-.LFB3     /* FDE address range */</pre>

<p>ifdef __PIC__</p>

<pre>.byte   0x0     /* .uleb128 0x0; Augmentation size */</pre>

<p>endif</p>

<pre>/* DW_CFA_xxx CFI instructions go here.  */

.byte   0x4     /* DW_CFA_advance_loc4 */
.long   .LCFI4-.LFB3
.byte   0xe     /* DW_CFA_def_cfa_offset CFA = r4 + 8 = 8(%esp) */
.byte   0x8     /* .uleb128 0x8 */
.byte   0x85    /* DW_CFA_offset, column 0x5 %ebp at CFA + 2 * -4 */
.byte   0x2     /* .uleb128 0x2 */

.byte   0x4     /* DW_CFA_advance_loc4 */
.long   .LCFI5-.LCFI4
.byte   0xd     /* DW_CFA_def_cfa_register CFA = r5 = %ebp */
.byte   0x5     /* .uleb128 0x5 */

/* End of DW_CFA_xxx CFI instructions.  */
.align 4</pre>

<p>.LEFDE3:</p>

<p>if !FFI_NO_RAW_API</p>

<p>.LSFDE4:</p>

<pre>.long   .LEFDE4-.LASFDE4        /* FDE Length */</pre>

<p>.LASFDE4:</p>

<pre>.long   .LASFDE4-.Lframe1       /* FDE CIE offset */</pre>

<p>if defined __PIC__ &amp;&amp; defined HAVE_AS_X86_PCREL</p>

<pre>.long   .LFB4-. /* FDE initial location */</pre>

<p>else</p>

<pre>.long   .LFB4</pre>

<p>endif</p>

<pre>.long   .LFE4-.LFB4     /* FDE address range */</pre>

<p>ifdef __PIC__</p>

<pre>.byte   0x0     /* .uleb128 0x0; Augmentation size */</pre>

<p>endif</p>

<pre>/* DW_CFA_xxx CFI instructions go here.  */

.byte   0x4     /* DW_CFA_advance_loc4 */
.long   .LCFI6-.LFB4
.byte   0xe     /* DW_CFA_def_cfa_offset CFA = r4 + 8 = 8(%esp) */
.byte   0x8     /* .uleb128 0x8 */
.byte   0x85    /* DW_CFA_offset, column 0x5 %ebp at CFA + 2 * -4 */
.byte   0x2     /* .uleb128 0x2 */

.byte   0x4     /* DW_CFA_advance_loc4 */
.long   .LCFI7-.LCFI6
.byte   0xd     /* DW_CFA_def_cfa_register CFA = r5 = %ebp */
.byte   0x5     /* .uleb128 0x5 */

.byte   0x4     /* DW_CFA_advance_loc4 */
.long   .LCFI8-.LCFI7
.byte   0x86    /* DW_CFA_offset, column 0x6 %esi at CFA + 3 * -4 */
.byte   0x3     /* .uleb128 0x3 */

/* End of DW_CFA_xxx CFI instructions.  */
.align 4</pre>

<p>.LEFDE4:</p>

<p>endif /* !FFI_NO_RAW_API */</p>

<p>.LSFDE5:</p>

<pre>.long   .LEFDE5-.LASFDE5        /* FDE Length */</pre>

<p>.LASFDE5:</p>

<pre>.long   .LASFDE5-.Lframe1       /* FDE CIE offset */</pre>

<p>if defined __PIC__ &amp;&amp; defined HAVE_AS_X86_PCREL</p>

<pre>.long   .LFB5-. /* FDE initial location */</pre>

<p>else</p>

<pre>.long   .LFB5</pre>

<p>endif</p>

<pre>.long   .LFE5-.LFB5     /* FDE address range */</pre>

<p>ifdef __PIC__</p>

<pre>.byte   0x0     /* .uleb128 0x0; Augmentation size */</pre>

<p>endif</p>

<pre>/* DW_CFA_xxx CFI instructions go here.  */

.byte   0x4     /* DW_CFA_advance_loc4 */
.long   .LCFI9-.LFB5
.byte   0xe     /* DW_CFA_def_cfa_offset CFA = r4 + 8 = 8(%esp) */
.byte   0x8     /* .uleb128 0x8 */
.byte   0x85    /* DW_CFA_offset, column 0x5 %ebp at CFA + 2 * -4 */
.byte   0x2     /* .uleb128 0x2 */

.byte   0x4     /* DW_CFA_advance_loc4 */
.long   .LCFI10-.LCFI9
.byte   0xd     /* DW_CFA_def_cfa_register CFA = r5 = %ebp */
.byte   0x5     /* .uleb128 0x5 */

/* End of DW_CFA_xxx CFI instructions.  */
.align 4</pre>

<p>.LEFDE5:</p>

<p>endif /* !_MSC_VER */</p>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

