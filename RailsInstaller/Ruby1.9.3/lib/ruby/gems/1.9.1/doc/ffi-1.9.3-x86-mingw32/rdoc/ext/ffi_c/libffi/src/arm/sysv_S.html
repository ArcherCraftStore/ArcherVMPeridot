<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>sysv.S - ffi-1.9.3-x86-mingw32 Documentation</title>

<link href="../../../../../fonts.css" rel="stylesheet">
<link href="../../../../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../../../";
</script>

<script src="../../../../../js/jquery.js"></script>
<script src="../../../../../js/navigation.js"></script>
<script src="../../../../../js/search_index.js"></script>
<script src="../../../../../js/search.js"></script>
<script src="../../../../../js/searcher.js"></script>
<script src="../../../../../js/darkfish.js"></script>


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog.html">ChangeLog</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog_libffi.html">ChangeLog.libffi</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog_libgcj.html">ChangeLog.libgcj</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ChangeLog_v1.html">ChangeLog.v1</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/LICENSE.html">LICENSE</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_vc.html">Makefile.vc</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/Makefile_vc64.html">Makefile.vc64</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/README.html">README</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/acinclude_m4.html">acinclude.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/build-ios_sh.html">build-ios.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/compile.html">compile</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/config_guess.html">config.guess</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/config_sub.html">config.sub</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/configure.html">configure</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/configure_ac.html">configure.ac</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/configure_host.html">configure.host</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/depcomp.html">depcomp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/doc/libffi_info.html">libffi.info</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/doc/stamp-vti.html">stamp-vti</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/doc/version_texi.html">version.texi</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/fficonfig_h_in.html">fficonfig.h.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/include/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/include/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/install-sh.html">install-sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/libffi_pc_in.html">libffi.pc.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/libtool-version.html">libtool-version</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/ltmain_sh.html">ltmain.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_cc_maxopt_m4.html">ax_cc_maxopt.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_cflags_warn_all_m4.html">ax_cflags_warn_all.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_check_compiler_flags_m4.html">ax_check_compiler_flags.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_compiler_vendor_m4.html">ax_compiler_vendor.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_configure_args_m4.html">ax_configure_args.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_enable_builddir_m4.html">ax_enable_builddir.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_gcc_archflag_m4.html">ax_gcc_archflag.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/m4/ax_gcc_x86_cpuid_m4.html">ax_gcc_x86_cpuid.m4</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/ffi_3.html">ffi.3</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/ffi_call_3.html">ffi_call.3</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/man/ffi_prep_cif_3.html">ffi_prep_cif.3</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/mdate-sh.html">mdate-sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/missing.html">missing</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/msvcc_sh.html">msvcc.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/alpha/osf_S.html">osf.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/arm/gentramp_sh.html">gentramp.sh</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/arm/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/arm/trampoline_S.html">trampoline.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/avr32/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/cris/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/frv/eabi_S.html">eabi.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/ia64/unix_S.html">unix.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/m32r/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/m68k/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/mips/n32_S.html">n32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/mips/o32_S.html">o32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/moxie/eabi_S.html">eabi.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/pa/hpux32_S.html">hpux32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/pa/linux_S.html">linux.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/aix_S.html">aix.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/aix_closure_S.html">aix_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/darwin_S.html">darwin.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/darwin_closure_S.html">darwin_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/linux64_S.html">linux64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/linux64_closure_S.html">linux64_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/ppc_closure_S.html">ppc_closure.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/powerpc/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/s390/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sh/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sh64/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sparc/v8_S.html">v8.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/sparc/v9_S.html">v9.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/darwin_S.html">darwin.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/darwin64_S.html">darwin64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/freebsd_S.html">freebsd.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/sysv_S.html">sysv.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/unix64_S.html">unix64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/win32_S.html">win32.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/src/x86/win64_S.html">win64.S</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/Makefile_am.html">Makefile.am</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/Makefile_in.html">Makefile.in</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/config/default_exp.html">default.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/libffi-dg_exp.html">libffi-dg.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/libffi_exp.html">libffi.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/target-libpath_exp.html">target-libpath.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/wrapper_exp.html">wrapper.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/libffi_call/call_exp.html">call.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/testsuite/libffi_special/special_exp.html">special.exp</a>
  
    <li><a href="../../../../../ext/ffi_c/libffi/texinfo_tex.html">texinfo.tex</a>
  
    <li><a href="../../../../../lib/ffi/platform/arm-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-cygwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-freebsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-gnu/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-netbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-openbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/i386-windows/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/ia64-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/mips-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/mipsel-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/powerpc-aix/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/powerpc-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/powerpc-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/s390-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/s390x-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/sparc-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/sparc-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/sparcv9-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-cygwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-darwin/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-freebsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-linux/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-netbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-openbsd/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-solaris/types_conf.html">types.conf</a>
  
    <li><a href="../../../../../lib/ffi/platform/x86_64-windows/types_conf.html">types.conf</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page ext/ffi_c/libffi/src/arm/sysv.S">

<pre>-----------------------------------------------------------------------
sysv.S - Copyright (c) 1998, 2008, 2011 Red Hat, Inc.
         Copyright (c) 2011 Plausible Labs Cooperative, Inc.

ARM Foreign Function Interface 

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
``Software''), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED ``AS IS'', WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT.  IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
DEALINGS IN THE SOFTWARE.
-----------------------------------------------------------------------</pre>

<p>define LIBFFI_ASM</p>

<p>include &lt;fficonfig.h&gt; include &lt;ffi.h&gt; ifdef HAVE_MACHINE_ASM_H
include &lt;machine/asm.h&gt; else ifdef <em>USER_LABEL_PREFIX</em> define
CONCAT1(a, b) CONCAT2(a, b) define CONCAT2(a, b) a ## b</p>

<pre>Use the right prefix for global labels.</pre>

<p>define CNAME(x) CONCAT1 (<em>USER_LABEL_PREFIX</em>, x) else define
CNAME(x) x endif ifdef __APPLE__ define ENTRY(x) .globl CNAME(x); CNAME(x):
else define ENTRY(x) .globl CNAME(x); .type CNAME(x),%function; CNAME(x):
endif /* __APPLE__ */ endif</p>

<p>ifdef __ELF__ define LSYM(x) .x else define LSYM(x) x endif</p>

<p>/* Use the SOFTFP return value ABI on Mac OS X, as per the iOS ABI</p>

<pre>Function Call Guide */</pre>

<p>ifdef __APPLE__ define __SOFTFP__ endif</p>

<p>/* We need a better way of testing for this, but for now, this is all</p>

<pre>we can do.  */</pre>

<p>@ This selects the minimum architecture level required. define
<em>ARM_ARCH</em> 3</p>

<p>if defined(<em>ARM_ARCH_4</em>) || defined(<em>ARM_ARCH_4T</em>) # undef
<em>ARM_ARCH</em> # define <em>ARM_ARCH</em> 4 endif</p>

<p>if defined(<em>ARM_ARCH_5</em>) || defined(<em>ARM_ARCH_5T</em>) \</p>

<pre>|| defined(__ARM_ARCH_5E__) || defined(__ARM_ARCH_5TE__) \
|| defined(__ARM_ARCH_5TEJ__)</pre>

<p># undef <em>ARM_ARCH</em> # define <em>ARM_ARCH</em> 5 endif</p>

<p>if defined(<em>ARM_ARCH_6</em>) || defined(<em>ARM_ARCH_6J</em>) \</p>

<pre>|| defined(__ARM_ARCH_6K__) || defined(__ARM_ARCH_6Z__) \
|| defined(__ARM_ARCH_6ZK__) || defined(__ARM_ARCH_6T2__) \
|| defined(__ARM_ARCH_6M__)</pre>

<p># undef <em>ARM_ARCH</em> # define <em>ARM_ARCH</em> 6 endif</p>

<p>if defined(<em>ARM_ARCH_7</em>) || defined(<em>ARM_ARCH_7A</em>) \</p>

<pre>|| defined(__ARM_ARCH_7R__) || defined(__ARM_ARCH_7M__) \
|| defined(__ARM_ARCH_7EM__)</pre>

<p># undef <em>ARM_ARCH</em> # define <em>ARM_ARCH</em> 7 endif</p>

<p>if <em>ARM_ARCH</em> &gt;= 5 # define call_reg(x)    blx     x elif defined
(<em>ARM_ARCH_4T</em>) # define call_reg(x)    mov     lr, pc ; bx     x #
if defined(__thumb__) || defined(<em>THUMB_INTERWORK</em>) #  define
__INTERWORKING__ # endif else # define call_reg(x)    mov     lr, pc ; mov 
pc, x endif</p>

<p>/* Conditionally compile unwinder directives.  */ ifdef <em>ARM_EABI</em>
define UNWIND else define UNWIND @ endif</p>

<p>if defined(__thumb__) &amp;&amp; !defined(<em>THUMB_INTERWORK</em>) .macro 
ARM_FUNC_START name</p>

<pre>.text
.align 0
.thumb
.thumb_func</pre>

<p>ifdef __APPLE__</p>

<pre>ENTRY($0)</pre>

<p>else</p>

<pre>ENTRY(\name)</pre>

<p>endif</p>

<pre>bx      pc
nop
.arm
UNWIND .fnstart</pre>

<p>/* A hook to tell gdb that we’ve switched to ARM mode.  Also used to call</p>

<pre>directly from other local arm routines.  */</pre>

<p>ifdef __APPLE__ <em>L_</em>$0: else <em>L_</em>name: endif .endm else
.macro  ARM_FUNC_START name</p>

<pre>.text
.align 0
.arm</pre>

<p>ifdef __APPLE__</p>

<pre>ENTRY($0)</pre>

<p>else</p>

<pre>ENTRY(\name)</pre>

<p>endif</p>

<pre>UNWIND .fnstart</pre>

<p>.endm endif</p>

<p>.macro  RETLDM  regs=, cond=, dirn=ia if defined (__INTERWORKING__)</p>

<pre>.ifc &quot;\regs&quot;,&quot;&quot;
ldr\cond        lr, [sp], #4
.else
ldm\cond\dirn   sp!, {\regs, lr}
.endif
bx\cond lr</pre>

<p>else</p>

<pre>.ifc &quot;\regs&quot;,&quot;&quot;
ldr\cond        pc, [sp], #4
.else
ldm\cond\dirn   sp!, {\regs, pc}
.endif</pre>

<p>endif .endm</p>

<pre>@ r0:   ffi_prep_args
@ r1:   &amp;ecif
@ r2:   cif-&gt;bytes
@ r3:   fig-&gt;flags
@ sp+0: ecif.rvalue

@ This assumes we are using gas.</pre>

<p>ARM_FUNC_START ffi_call_SYSV</p>

<pre>@ Save registers
stmfd   sp!, {r0-r3, fp, lr}
UNWIND .save    {r0-r3, fp, lr}
mov     fp, sp

UNWIND .setfp   fp, sp

@ Make room for all of the new args.
sub     sp, fp, r2

@ Place all of the ffi_prep_args in position
mov     r0, sp
@     r1 already set

@ Call ffi_prep_args(stack, &amp;ecif)
bl      ffi_prep_args

@ move first 4 parameters in registers
ldmia   sp, {r0-r3}

@ and adjust stack
sub     lr, fp, sp      @ cif-&gt;bytes == fp - sp
ldr     ip, [fp]        @ load fn() in advance
cmp     lr, #16
movhs   lr, #16
add     sp, sp, lr

@ call (fn) (...)
call_reg(ip)

@ Remove the space we pushed for the args
mov     sp, fp

@ Load r2 with the pointer to storage for the return value
ldr     r2, [sp, #24]

@ Load r3 with the return type code 
ldr     r3, [sp, #12]

@ If the return value pointer is NULL, assume no return value.
cmp     r2, #0
beq     LSYM(Lepilogue)</pre>

<p>@ return INT</p>

<pre>cmp     r3, #FFI_TYPE_INT</pre>

<p>if defined(__SOFTFP__) || defined(<em>ARM_EABI</em>)</p>

<pre>cmpne   r3, #FFI_TYPE_FLOAT</pre>

<p>endif</p>

<pre>streq   r0, [r2]
beq     LSYM(Lepilogue)

@ return INT64
cmp     r3, #FFI_TYPE_SINT64</pre>

<p>if defined(__SOFTFP__) || defined(<em>ARM_EABI</em>)</p>

<pre>cmpne   r3, #FFI_TYPE_DOUBLE</pre>

<p>endif</p>

<pre>stmeqia r2, {r0, r1}</pre>

<p>if !defined(__SOFTFP__) &amp;&amp; !defined(<em>ARM_EABI</em>)</p>

<pre>beq     LSYM(Lepilogue)</pre>

<p>@ return FLOAT</p>

<pre>cmp     r3, #FFI_TYPE_FLOAT
stfeqs  f0, [r2]
beq     LSYM(Lepilogue)</pre>

<p>@ return DOUBLE or LONGDOUBLE</p>

<pre>cmp     r3, #FFI_TYPE_DOUBLE
stfeqd  f0, [r2]</pre>

<p>endif</p>

<p>LSYM(Lepilogue): if defined (__INTERWORKING__)</p>

<pre>ldmia   sp!, {r0-r3,fp, lr}
bx      lr</pre>

<p>else</p>

<pre>ldmia   sp!, {r0-r3,fp, pc}</pre>

<p>endif</p>

<p>.ffi_call_SYSV_end:</p>

<pre>UNWIND .fnend</pre>

<p>ifdef __ELF__</p>

<pre>.size    CNAME(ffi_call_SYSV),.ffi_call_SYSV_end-CNAME(ffi_call_SYSV)</pre>

<p>endif</p>

<p>/*</p>

<pre>       unsigned int FFI_HIDDEN
       ffi_closure_SYSV_inner (closure, respp, args)
            ffi_closure *closure;
            void **respp;
            void *args;
/</pre>

<p>ARM_FUNC_START ffi_closure_SYSV</p>

<pre>UNWIND .pad #16
add     ip, sp, #16
stmfd   sp!, {ip, lr}
UNWIND .save    {r0, lr}
add     r2, sp, #8
UNWIND .pad #16
sub     sp, sp, #16
str     sp, [sp, #8]
add     r1, sp, #8
bl      CNAME(ffi_closure_SYSV_inner)
cmp     r0, #FFI_TYPE_INT
beq     .Lretint

cmp     r0, #FFI_TYPE_FLOAT</pre>

<p>if defined(__SOFTFP__) || defined(<em>ARM_EABI</em>)</p>

<pre>beq     .Lretint</pre>

<p>else</p>

<pre>beq     .Lretfloat</pre>

<p>endif</p>

<pre>cmp     r0, #FFI_TYPE_DOUBLE</pre>

<p>if defined(__SOFTFP__) || defined(<em>ARM_EABI</em>)</p>

<pre>beq     .Lretlonglong</pre>

<p>else</p>

<pre>beq     .Lretdouble</pre>

<p>endif</p>

<pre>cmp     r0, #FFI_TYPE_LONGDOUBLE</pre>

<p>if defined(__SOFTFP__) || defined(<em>ARM_EABI</em>)</p>

<pre>beq     .Lretlonglong</pre>

<p>else</p>

<pre>beq     .Lretlongdouble</pre>

<p>endif</p>

<pre>cmp     r0, #FFI_TYPE_SINT64
beq     .Lretlonglong</pre>

<p>.Lclosure_epilogue:</p>

<pre>add     sp, sp, #16
ldmfd   sp, {sp, pc}</pre>

<p>.Lretint:</p>

<pre>ldr     r0, [sp]
b       .Lclosure_epilogue</pre>

<p>.Lretlonglong:</p>

<pre>ldr     r0, [sp]
ldr     r1, [sp, #4]
b       .Lclosure_epilogue</pre>

<p>if !defined(__SOFTFP__) &amp;&amp; !defined(<em>ARM_EABI</em>) .Lretfloat:</p>

<pre>ldfs    f0, [sp]
b       .Lclosure_epilogue</pre>

<p>.Lretdouble:</p>

<pre>ldfd    f0, [sp]
b       .Lclosure_epilogue</pre>

<p>.Lretlongdouble:</p>

<pre>ldfd    f0, [sp]
b       .Lclosure_epilogue</pre>

<p>endif</p>

<p>.ffi_closure_SYSV_end:</p>

<pre>UNWIND .fnend</pre>

<p>ifdef __ELF__</p>

<pre>.size    CNAME(ffi_closure_SYSV),.ffi_closure_SYSV_end-CNAME(ffi_closure_SYSV)</pre>

<p>endif</p>

<p>/* Below are VFP hard-float ABI call and closure implementations.</p>

<pre>Add VFP FPU directive here. */
     .fpu    vfp

     @ r0:   fn
     @ r1:   &amp;ecif
     @ r2:   cif-&gt;bytes
     @ r3:   fig-&gt;flags
     @ sp+0: ecif.rvalue</pre>

<p>ARM_FUNC_START ffi_call_VFP</p>

<pre>@ Save registers
stmfd   sp!, {r0-r3, fp, lr}
UNWIND .save    {r0-r3, fp, lr}
mov     fp, sp
UNWIND .setfp   fp, sp

@ Make room for all of the new args.
sub     sp, sp, r2

@ Make room for loading VFP args
sub     sp, sp, #64

@ Place all of the ffi_prep_args in position
mov     r0, sp
@     r1 already set
sub     r2, fp, #64   @ VFP scratch space

@ Call ffi_prep_args(stack, &amp;ecif, vfp_space)
bl      ffi_prep_args

@ Load VFP register args if needed
cmp     r0, #0
beq     LSYM(Lbase_args)

@ Load only d0 if possible
cmp     r0, #3
sub     ip, fp, #64
flddle  d0, [ip]
fldmiadgt       ip, {d0-d7}</pre>

<p>LSYM(Lbase_args):</p>

<pre>@ move first 4 parameters in registers
ldmia   sp, {r0-r3}

@ and adjust stack
sub     lr, ip, sp      @ cif-&gt;bytes == (fp - 64) - sp
ldr     ip, [fp]        @ load fn() in advance
cmp     lr, #16
movhs   lr, #16
add     sp, sp, lr

@ call (fn) (...)
call_reg(ip)

@ Remove the space we pushed for the args
mov     sp, fp

@ Load r2 with the pointer to storage for
@ the return value
ldr     r2, [sp, #24]

@ Load r3 with the return type code 
ldr     r3, [sp, #12]

@ If the return value pointer is NULL,
@ assume no return value.
cmp     r2, #0
beq     LSYM(Lepilogue_vfp)

cmp     r3, #FFI_TYPE_INT
streq   r0, [r2]
beq     LSYM(Lepilogue_vfp)

cmp     r3, #FFI_TYPE_SINT64
stmeqia r2, {r0, r1}
beq     LSYM(Lepilogue_vfp)

cmp     r3, #FFI_TYPE_FLOAT
fstseq  s0, [r2]
beq     LSYM(Lepilogue_vfp)

cmp     r3, #FFI_TYPE_DOUBLE
fstdeq  d0, [r2]
beq     LSYM(Lepilogue_vfp)

cmp     r3, #FFI_TYPE_STRUCT_VFP_FLOAT
cmpne   r3, #FFI_TYPE_STRUCT_VFP_DOUBLE
fstmiadeq       r2, {d0-d3}</pre>

<p>LSYM(Lepilogue_vfp):</p>

<pre>RETLDM  &quot;r0-r3,fp&quot;</pre>

<p>.ffi_call_VFP_end:</p>

<pre>UNWIND .fnend
.size    CNAME(ffi_call_VFP),.ffi_call_VFP_end-CNAME(ffi_call_VFP)</pre>

<p>ARM_FUNC_START ffi_closure_VFP</p>

<pre>fstmfdd sp!, {d0-d7}
@ r0-r3, then d0-d7
UNWIND .pad #80
add     ip, sp, #80
stmfd   sp!, {ip, lr}
UNWIND .save    {r0, lr}
add     r2, sp, #72
add     r3, sp, #8
UNWIND .pad #72
sub     sp, sp, #72
str     sp, [sp, #64]
add     r1, sp, #64
bl      ffi_closure_SYSV_inner

cmp     r0, #FFI_TYPE_INT
beq     .Lretint_vfp

cmp     r0, #FFI_TYPE_FLOAT
beq     .Lretfloat_vfp

cmp     r0, #FFI_TYPE_DOUBLE
cmpne   r0, #FFI_TYPE_LONGDOUBLE
beq     .Lretdouble_vfp

cmp     r0, #FFI_TYPE_SINT64
beq     .Lretlonglong_vfp

cmp     r0, #FFI_TYPE_STRUCT_VFP_FLOAT
beq     .Lretfloat_struct_vfp

cmp     r0, #FFI_TYPE_STRUCT_VFP_DOUBLE
beq     .Lretdouble_struct_vfp</pre>

<p>.Lclosure_epilogue_vfp:</p>

<pre>add     sp, sp, #72
ldmfd   sp, {sp, pc}</pre>

<p>.Lretfloat_vfp:</p>

<pre>flds    s0, [sp]
b       .Lclosure_epilogue_vfp</pre>

<p>.Lretdouble_vfp:</p>

<pre>fldd    d0, [sp]
b       .Lclosure_epilogue_vfp</pre>

<p>.Lretint_vfp:</p>

<pre>ldr     r0, [sp]
b       .Lclosure_epilogue_vfp</pre>

<p>.Lretlonglong_vfp:</p>

<pre>ldmia   sp, {r0, r1}
b       .Lclosure_epilogue_vfp</pre>

<p>.Lretfloat_struct_vfp:</p>

<pre>fldmiad sp, {d0-d1}
b       .Lclosure_epilogue_vfp</pre>

<p>.Lretdouble_struct_vfp:</p>

<pre>fldmiad sp, {d0-d3}
b       .Lclosure_epilogue_vfp</pre>

<p>.ffi_closure_VFP_end:</p>

<pre>UNWIND .fnend
.size    CNAME(ffi_closure_VFP),.ffi_closure_VFP_end-CNAME(ffi_closure_VFP)</pre>

<p>if defined __ELF__ &amp;&amp; defined __linux__</p>

<pre>.section        .note.GNU-stack,&quot;&quot;,%progbits</pre>

<p>endif</p>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

